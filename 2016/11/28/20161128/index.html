<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>学习阿里开源项目BeeHive(二) · Ghcoder</title><meta name="description" content="学习阿里开源项目BeeHive(二) - Ghcoder"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/gandalfr.css"><link rel="stylesheet" href="https://highlightjs.org/static/demo/styles/solarized-light.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Ghcoder"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="https://avatars1.githubusercontent.com/u/3142935?v=3&amp;s=466 or file" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">学习阿里开源项目BeeHive(二)</h1><div class="tags"><a href="/tags/学习/" class="tag-title">#学习</a></div><div class="post-info">Nov 28, 2016</div><div class="post-content"><h3 id="紧接着前面那篇文章，回到BHAppDelegate-m的文件里面的"><a href="#紧接着前面那篇文章，回到BHAppDelegate-m的文件里面的" class="headerlink" title="紧接着前面那篇文章，回到BHAppDelegate.m的文件里面的"></a>紧接着前面那篇文章，回到<code>BHAppDelegate.m</code>的文件里面的</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">- <span class="params">(BOOL)</span>application:<span class="params">(UIApplication *)</span>application didFinishLaunchingWithOptions:<span class="params">(NSDictionary *)</span>launchOptions</div></pre></td></tr></table></figure>
<p>之前已经把所有的timeProdiler的这个类的作用，实例，已经public的方法都已经说了。在这个方法的实现中，作者还做了另外一件事情。</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[[<span class="keyword">BHModuleManager </span><span class="keyword">sharedManager] </span>tiggerEvent:<span class="keyword">BHMSetupEvent];</span></div><div class="line">[[<span class="keyword">BHModuleManager </span><span class="keyword">sharedManager] </span>tiggerEvent:<span class="keyword">BHMInitEvent];</span></div><div class="line"></div><div class="line"><span class="keyword">dispatch_async(dispatch_get_main_queue(), </span>^&#123;</div><div class="line">    [[<span class="keyword">BHModuleManager </span><span class="keyword">sharedManager] </span>tiggerEvent:<span class="keyword">BHMSplashEvent];</span></div><div class="line">&#125;)<span class="comment">;</span></div></pre></td></tr></table></figure>
<ol>
<li><code>BHModuleManager</code>从字面上理解应该就是管理模块之前调用逻辑的意思，并且在<code>BHModuleManager.m</code>中，我们可以看出来这个类也是个单例。</li>
<li>在init之后，紧接着就是调用<code>- (void)tiggerEvent:(BHModuleEventType)eventType;</code>的方法。</li>
<li>在这个方法的实现中可以看到一个很长的swich语句，遍历你传入的一个枚举类型，来做一系列的事情。</li>
<li>先看在<code>didFinishLaunch</code>中，第一次调用这个方法，传入的参数为<code>BHMSetupEvent</code>。</li>
</ol>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">case</span> <span class="string">BHMSetupEvent:</span></div><div class="line">[self <span class="string">handleModuleEvent:</span>kSetupSelector];</div><div class="line"><span class="keyword">break</span>;</div></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)handleModuleEvent:(<span class="built_in">NSString</span> *)selectorStr</div><div class="line">&#123;</div><div class="line">    SEL seletor = <span class="built_in">NSSelectorFromString</span>(selectorStr);</div><div class="line">    [<span class="keyword">self</span>.BHModules enumerateObjectsUsingBlock:^(<span class="keyword">id</span>&lt;BHModuleProtocol&gt; moduleInstance, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> * _Nonnull stop) &#123;</div><div class="line">        <span class="keyword">if</span> ([moduleInstance respondsToSelector:seletor]) &#123;</div><div class="line"><span class="meta">#pragma clang diagnostic push</span></div><div class="line"><span class="meta">#pragma clang diagnostic ignored <span class="meta-string">"-Warc-performSelector-leaks"</span></span></div><div class="line">            [moduleInstance performSelector:seletor withObject:<span class="keyword">self</span>.wholeContext];</div><div class="line"><span class="meta">#pragma clang diagnostic pop</span></div><div class="line"></div><div class="line">        [[BHTimeProfiler sharedTimeProfiler] recordEventTime:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@ --- %@"</span>, [moduleInstance <span class="keyword">class</span>], <span class="built_in">NSStringFromSelector</span>(seletor)]];</div><div class="line"></div><div class="line">        &#125;</div><div class="line">    &#125;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>可以看到传入了一个字符串作为入参，而这个参数写在这个文件的.m中。<code>static  NSString *kSetupSelector = @&quot;modSetUp:&quot;;</code>写死了。</li>
<li>紧接着在<code>handleModuleEvent</code>的实现中，通过runtime的NSSelectorFromString的方法将字符串转化为SEL的类型。</li>
<li>再枚举BHModules数组，从枚举中我们发现，不是所有的object对象都添加在BHModules的MutableArray中，这些object的对象必须要遵守<code>id&lt;BHModuleProtocol&gt;</code>的协议。</li>
<li>查询数组中有没有对象可以响应这个方法的，如果有的话，就调用这个方法，并且开始reordTime。</li>
<li>并且为了消除编译器所报的警告，可以通过添加<code>#pragma clang diagnostic ignored &quot;-Warc-performSelector-leaks&quot;</code>,来消除warning。</li>
</ol>
<h4 id="紧接着调用了同一个方法，却传入了不同的参数"><a href="#紧接着调用了同一个方法，却传入了不同的参数" class="headerlink" title="紧接着调用了同一个方法，却传入了不同的参数"></a>紧接着调用了同一个方法，却传入了不同的参数</h4><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[[BHModuleManager sharedManager] <span class="string">tiggerEvent:</span>BHMInitEvent];</div><div class="line"></div><div class="line"></div><div class="line"> <span class="keyword">case</span> <span class="string">BHMInitEvent:</span></div><div class="line"> <span class="comment">//special</span></div><div class="line"> [self handleModulesInitEvent];</div><div class="line"> <span class="keyword">break</span>;</div></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)handleModulesInitEvent</div><div class="line">&#123;</div><div class="line"></div><div class="line">    [<span class="keyword">self</span>.BHModules enumerateObjectsUsingBlock:^(<span class="keyword">id</span>&lt;BHModuleProtocol&gt; moduleInstance, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> * _Nonnull stop) &#123;</div><div class="line">        __<span class="keyword">weak</span> <span class="keyword">typeof</span>(&amp;*<span class="keyword">self</span>) wself = <span class="keyword">self</span>;</div><div class="line">        <span class="keyword">void</span> ( ^ bk )();</div><div class="line">        bk = ^()&#123;</div><div class="line">            __<span class="keyword">strong</span> <span class="keyword">typeof</span>(&amp;*<span class="keyword">self</span>) sself = wself;</div><div class="line">            <span class="keyword">if</span> (sself) &#123;</div><div class="line">                <span class="keyword">if</span> ([moduleInstance respondsToSelector:<span class="keyword">@selector</span>(modInit:)]) &#123;</div><div class="line">                    [moduleInstance modInit:sself.wholeContext];</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line"></div><div class="line">        [[BHTimeProfiler sharedTimeProfiler] recordEventTime:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@ --- modInit:"</span>, [moduleInstance <span class="keyword">class</span>]]];</div><div class="line"></div><div class="line">        <span class="keyword">if</span> ([moduleInstance respondsToSelector:<span class="keyword">@selector</span>(async)]) &#123;</div><div class="line">            <span class="built_in">BOOL</span> async = [moduleInstance async];</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (async) &#123;</div><div class="line">                <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</div><div class="line">                    bk();</div><div class="line">                &#125;);</div><div class="line"></div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                bk();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            bk();</div><div class="line">        &#125;</div><div class="line">    &#125;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>首先循环遍历<code>self.BHModules</code>这个数组对象，先用Timer 开始记录下init方法的时间。</li>
<li>判断数组中的元素是否响应<code>async</code>的方法, 这个<code>- (BOOL)async;</code>的方法定义在<code>BHModuleProtocol</code>中，如果响应了这个方法，就取得这个方法的返回值,<code>从字面上判断这个变量记录了是否运行在多线程中，这里我只是个猜测</code>。</li>
<li>如果是在多线程中，就回到主线程中来执行上面所定义的block：<code>void ( ^ bk )();</code>，如果不是的话或者没有响应<code>async</code>,都直接运行这个block，应该默认状态下就是主线程了。</li>
<li>从代码上看来，就是不管在什么线程或者是否响应<code>async</code>的方法，上面的block是肯定要执行的。</li>
<li>block中所做的事情也很简单，就是判断这个元素对象是否响应<code>- (void)modInit:(BHContext *)context;</code>,这个protocol的代理方法，如果响应的话，就会执行这段代码，至于这里的<code>BHContext</code>的对象，我目前没看到在哪里传入进来，这里只看到了一个<code>Setter</code>的方法。</li>
</ol>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">- (void)setWholeContext:(<span class="keyword">BHContext </span>*)wholeContext</div><div class="line">&#123;</div><div class="line">    _wholeContext = wholeContext<span class="comment">;</span></div><div class="line">    self.modulesConfigFilename = _wholeContext.moduleConfigName<span class="comment">;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="最后执行的一个方法"><a href="#最后执行的一个方法" class="headerlink" title="最后执行的一个方法"></a>最后执行的一个方法</h4><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">dispatch_async(dispatch_get_main_queue(), </span>^&#123;</div><div class="line">       [[<span class="keyword">BHModuleManager </span><span class="keyword">sharedManager] </span>tiggerEvent:<span class="keyword">BHMSplashEvent];</span></div><div class="line">   &#125;)<span class="comment">;</span></div></pre></td></tr></table></figure>
<ol>
<li>这个方法和<code>[self handleModuleEvent:kSetupSelector];</code>一样，除了传入的参数不同，响应的方法不同，其他都是一样。</li>
<li>这里还要强制要求这个方法的调用一定要在主线程中。</li>
</ol>
<h3 id="这样就已经把自定义的BHAppDelegate的主要几个实现已经介绍了一下，下面来看看demo中的实现。在TestAppDelegate的didFinishLaunchingWithOptions的方法中。"><a href="#这样就已经把自定义的BHAppDelegate的主要几个实现已经介绍了一下，下面来看看demo中的实现。在TestAppDelegate的didFinishLaunchingWithOptions的方法中。" class="headerlink" title="这样就已经把自定义的BHAppDelegate的主要几个实现已经介绍了一下，下面来看看demo中的实现。在TestAppDelegate的didFinishLaunchingWithOptions的方法中。"></a>这样就已经把自定义的<code>BHAppDelegate</code>的主要几个实现已经介绍了一下，下面来看看demo中的实现。在<code>TestAppDelegate</code>的<code>didFinishLaunchingWithOptions</code>的方法中。</h3><h4 id="这四行代码涉及到了同一个对象BHContext-从字面上判断应该是上下文对象，应该是对象之间的调用会需要用它来记录一下，这里是我的猜测"><a href="#这四行代码涉及到了同一个对象BHContext-从字面上判断应该是上下文对象，应该是对象之间的调用会需要用它来记录一下，这里是我的猜测" class="headerlink" title="这四行代码涉及到了同一个对象BHContext,从字面上判断应该是上下文对象，应该是对象之间的调用会需要用它来记录一下，这里是我的猜测"></a>这四行代码涉及到了同一个对象<code>BHContext</code>,从字面上判断应该是<code>上下文对象，应该是对象之间的调用会需要用它来记录一下，这里是我的猜测</code></h4><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[<span class="keyword">BHContext </span><span class="keyword">shareInstance].application </span>= application<span class="comment">;</span></div><div class="line">[<span class="keyword">BHContext </span><span class="keyword">shareInstance].launchOptions </span>= launchOptions<span class="comment">;</span></div><div class="line">[<span class="keyword">BHContext </span><span class="keyword">shareInstance].moduleConfigName </span>= @<span class="string">"BeeHive.bundle/BeeHive"</span><span class="comment">;//可选，默认为BeeHive.bundle/BeeHive.plist</span></div><div class="line">[<span class="keyword">BHContext </span><span class="keyword">shareInstance].serviceConfigName </span>= @<span class="string">"BeeHive.bundle/BHService"</span><span class="comment">;</span></div></pre></td></tr></table></figure>
<h4 id="在BHContext-m的代码中可以看出来，这个对象也是个单例，在这个单例的init方法中："><a href="#在BHContext-m的代码中可以看出来，这个对象也是个单例，在这个单例的init方法中：" class="headerlink" title="在BHContext.m的代码中可以看出来，这个对象也是个单例，在这个单例的init方法中："></a>在<code>BHContext.m</code>的代码中可以看出来，这个对象也是个单例，在这个单例的init方法中：</h4><figure class="highlight monkey"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">-(instancetype)init</div><div class="line">&#123;</div><div class="line">    <span class="built_in">self</span> = [<span class="built_in">super</span> init];</div><div class="line">    <span class="keyword">if</span> (<span class="built_in">self</span>) &#123;</div><div class="line">        <span class="built_in">self</span>.modulesByName  = [[NSMutableDictionary alloc] initWithCapacity:<span class="number">1</span>];</div><div class="line">        <span class="built_in">self</span>.servicesByName  = [[NSMutableDictionary alloc] initWithCapacity:<span class="number">1</span>];</div><div class="line">        <span class="built_in">self</span>.moduleConfigName = @<span class="string">"BeeHive.bundle/BeeHive"</span>;</div><div class="line">        <span class="built_in">self</span>.serviceConfigName = @<span class="string">"BeeHive.bundle/BHService"</span>;<span class="meta"></span></div><div class="line"></div><div class="line">#<span class="meta-keyword">if</span> __IPHONE_OS_VERSION_MAX_ALLOWED &gt; 80400</div><div class="line">        <span class="built_in">self</span>.touchShortcutItem = [BHShortcutItem <span class="keyword">new</span>];<span class="meta"></span></div><div class="line">#<span class="meta-keyword">endif</span></div><div class="line"></div><div class="line">        <span class="built_in">self</span>.openURLItem = [BHOpenURLItem <span class="keyword">new</span>];</div><div class="line">        <span class="built_in">self</span>.notificationsItem = [BHNotificationsItem <span class="keyword">new</span>];</div><div class="line">        <span class="built_in">self</span>.userActivityItem = [BHUserActivityItem <span class="keyword">new</span>];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="built_in">self</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>定义了<code>modulesByName</code>、<code>servicesByName</code>为<code>NSMutableDictionary</code>的对象，只能容纳一个元素。</li>
<li>定义了<code>moduleConfigName</code>、<code>serviceConfigName</code>为String的对象。</li>
<li>在系统大于8.0.4的时候，支持3D touch的话，会额外设置一个对象，这个对象里面就两个对象，一个是<code>UIApplicationShortcutItem *shortcutItem;</code>, 一个是<code>typedef void (^shortcutItemCompletionHandler)(BOOL);</code>,都是在调用3D touch的时候会调用到。</li>
<li>涉及到了另一个对象<code>BHOpenURLItem</code>,这个对象含有三个变量<code>NSURL *openURL;</code>,<code>NSString *sourceApplication;</code>,<code>NSDictionary *options;</code>。</li>
<li>设计了通知的一个对象<code>BHNotificationsItem</code>,这个对象含有五个变量：<code>NSError *notificationsError;</code>,<code>NSData *deviceToken;</code>,<code>NSDictionary *userInfo;</code>,<code>typedef void (^notificationResultHandler)(UIBackgroundFetchResult);</code>,<code>UILocalNotification *localNotification;</code>。</li>
<li>还有一个涉及到用户信息的一个对象：<code>BHUserActivityItem</code>,含有四个变量：<code>NSString *userActivityType;</code>,<code>NSUserActivity *userActivity;</code>,<code>NSError *userActivityError;</code>, <code>typedef void (^restorationHandler)(NSArray *);</code>。</li>
<li>总体看来这个对象完成的功能很多，并且以后很多类似3D touch 这种针对某种系统的新功能都可以在这个类中来拓展，而且很方便使用。</li>
</ol>
<h4 id="在本类的shareInstance的方法中："><a href="#在本类的shareInstance的方法中：" class="headerlink" title="在本类的shareInstance的方法中："></a>在本类的<code>shareInstance</code>的方法中：</h4><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">dispatch_once(&amp;p, </span>^&#123;</div><div class="line">        <span class="keyword">BHInstance </span>= [[[self class] alloc] init]<span class="comment">;</span></div><div class="line">        if ([<span class="keyword">BHInstance </span>isKindOfClass:[<span class="keyword">BHContext </span>class]]) &#123;</div><div class="line">            ((<span class="keyword">BHContext </span>*) <span class="keyword">BHInstance).config </span>= [<span class="keyword">BHConfig </span><span class="keyword">shareInstance];</span></div><div class="line">        &#125;</div><div class="line">    &#125;)<span class="comment">;</span></div></pre></td></tr></table></figure>
<ol>
<li>这里在设置<code>config</code>的变量之前判断<code>if ([BHInstance isKindOfClass:[BHContext class]]) {}</code>这个说实话，我没太明白这么做的原因是什么，上面都已经<code>BHInstance = [[[self class] alloc] init];</code>调用了，那这个判断还有什么意思吗？并且这个对象是继承的<code>NSObject</code>的对象。</li>
<li>这里的<code>BHConfig</code>对象，从代码上看也是一个单例，并且定义了一系列存储，判断是否存在，在.m的文件中定义了一个<code>NSMutableDictionary *config;</code>的对象，统一存储在这个里面，可以是对象类型，也可以是一些基础的数据类型。</li>
</ol>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[<span class="keyword">BHContext </span><span class="keyword">shareInstance].application </span>= application<span class="comment">;</span></div><div class="line">[<span class="keyword">BHContext </span><span class="keyword">shareInstance].launchOptions </span>= launchOptions<span class="comment">;</span></div><div class="line">[<span class="keyword">BHContext </span><span class="keyword">shareInstance].moduleConfigName </span>= @<span class="string">"BeeHive.bundle/BeeHive"</span><span class="comment">;//可选，默认为BeeHive.bundle/BeeHive.plist</span></div><div class="line">[<span class="keyword">BHContext </span><span class="keyword">shareInstance].serviceConfigName </span>= @<span class="string">"BeeHive.bundle/BHService"</span><span class="comment">;</span></div></pre></td></tr></table></figure>
<ol>
<li>现在可以看出来，首先这4行代码就是简单的赋值的动作，有些类的值你可以不赋值，类似的有：<code>moduleConfigName</code>,<code>serviceConfigName</code>,因为在对象实例化的时候，就已经进行了赋值。</li>
</ol>
<h4 id="紧接着在下面的两行代码中涉及到了一个新的对象："><a href="#紧接着在下面的两行代码中涉及到了一个新的对象：" class="headerlink" title="紧接着在下面的两行代码中涉及到了一个新的对象："></a>紧接着在下面的两行代码中涉及到了一个新的对象：</h4><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[<span class="keyword">BeeHive </span><span class="keyword">shareInstance].enableExpection </span>= YES<span class="comment">;</span></div><div class="line">[[<span class="keyword">BeeHive </span><span class="keyword">shareInstance] </span>setContext:[<span class="keyword">BHContext </span><span class="keyword">shareInstance]];</span></div></pre></td></tr></table></figure>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#pragma mark - Private</span></div><div class="line"></div><div class="line">-(void)setContext:(<span class="keyword">BHContext </span>*)<span class="built_in">context</span></div><div class="line">&#123;</div><div class="line">    _<span class="built_in">context</span> = <span class="built_in">context</span><span class="comment">;</span></div><div class="line"></div><div class="line">    static <span class="keyword">dispatch_once_t </span>onceToken<span class="comment">;</span></div><div class="line">    <span class="keyword">dispatch_once(&amp;onceToken, </span>^&#123;</div><div class="line">        [self loadStaticServices]<span class="comment">;</span></div><div class="line">        [self loadStaticModules]<span class="comment">;</span></div><div class="line">    &#125;)<span class="comment">;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>首先在<code>BeeHive.m</code>的文件中，可以看出来，这个对象也是个单例。</li>
<li>紧接着在public的属性中，设置了全局了<code>BHContext</code>的对象，并且将它保存下来，并且在这里复写了<code>Setter</code>的方法,并且在<code>Setter</code>方法的时候,又调用了两个新的方法，并且这两个方法有且仅调用一次。</li>
</ol>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">-(void)loadStaticServices</div><div class="line">&#123;</div><div class="line">    [<span class="keyword">BHServiceManager </span><span class="keyword">sharedManager].enableException </span>= self.enableExpection<span class="comment">;</span></div><div class="line"></div><div class="line">    [[<span class="keyword">BHServiceManager </span><span class="keyword">sharedManager] </span>setWholeContext:self.context]<span class="comment">;</span></div><div class="line"></div><div class="line">    [[<span class="keyword">BHServiceManager </span><span class="keyword">sharedManager] </span>registerLocalServices]<span class="comment">;</span></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>在<code>loadStaticServices</code>的方法中，又创建了一个<code>BHServiceManager</code>的单例对象。</li>
<li>在<code>BHServiceManager</code>中设计了<code>enableException</code>的属性。</li>
<li>在<code>BHServiceManager</code>中设置了<code>BHContext</code>的对象，将<code>BHContext</code>对象也能够在<code>BHServiceManager</code>中能够持有这个对象。</li>
<li>最后调用到了<code>loadStaticServices</code>中的<code>registerLocalServices</code>的方法。方法如下：</li>
</ol>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)registerLocalServices</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSString</span> *serviceConfigName = <span class="keyword">self</span>.wholeContext.serviceConfigName;</div><div class="line"></div><div class="line">    <span class="built_in">NSString</span> *plistPath = [[<span class="built_in">NSBundle</span> mainBundle] pathForResource:serviceConfigName  ofType:<span class="string">@"plist"</span>];</div><div class="line">    <span class="keyword">if</span> (!plistPath) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="built_in">NSArray</span> *serviceList = [[<span class="built_in">NSArray</span> alloc] initWithContentsOfFile:plistPath];</div><div class="line"></div><div class="line">    [<span class="keyword">self</span>.lock lock];</div><div class="line">    [<span class="keyword">self</span>.allServices addObjectsFromArray:serviceList];</div><div class="line">    [<span class="keyword">self</span>.lock unlock];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>通过传入的<code>context</code>找到<code>serviceConfigName</code>的变量，拼接成plist文件名，如果项目中确实存在的话，就打开这个文件的内容。</li>
<li>这里通过锁，来将plist文件中取到的变量NSArray，存储到<code>allServices</code>私有变量中去。</li>
</ol>
<h4 id="另一个方法："><a href="#另一个方法：" class="headerlink" title="另一个方法："></a>另一个方法：</h4><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">- (void)loadStaticModules</div><div class="line">&#123;</div><div class="line">    [[<span class="keyword">BHModuleManager </span><span class="keyword">sharedManager] </span>setWholeContext:self.context]<span class="comment">;</span></div><div class="line"></div><div class="line">    [[<span class="keyword">BHModuleManager </span><span class="keyword">sharedManager] </span>loadLocalModules]<span class="comment">;</span></div><div class="line"></div><div class="line">    [[<span class="keyword">BHModuleManager </span><span class="keyword">sharedManager] </span>registedAllModules]<span class="comment">;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>上面已经分析过了，这个<code>BHModuleManager</code>也是一个单例。首先将全局的<code>context</code>的变量设置上去，并且将<code>context中的moduleConfigName</code>的变量赋值给<code>modulesConfigFilename</code>。</li>
<li>将刚才的变量<code>modulesConfigFilename</code>拼接成<code>plist</code>文件，然后将取得的数据放入到数组中。</li>
<li>在<code>registedAllModules</code>的方法中，听过比较字典中的<code>moduleLevel</code>的value值，进行比较、排序，然后通过枚举，挨个实例化对象之后，在存入<code>BHModules</code>的可变数组中。</li>
</ol>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">id&lt;HomeServiceProtocol&gt; homeVc = [[<span class="keyword">BeeHive </span><span class="keyword">shareInstance] </span>createService:@protocol(HomeServiceProtocol)]<span class="comment">;</span></div></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">id</span>)createService:(Protocol *)service</div><div class="line">&#123;</div><div class="line">    <span class="keyword">id</span> implInstance = <span class="literal">nil</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (![<span class="keyword">self</span> checkValidService:service] &amp;&amp; <span class="keyword">self</span>.enableException) &#123;</div><div class="line">        <span class="keyword">@throw</span> [<span class="built_in">NSException</span> exceptionWithName:<span class="built_in">NSInternalInconsistencyException</span> reason:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@ protocol does not been registed"</span>, <span class="built_in">NSStringFromProtocol</span>(service)] userInfo:<span class="literal">nil</span>];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Class implClass = [<span class="keyword">self</span> serviceImplClass:service];</div><div class="line"></div><div class="line">    implInstance = [[implClass alloc] init];</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (![implInstance respondsToSelector:<span class="keyword">@selector</span>(singleton)]) &#123;</div><div class="line">        <span class="keyword">return</span> implInstance;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="built_in">NSString</span> *serviceStr = <span class="built_in">NSStringFromProtocol</span>(service);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ([implInstance singleton]) &#123;</div><div class="line">        <span class="keyword">id</span> protocol = [[BHContext shareInstance].servicesByName objectForKey:serviceStr];</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (protocol) &#123;</div><div class="line">            <span class="keyword">return</span> protocol;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            [[BHContext shareInstance].servicesByName setObject:implInstance forKey:serviceStr];</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        [[BHContext shareInstance].servicesByName setObject:implInstance forKey:serviceStr];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> implInstance;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>紧接着调用了<code>BeeHive</code>的public的方法：<code>- (id)createService:(Protocol *)proto;</code>传入一个protocol，返回一个id类型的对象。</li>
<li>其实这里<code>self checkValidService:service</code>值是判断之前<code>registerLocalServices</code>这个里面有没有遵循这个protocol的，假如没有，并且开启<code>self.enableException</code>的话，他就会抛出一个<code>NSException</code>。</li>
<li>否则就会遵循这个protocol的类，并且返回。</li>
<li>判断这个类有没有遵循<code>BHServiceProtocol</code>这个协议的<code>singleton</code>,并且实现，假如没有实现的话，就直接返回这个对象，不再往下执行了。</li>
<li>根据这个protocol在<code>[BHContext shareInstance].servicesByName</code>字典中查找有没有对应value值，如果有的话，就直接放回这个对象，如果没有的话，放回对象的同时，将这个protocol存储到这个<code>[BHContext shareInstance].servicesByName</code>字典中。</li>
<li>最后讲个homeVC设置为Appdelegate的RootWindow。</li>
</ol>
</div></article></div></main><footer><div class="paginator"><a href="/2016/12/01/20161201/" class="prev">上一篇</a><a href="/2016/11/25/20161125/" class="next">下一篇</a></div><div class="copyright"><p>© undefined - 2017 <a href="http://yoursite.com">Ghcoder</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/MikeCoder/hexo-theme-gandalfr" target="_blank">hexo-theme-gandalfr</a>.</p></div></footer></div><script src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js" crossorigin="anonymous"></script><script src="//cdn.bootcss.com/jquery/3.1.1/jquery.js" crossorigin="anonymous"></script><script>$(document).ready(function() { $('pre').each(function(i, block) { hljs.highlightBlock(block); }); });</script></body></html>