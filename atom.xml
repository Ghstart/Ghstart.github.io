<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Ghcoder</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.ghcoder.com/"/>
  <updated>2019-01-09T03:42:45.758Z</updated>
  <id>http://www.ghcoder.com/</id>
  
  <author>
    <name>Ghcoder</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>关于R.Obj工具</title>
    <link href="http://www.ghcoder.com/2019/01/09/20190109/"/>
    <id>http://www.ghcoder.com/2019/01/09/20190109/</id>
    <published>2019-01-09T11:28:12.000Z</published>
    <updated>2019-01-09T03:42:45.758Z</updated>
    
    <content type="html"><![CDATA[<h3 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h3><ul><li>想通过R.Obj这个工具在编译的时候，去管理图片、字符串、主题的资源文件？？</li><li>可能会存在多个静态库、或者动态库？？</li><li>以及后期如何自定义？？</li></ul><h3 id="R-obj-问题："><a href="#R-obj-问题：" class="headerlink" title="R.obj 问题："></a>R.obj 问题：</h3><ul><li>如果图片不放在Assest中的话，会有问题：例如存在图片 <a href="mailto:`Test@2x.png" target="_blank" rel="noopener">`Test@2x.png</a><code>、</code><a href="mailto:Test@3x.png" target="_blank" rel="noopener">Test@3x.png</a><code>, 最后编译成的模板会存在两张图片名称</code>Test2x<code>、</code>Test3x`，如果统一将图片统一放入到Assest中，就不会有这个问题。❌</li><li>如果图片不放在Assest中的话，它形成的模板的代码如下, 自动会带上图片的后缀，但是放入到Asstet中则正常。❌</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">UIImage</span>*)wifiConnectingShowBg &#123; <span class="keyword">return</span> [<span class="built_in">UIImage</span> imageNamed:<span class="string">@"Wifi_connecting_show_bg.png"</span>]; &#125;</span><br></pre></td></tr></table></figure><pre><code>⁃    * 如果主项目中存在`R.obj`,那么存在于主目录中的任意多个`Bundle`，其中图片可能存在重复多个，但是生成的`R.obj`的模板文件是唯一的。但是本质上没有去重。❌  (这里可以通过编写脚本删除，在else的时候执行删除脚本)。</code></pre><ul><li>直接替换掉图片，可以同步。✔️ （每次编译的时候，都会每次生成一次模板）</li></ul><h3 id="静态库和R-obj-配合使用的问题："><a href="#静态库和R-obj-配合使用的问题：" class="headerlink" title="静态库和R.obj 配合使用的问题："></a>静态库和R.obj 配合使用的问题：</h3><h4 id="情况一："><a href="#情况一：" class="headerlink" title="情况一："></a>情况一：</h4><blockquote><ol><li>创建了一套<code>.framework</code>、<code>.a</code>的静态库。</li><li>创建了一套<code>.bundle</code>的资源文件。（<strong>静态库没有直接调用bundle里面的资源</strong>）</li><li>经过<code>R.obj</code>编译过后。</li></ol></blockquote><h4 id="结果："><a href="#结果：" class="headerlink" title="结果："></a>结果：</h4><ul><li><ol><li>外部可以直接调用静态库中的代码 ✔️</li></ol></li><li><ol start="2"><li>图片资源的名称，目前没法制定<code>Bundle</code>的前缀名称 ❌</li></ol></li></ul><h4 id="情况二："><a href="#情况二：" class="headerlink" title="情况二："></a>情况二：</h4><blockquote><ol><li>创建了一套<code>.framework</code>、<code>.a</code>的静态库, 直接通过<code>代码</code>的方式获取外部公用<code>bundle</code>的资源。</li><li>经过<code>R.obj</code>编译过后。代码如下：</li></ol></blockquote><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">icon.<span class="built_in">image</span> = [UIImage imageNamed:@<span class="string">"外部bundle/通过R.obj生成的图片"</span>];</span><br></pre></td></tr></table></figure><h4 id="结果：-1"><a href="#结果：-1" class="headerlink" title="结果："></a>结果：</h4><ol><li>首先自动生成的R.obj会冲突，无不发编译。❌</li><li>在静态库中通过调用<code>R.obj</code>编译后的模板代码，是可以显示正常，并且外部可以通过静态库调起视图。✔️</li></ol><h4 id="情况三："><a href="#情况三：" class="headerlink" title="情况三："></a>情况三：</h4><blockquote><ol><li>创建了一套<code>.framework</code>、<code>.a</code>的静态库。</li><li>多套<code>bundle</code>资源。（这里可能会重复）</li><li>经过<code>R.obj</code>编译过后。</li></ol></blockquote><h4 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h4><ul><li>如果主项目中存在<code>R.obj</code>,那么存在于主目录中的任意多个<code>Bundle</code>，其中图片可能存在重复多个，但是生成的<code>R.obj</code>的模板文件是唯一的。但是本质上没有去重。❌  (这里可以通过编写脚本删除，在else的时候执行删除脚本)</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;目的&quot;&gt;&lt;a href=&quot;#目的&quot; class=&quot;headerlink&quot; title=&quot;目的&quot;&gt;&lt;/a&gt;目的&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;想通过R.Obj这个工具在编译的时候，去管理图片、字符串、主题的资源文件？？&lt;/li&gt;
&lt;li&gt;可能会存在多个静态库、或者动态库
      
    
    </summary>
    
      <category term="日志" scheme="http://www.ghcoder.com/categories/%E6%97%A5%E5%BF%97/"/>
    
    
      <category term="Object-C" scheme="http://www.ghcoder.com/tags/Object-C/"/>
    
  </entry>
  
  <entry>
    <title>收银台开发-工厂模式-设计模式(3)</title>
    <link href="http://www.ghcoder.com/2018/12/16/20181216/"/>
    <id>http://www.ghcoder.com/2018/12/16/20181216/</id>
    <published>2018-12-16T11:28:12.000Z</published>
    <updated>2018-12-17T04:54:27.422Z</updated>
    
    <content type="html"><![CDATA[<h3 id="在开发这个收银台项目的时候，其实用到很多设计模式，但是运用最最广泛的，我想除了单例模式，就要数今天要说的工厂模式："><a href="#在开发这个收银台项目的时候，其实用到很多设计模式，但是运用最最广泛的，我想除了单例模式，就要数今天要说的工厂模式：" class="headerlink" title="在开发这个收银台项目的时候，其实用到很多设计模式，但是运用最最广泛的，我想除了单例模式，就要数今天要说的工厂模式："></a>在开发这个收银台项目的时候，其实用到很多设计模式，但是运用最最广泛的，我想除了单例模式，就要数今天要说的工厂模式：</h3><h4 id="问题：我们在选择支付方式的时候，通常会显示一个支付列表，里面包含了银行卡支付、微信支付、支付宝支付、可能还会有其他自己的支付，但是这个支付的数据模型会有很大的差异，但是共性就是可以支付，这里如何抽象呢？"><a href="#问题：我们在选择支付方式的时候，通常会显示一个支付列表，里面包含了银行卡支付、微信支付、支付宝支付、可能还会有其他自己的支付，但是这个支付的数据模型会有很大的差异，但是共性就是可以支付，这里如何抽象呢？" class="headerlink" title="问题：我们在选择支付方式的时候，通常会显示一个支付列表，里面包含了银行卡支付、微信支付、支付宝支付、可能还会有其他自己的支付，但是这个支付的数据模型会有很大的差异，但是共性就是可以支付，这里如何抽象呢？"></a>问题：我们在选择支付方式的时候，通常会显示一个支付列表，里面包含了银行卡支付、微信支付、支付宝支付、可能还会有其他自己的支付，但是这个支付的数据模型会有很大的差异，但是共性就是可以支付，这里如何抽象呢？</h4><h4 id="解答：我们这是使用工厂方式来解决这个问题："><a href="#解答：我们这是使用工厂方式来解决这个问题：" class="headerlink" title="解答：我们这是使用工厂方式来解决这个问题："></a>解答：我们这是使用工厂方式来解决这个问题：</h4><a id="more"></a><h4 id="工厂模式设计中的角色有哪些："><a href="#工厂模式设计中的角色有哪些：" class="headerlink" title="工厂模式设计中的角色有哪些："></a>工厂模式设计中的角色有哪些：</h4><ol><li>抽象工厂(协议、接口)。</li><li>具体工厂(遵循了上面接口的具体工厂)。</li><li>抽象产品(工厂生产产品的协议、接口)。</li><li>具体产品(遵循了上面接口的具体产品)。</li></ol><h4 id="Demo展示，这里以两种支付方式（1-AliPay-2-WeChatPay）"><a href="#Demo展示，这里以两种支付方式（1-AliPay-2-WeChatPay）" class="headerlink" title="Demo展示，这里以两种支付方式（1. AliPay  2. WeChatPay）"></a>Demo展示，这里以两种支付方式（1. AliPay  2. WeChatPay）</h4><ul><li>抽象的支付”工厂”(说白了，就是产生支付的一个类)，这里我们定义为<code>PayProtocol</code>代码如下：</li></ul><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@protocol</span> PayProtocol <span class="variable">&lt;NSObject&gt;</span></span><br><span class="line"></span><br><span class="line">- (id<span class="variable">&lt;PayItemProtocol&gt;</span>)getPayItem;</span><br><span class="line"></span><br><span class="line"><span class="meta">@end</span></span><br></pre></td></tr></table></figure><ul><li>上面这个工厂只会生产一种<code>东西</code>, 这种东西有一个特性，叫<code>PayItemProtocol</code>,说白了就是我们根据这种支付方式，产生的<code>Dictionary</code>的数据结构，最后可以提交到后台去，代码如下：</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">PayItemProtocol</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSDictionary</span> *)createPayRequestDatas;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><ul><li>下面看一下具体类实现：</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*--AliPay的具体工厂类AliPayManager*/</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AliPayManager</span> : <span class="title">NSObject</span>&lt;<span class="title">PayProtocol</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">"AliPay.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">AliPayManager</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>&lt;PayItemProtocol&gt;)getPayItem &#123; <span class="keyword">return</span> [[AliPay alloc] init]; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*--AliPayItem的具体实现类--*/</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AliPay</span> : <span class="title">NSObject</span>&lt;<span class="title">PayItemProtocol</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">AliPay</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSDictionary</span> *)createPayRequestDatas &#123;</span><br><span class="line">    <span class="keyword">return</span> @&#123;<span class="string">@"uid"</span>: <span class="string">@"aid_111"</span>&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*-----------------下面是WeChatPay----------------------*/</span></span><br><span class="line"><span class="comment">/*--WeChatPayManager--*/</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">WeChatPayManager</span> : <span class="title">NSObject</span>&lt;<span class="title">PayProtocol</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">"WeChatPay.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">WeChatPayManager</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>&lt;PayItemProtocol&gt;)getPayItem &#123; <span class="keyword">return</span> [[WeChatPay alloc] init]; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*--WeChatPay--*/</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">WeChatPay</span> : <span class="title">NSObject</span>&lt;<span class="title">PayItemProtocol</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">WeChatPay</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSDictionary</span> *)createPayRequestDatas &#123;</span><br><span class="line">    <span class="keyword">return</span> @&#123;<span class="string">@"uid"</span>: <span class="string">@"we_222"</span>&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><ul><li>具体使用, 需要改变的只有一个地方，这里就能看出来工厂类的优势了：</li></ul><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*--AliPay的使用方式--*/</span></span><br><span class="line">id&lt;<span class="symbol">PayProtocol</span>&gt;manager = [[<span class="symbol">AliPayManager</span> alloc] init];</span><br><span class="line">id&lt;<span class="symbol">PayItemProtocol</span>&gt;payItem = [manager getPayItem];</span><br><span class="line"><span class="symbol">NSLog</span>(@<span class="string">"%@"</span>, [payItem createPayRequestDatas]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*--WeChatPay的使用方式--*/</span></span><br><span class="line">id&lt;<span class="symbol">PayProtocol</span>&gt;manager = [[<span class="symbol">WeChatPayManager</span> alloc] init];</span><br><span class="line">id&lt;<span class="symbol">PayItemProtocol</span>&gt;payItem = [manager getPayItem];</span><br><span class="line"><span class="symbol">NSLog</span>(@<span class="string">"%@"</span>, [payItem createPayRequestDatas]);</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;在开发这个收银台项目的时候，其实用到很多设计模式，但是运用最最广泛的，我想除了单例模式，就要数今天要说的工厂模式：&quot;&gt;&lt;a href=&quot;#在开发这个收银台项目的时候，其实用到很多设计模式，但是运用最最广泛的，我想除了单例模式，就要数今天要说的工厂模式：&quot; class=&quot;headerlink&quot; title=&quot;在开发这个收银台项目的时候，其实用到很多设计模式，但是运用最最广泛的，我想除了单例模式，就要数今天要说的工厂模式：&quot;&gt;&lt;/a&gt;在开发这个收银台项目的时候，其实用到很多设计模式，但是运用最最广泛的，我想除了单例模式，就要数今天要说的工厂模式：&lt;/h3&gt;&lt;h4 id=&quot;问题：我们在选择支付方式的时候，通常会显示一个支付列表，里面包含了银行卡支付、微信支付、支付宝支付、可能还会有其他自己的支付，但是这个支付的数据模型会有很大的差异，但是共性就是可以支付，这里如何抽象呢？&quot;&gt;&lt;a href=&quot;#问题：我们在选择支付方式的时候，通常会显示一个支付列表，里面包含了银行卡支付、微信支付、支付宝支付、可能还会有其他自己的支付，但是这个支付的数据模型会有很大的差异，但是共性就是可以支付，这里如何抽象呢？&quot; class=&quot;headerlink&quot; title=&quot;问题：我们在选择支付方式的时候，通常会显示一个支付列表，里面包含了银行卡支付、微信支付、支付宝支付、可能还会有其他自己的支付，但是这个支付的数据模型会有很大的差异，但是共性就是可以支付，这里如何抽象呢？&quot;&gt;&lt;/a&gt;问题：我们在选择支付方式的时候，通常会显示一个支付列表，里面包含了银行卡支付、微信支付、支付宝支付、可能还会有其他自己的支付，但是这个支付的数据模型会有很大的差异，但是共性就是可以支付，这里如何抽象呢？&lt;/h4&gt;&lt;h4 id=&quot;解答：我们这是使用工厂方式来解决这个问题：&quot;&gt;&lt;a href=&quot;#解答：我们这是使用工厂方式来解决这个问题：&quot; class=&quot;headerlink&quot; title=&quot;解答：我们这是使用工厂方式来解决这个问题：&quot;&gt;&lt;/a&gt;解答：我们这是使用工厂方式来解决这个问题：&lt;/h4&gt;
    
    </summary>
    
      <category term="日志" scheme="http://www.ghcoder.com/categories/%E6%97%A5%E5%BF%97/"/>
    
    
      <category term="Object-C、设计模式" scheme="http://www.ghcoder.com/tags/Object-C%E3%80%81%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>收银台开发-迭代器模式-设计模式(2)</title>
    <link href="http://www.ghcoder.com/2018/12/14/20181214/"/>
    <id>http://www.ghcoder.com/2018/12/14/20181214/</id>
    <published>2018-12-14T09:48:12.000Z</published>
    <updated>2018-12-14T07:41:28.381Z</updated>
    
    <content type="html"><![CDATA[<h3 id="问题：-收银台其中一个复杂点：对接的后台数据，会有很多种请求数据结构，你都需要将这些不同的数据组装在一起，方便展示，例如："><a href="#问题：-收银台其中一个复杂点：对接的后台数据，会有很多种请求数据结构，你都需要将这些不同的数据组装在一起，方便展示，例如：" class="headerlink" title="问题： 收银台其中一个复杂点：对接的后台数据，会有很多种请求数据结构，你都需要将这些不同的数据组装在一起，方便展示，例如："></a>问题： 收银台其中一个复杂点：对接的后台数据，会有很多种请求数据结构，你都需要将这些不同的数据组装在一起，方便展示，例如：</h3><ul><li>例如可用支付方式的展示（展示各个可用银行卡储蓄卡、信用卡、积分等等）</li><li>例如订单明细的展示（展示各个可用银行卡储蓄卡、信用卡、积分等等不同渠道来源数据）</li></ul><a id="more"></a><h3 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h3><ul><li>这里就需要用到迭代器的设计模式</li></ul><h3 id="角色"><a href="#角色" class="headerlink" title="角色"></a>角色</h3><ul><li>迭代器接口 (方法：<code>func hasNext() -&gt; Bool</code>、 <code>func next() -&gt; BaseModelProtocol?</code>)</li><li>遵循迭代器接口的实体类(<code>DefaultIteratorConcrete</code>-&gt; 父类，其他的子类可以通过继承的方式来实现)</li><li>容器接口 <code>ContainerProtocol</code></li><li>遵循容器接口的实体类 <code>AliPayContainer</code>、<code>WeChatContainer</code></li></ul><h3 id="举个栗子"><a href="#举个栗子" class="headerlink" title="举个栗子"></a>举个栗子</h3><ul><li>数据模型层接口的设计<code>BaseModelProtocol</code>:</li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*-----模型层接口的定义------*/</span></span><br><span class="line">protocol BaseModelProtocol &#123;</span><br><span class="line">    <span class="keyword">var</span> uid: String &#123; <span class="keyword">set</span> <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*------模型层的两个实体类AliPayModel、WeChatModel----------*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AliPayModel</span>: <span class="type">NSObject</span>, <span class="type">BaseModelProtocol &#123;</span></span></span><br><span class="line">    <span class="keyword">var</span> uid: String</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(aliPayID: String) &#123;</span><br><span class="line">        self.uid = aliPayID</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WeChatModel</span>: <span class="type">NSObject</span>, <span class="type">BaseModelProtocol &#123;</span></span></span><br><span class="line">    <span class="keyword">var</span> uid: String</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(weChatID: String) &#123;</span><br><span class="line">        self.uid = weChatID</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>迭代器接口的定义：</li></ul><blockquote><p>这里DefaultIteratorConcrete，可以通过Protocol Extension的功能，对协议IteratorProtocol实现默认的，但是这里为了在Java等其他平台都能运用同一套架构模式，所以选用了基类的实现方式。</p></blockquote><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*----迭代器接口的定义-------*/</span></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">IteratorProtocol</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">hasNext</span><span class="params">()</span></span> -&gt; <span class="type">Bool</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">next</span><span class="params">()</span></span> -&gt; <span class="type">BaseModelProtocol</span>?</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*------遵循迭代器接口的基类实现-------*/</span></span><br><span class="line"><span class="comment">/*--------这里定义了一个泛型---------*/</span></span><br><span class="line"><span class="comment">/*--注意：这里可以通过Protcol Extension, 而不需要使用继承的方式去实现，这样的话就不要这个DefaultIteratorConcrete类了--*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DefaultIteratorConcrete</span>&lt;<span class="title">T</span>&gt;: <span class="title">IteratorProtocol</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> obj: <span class="type">T</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(obj: <span class="type">T</span>) &#123; <span class="keyword">self</span>.obj = obj &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">hasNext</span><span class="params">()</span></span> -&gt; <span class="type">Bool</span> &#123; <span class="keyword">return</span> <span class="literal">false</span> &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">next</span><span class="params">()</span></span> -&gt; <span class="type">BaseModelProtocol</span>? &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*--AliPay的迭代器，这里的数据结构统一放入到数组中去实现，具体的实现通过覆写子类的方式--*/</span></span><br><span class="line"><span class="comment">/*--如果用了上面Protocol Extension的方式去实现，就不需要覆写的方式去实现了--*/</span></span><br><span class="line"><span class="comment">/*--注意：因为上面基类里面我需要用到的是一个集合的数据类型，因为用到了泛型，这里我就用到了嵌套的泛型数据集合--*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AliPayIterator</span>: <span class="title">DefaultIteratorConcrete</span>&lt;<span class="title">Array</span>&lt;<span class="title">AliPayModel</span>&gt;&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> datas: <span class="type">Array</span>&lt;<span class="type">AliPayModel</span>&gt; = <span class="type">Array</span>&lt;<span class="type">AliPayModel</span>&gt;()</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> index = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">init</span>(obj: <span class="type">Array</span>&lt;<span class="type">AliPayModel</span>&gt;) &#123;</span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>(obj: obj)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">next</span><span class="params">()</span></span> -&gt; <span class="type">BaseModelProtocol</span>? &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.hasNext() &#123;</span><br><span class="line">            <span class="keyword">let</span> result = <span class="keyword">self</span>.obj[<span class="keyword">self</span>.index]</span><br><span class="line">            index += <span class="number">1</span></span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">hasNext</span><span class="params">()</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.index != <span class="keyword">self</span>.obj.<span class="built_in">count</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*--WeChat的迭代器和上面的基本一致，唯一的区别这里使用的是Set的数据结构--*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WeChatItrator</span>: <span class="title">DefaultIteratorConcrete</span>&lt;<span class="title">Set</span>&lt;<span class="title">WeChatModel</span>&gt;&gt; </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> datas: <span class="type">Set</span>&lt;<span class="type">WeChatModel</span>&gt; = <span class="type">Set</span>&lt;<span class="type">WeChatModel</span>&gt;()</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> iterator: <span class="type">SetIterator</span>&lt;<span class="type">WeChatModel</span>&gt;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> index: <span class="type">Int</span> = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">init</span>(obj: <span class="type">Set</span>&lt;<span class="type">WeChatModel</span>&gt;) &#123;</span><br><span class="line">        <span class="keyword">self</span>.iterator = obj.makeIterator()</span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>(obj: obj)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">next</span><span class="params">()</span></span> -&gt; <span class="type">BaseModelProtocol</span>? &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.hasNext() &#123;</span><br><span class="line">            <span class="keyword">let</span> result = <span class="keyword">self</span>.iterator.next()</span><br><span class="line">            index += <span class="number">1</span></span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">hasNext</span><span class="params">()</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> index != <span class="keyword">self</span>.obj.<span class="built_in">count</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>容器接口的定义：</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">ContainerProtocol</span> </span>&#123;</span><br><span class="line">    <span class="keyword">associatedtype</span> <span class="type">DataType</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(obj: DataType)</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">remove</span><span class="params">(obj: DataType)</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">getIterator</span><span class="params">()</span></span> -&gt; <span class="type">IteratorProtocol</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">forEach</span><span class="params">()</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>遵循容器接口的实体类的实现：</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*--AliPayContainer--*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AliPayContainer</span>&lt;<span class="title">T</span>: <span class="title">BaseModelProtocol</span>&gt;: <span class="title">ContainerProtocol</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> data: <span class="type">Array</span>&lt;<span class="type">T</span>&gt; = <span class="type">Array</span>&lt;<span class="type">T</span>&gt;()</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> it = <span class="type">AliPayIterator</span>(obj: <span class="keyword">self</span>.data <span class="keyword">as</span>! <span class="type">Array</span>&lt;<span class="type">AliPayModel</span>&gt;)</span><br><span class="line">    <span class="keyword">typealias</span> <span class="type">DataType</span> = <span class="type">T</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(obj: DataType)</span></span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.data.append(obj)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">remove</span><span class="params">(obj: DataType)</span></span> &#123;  &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">getIterator</span><span class="params">()</span></span> -&gt; <span class="type">IteratorProtocol</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.it</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">forEach</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> data &#123;</span><br><span class="line">            <span class="built_in">print</span>(item)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*--WeChatContainer--*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WeChatContainer</span>&lt;<span class="title">T</span>: <span class="title">WeChatModel</span>&gt;: <span class="title">ContainerProtocol</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> data: <span class="type">Set</span>&lt;<span class="type">T</span>&gt; = <span class="type">Set</span>&lt;<span class="type">T</span>&gt;()</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> it = <span class="type">WeChatItrator</span>(obj: <span class="keyword">self</span>.data)</span><br><span class="line">    <span class="keyword">typealias</span> <span class="type">DataType</span> = <span class="type">T</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(obj: DataType)</span></span> &#123; <span class="keyword">self</span>.data.insert(obj) &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">remove</span><span class="params">(obj: DataType)</span></span> &#123;  &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">getIterator</span><span class="params">()</span></span> -&gt; <span class="type">IteratorProtocol</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.it</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">forEach</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> data &#123;</span><br><span class="line">            <span class="built_in">print</span>(item)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>为了方便使用，我自己又定义了一个<code>Container</code>的容器类，为了就是方便调用，隐藏实现细节：</li></ul><blockquote><p>这里我觉得写的不是很好，代码就有点写死了，因为在add中需要具体根据类型去判断，这里我还没有想好！！</p></blockquote><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Container</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> aliPayContainer = <span class="type">AliPayContainer</span>&lt;<span class="type">AliPayModel</span>&gt;()</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> weChatContainer = <span class="type">WeChatContainer</span>&lt;<span class="type">WeChatModel</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(<span class="number">_</span> item: BaseModelProtocol)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> item <span class="keyword">is</span> <span class="type">AliPayModel</span> &#123;</span><br><span class="line">            aliPayContainer.add(obj: item <span class="keyword">as</span>! <span class="type">AliPayModel</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> item <span class="keyword">is</span> <span class="type">WeChatModel</span> &#123;</span><br><span class="line">            weChatContainer.add(obj: item <span class="keyword">as</span>! <span class="type">WeChatModel</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">allObjects</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (aliPayContainer.getIterator().hasNext()) &#123; aliPayContainer.forEach() &#125;</span><br><span class="line">        <span class="keyword">if</span> (weChatContainer.getIterator().hasNext()) &#123; weChatContainer.forEach() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>具体实现：</li></ul><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">let <span class="keyword">container</span> = Container()</span><br><span class="line"><span class="keyword">container</span>.add(AliPayModel(aliPayID: <span class="string">"a2"</span>))</span><br><span class="line"><span class="keyword">container</span>.add(WeChatModel(weChatID: <span class="string">"w3"</span>))</span><br><span class="line"><span class="keyword">container</span>.allObjects()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;问题：-收银台其中一个复杂点：对接的后台数据，会有很多种请求数据结构，你都需要将这些不同的数据组装在一起，方便展示，例如：&quot;&gt;&lt;a href=&quot;#问题：-收银台其中一个复杂点：对接的后台数据，会有很多种请求数据结构，你都需要将这些不同的数据组装在一起，方便展示，例如：&quot; class=&quot;headerlink&quot; title=&quot;问题： 收银台其中一个复杂点：对接的后台数据，会有很多种请求数据结构，你都需要将这些不同的数据组装在一起，方便展示，例如：&quot;&gt;&lt;/a&gt;问题： 收银台其中一个复杂点：对接的后台数据，会有很多种请求数据结构，你都需要将这些不同的数据组装在一起，方便展示，例如：&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;例如可用支付方式的展示（展示各个可用银行卡储蓄卡、信用卡、积分等等）&lt;/li&gt;
&lt;li&gt;例如订单明细的展示（展示各个可用银行卡储蓄卡、信用卡、积分等等不同渠道来源数据）&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="日志" scheme="http://www.ghcoder.com/categories/%E6%97%A5%E5%BF%97/"/>
    
    
      <category term="Swift、设计模式" scheme="http://www.ghcoder.com/tags/Swift%E3%80%81%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>收银台开发-责任链模式-设计模式(1)</title>
    <link href="http://www.ghcoder.com/2018/12/13/20181213/"/>
    <id>http://www.ghcoder.com/2018/12/13/20181213/</id>
    <published>2018-12-13T08:48:12.000Z</published>
    <updated>2018-12-12T09:32:17.735Z</updated>
    
    <content type="html"><![CDATA[<h3 id="在上一家公司，主要独自开发一个收银台的模块、这个模块设计到的点还是很多的，所以自己也花了很长一段时间，去研究设计模式，把代码写好，下面就会分几个章节分享一下我的几个心得"><a href="#在上一家公司，主要独自开发一个收银台的模块、这个模块设计到的点还是很多的，所以自己也花了很长一段时间，去研究设计模式，把代码写好，下面就会分几个章节分享一下我的几个心得" class="headerlink" title="在上一家公司，主要独自开发一个收银台的模块、这个模块设计到的点还是很多的，所以自己也花了很长一段时间，去研究设计模式，把代码写好，下面就会分几个章节分享一下我的几个心得"></a>在上一家公司，主要独自开发一个收银台的模块、这个模块设计到的点还是很多的，所以自己也花了很长一段时间，去研究设计模式，把代码写好，下面就会分几个章节分享一下我的几个心得</h3><a id="more"></a><h3 id="遇到情况："><a href="#遇到情况：" class="headerlink" title="遇到情况："></a>遇到情况：</h3><ul><li>动态的去决定支付的方式(类似支付包动态支付，可能在不同场景下，我们会走不同支付方式，可以是余额，可以是某银行、可以是余额宝、可以是花呗，那这样的话，可能会根据多个因素综合去判断，到底是走什么支付)。</li><li>我们这里为了说明情况，就单一只从金额去判断（这里假设你的几种支付渠道都是存在钱的！–&gt; 但是其实这里的有没有钱，其实你还是要走服务器去查询的）</li></ul><h3 id="解决问题："><a href="#解决问题：" class="headerlink" title="解决问题："></a>解决问题：</h3><h4 id="存在以下几个角色"><a href="#存在以下几个角色" class="headerlink" title="存在以下几个角色"></a>存在以下几个角色</h4><ol><li>抽象AbsPayWay类：（1. 下一节点的属性  2. chooseToPay的方法）</li><li>具体的PayWay类：（1. 余额（BalancePayWay）2. 花呗（HuaPayWay）3. 银行（BankPayWay））</li><li>PayWayParamters类 （1. 支付金额（payMentAmount））</li></ol><h4 id="具体代码"><a href="#具体代码" class="headerlink" title="具体代码"></a>具体代码</h4><ul><li>AbsPayWay类</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AbsPayWay</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> nextPayWay: <span class="type">AbsPayWay</span>?</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 这里可以根据自己项目的情况来配置，在什么情况下，是可以有自己来支付的，什么情况下需要交由下一级来支付</span></span><br><span class="line">    <span class="keyword">final</span> <span class="function"><span class="keyword">func</span> <span class="title">chooseToPay</span><span class="params">(paywayParamters: PayWayParamters)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> paywayParamters.payMentAmount &lt;= <span class="keyword">self</span>.configPayAmount() &#123;</span><br><span class="line">            <span class="keyword">self</span>.configAndToPay(paywayParamters: paywayParamters)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">let</span> <span class="number">_</span> = <span class="keyword">self</span>.nextPayWay &#123;</span><br><span class="line">            <span class="keyword">self</span>.nextPayWay?.chooseToPay(paywayParamters: paywayParamters)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"已经超出最大限额了！！！"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">configPayAmount</span><span class="params">()</span></span> -&gt; <span class="type">Int</span> &#123; <span class="keyword">return</span> <span class="number">0</span> &#125;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">configAndToPay</span><span class="params">(paywayParamters: PayWayParamters)</span></span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>PayWayParamters类结构</li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PayWayParamters</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> payMentAmount: <span class="built_in">Int</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(payMentAmount: <span class="built_in">Int</span>) &#123;</span><br><span class="line">        self.payMentAmount = payMentAmount</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>支付的具体几种方式：</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*----1.BalancePayWay（余额）------*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BalancePayWay</span>: <span class="title">AbsPayWay</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 余额的支付额度只有10元</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">configPayAmount</span><span class="params">()</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">10</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果余额支付了，我这里需要根据这种情况完成自己的方法</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">configAndToPay</span><span class="params">(paywayParamters: PayWayParamters)</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"余额支付了\(paywayParamters.payMentAmount)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*----2.HuaPayWay（花呗）------*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HuaPayWay</span>: <span class="title">AbsPayWay</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 花呗的支付额度只有100元</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">configPayAmount</span><span class="params">()</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">100</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果花呗支付了，我这里需要根据这种情况完成自己的方法</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">configAndToPay</span><span class="params">(paywayParamters: PayWayParamters)</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"花呗支付了\(paywayParamters.payMentAmount)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*----3.BankPayWay（银行支付）------*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BankPayWay</span>: <span class="title">AbsPayWay</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 银行的支付额度只有10000元</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">configPayAmount</span><span class="params">()</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">10000</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果银行支付了，我这里需要根据这种情况完成自己的方法</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">configAndToPay</span><span class="params">(paywayParamters: PayWayParamters)</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"银行支付了\(paywayParamters.payMentAmount)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>具体使用，这里为了收拢，隐藏实现细节，创建一个支付的类Pay</li></ul><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="type">PayObject</span> &#123;</span></span><br><span class="line"><span class="class">    </span></span><br><span class="line"><span class="class">    <span class="keyword">class</span> func pay(<span class="title">amount</span>: <span class="type">Int</span>) &#123;</span></span><br><span class="line"><span class="class">        let balancePayWay = <span class="type">BalancePayWay</span>()</span></span><br><span class="line"><span class="class">        let huaPayWay = <span class="type">HuaPayWay</span>()</span></span><br><span class="line"><span class="class">        let bankPayWay = <span class="type">BankPayWay</span>()</span></span><br><span class="line"><span class="class">        balancePayWay.nextPayWay = huaPayWay</span></span><br><span class="line"><span class="class">        huaPayWay.nextPayWay = bankPayWay</span></span><br><span class="line"><span class="class">        </span></span><br><span class="line"><span class="class">        let payparamters = <span class="type">PayWayParamters</span>(<span class="title">payMentAmount</span>: <span class="title">amount</span>)</span></span><br><span class="line"><span class="class">        balancePayWay.chooseToPay(<span class="title">paywayParamters</span>: <span class="title">payparamters</span>)</span></span><br><span class="line"><span class="class">    &#125;</span></span><br><span class="line"><span class="class">    </span></span><br><span class="line"><span class="class">&#125;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">/*<span class="comment">----Final: 具体使用-----*/ </span></span></span><br><span class="line"><span class="class"><span class="type">PayObject</span>.pay(<span class="title">amount</span>: 1)</span></span><br><span class="line"><span class="class">// 终端显示 余额支付了1</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="type">PayObject</span>.pay(<span class="title">amount</span>: 11)</span></span><br><span class="line"><span class="class">// 终端显示 花呗支付了11</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="type">PayObject</span>.pay(<span class="title">amount</span>: 101)</span></span><br><span class="line"><span class="class">// 终端显示 银行支付了101</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="type">PayObject</span>.pay(<span class="title">amount</span>: 100000001)</span></span><br><span class="line"><span class="class">// 终端显示 已经超出最大限额了！！！</span></span><br></pre></td></tr></table></figure><h3 id="存在问题："><a href="#存在问题：" class="headerlink" title="存在问题："></a>存在问题：</h3><ol><li>这里使用的场景是会存在等级、或者先后顺序的，需要具体考虑。</li><li>这里的PayWayParamters，是一个具体的类，也可以声明成一个抽象的类，然后在用不同的实体PayWayParamters来使用。</li><li>这里可以考虑不用继承换做协议可以试试。</li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;在上一家公司，主要独自开发一个收银台的模块、这个模块设计到的点还是很多的，所以自己也花了很长一段时间，去研究设计模式，把代码写好，下面就会分几个章节分享一下我的几个心得&quot;&gt;&lt;a href=&quot;#在上一家公司，主要独自开发一个收银台的模块、这个模块设计到的点还是很多的，所以自己也花了很长一段时间，去研究设计模式，把代码写好，下面就会分几个章节分享一下我的几个心得&quot; class=&quot;headerlink&quot; title=&quot;在上一家公司，主要独自开发一个收银台的模块、这个模块设计到的点还是很多的，所以自己也花了很长一段时间，去研究设计模式，把代码写好，下面就会分几个章节分享一下我的几个心得&quot;&gt;&lt;/a&gt;在上一家公司，主要独自开发一个收银台的模块、这个模块设计到的点还是很多的，所以自己也花了很长一段时间，去研究设计模式，把代码写好，下面就会分几个章节分享一下我的几个心得&lt;/h3&gt;
    
    </summary>
    
      <category term="日志" scheme="http://www.ghcoder.com/categories/%E6%97%A5%E5%BF%97/"/>
    
    
      <category term="Swift、设计模式" scheme="http://www.ghcoder.com/tags/Swift%E3%80%81%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>非越狱手机植入动态库</title>
    <link href="http://www.ghcoder.com/2018/12/12/20181212/"/>
    <id>http://www.ghcoder.com/2018/12/12/20181212/</id>
    <published>2018-12-12T01:48:12.000Z</published>
    <updated>2018-12-12T02:13:00.825Z</updated>
    
    <content type="html"><![CDATA[<h3 id="目标："><a href="#目标：" class="headerlink" title="目标："></a>目标：</h3><p>1.修改爱奇艺App<br>2.将这个修改过的App重签名<br>3.安装在未越狱手机上</p><h3 id="准备："><a href="#准备：" class="headerlink" title="准备："></a>准备：</h3><p>1.越狱手机和一台未越狱手机<br>2.Mac电脑</p><a id="more"></a><h4 id="1-修改爱奇艺App"><a href="#1-修改爱奇艺App" class="headerlink" title="1. 修改爱奇艺App"></a>1. 修改爱奇艺App</h4><ul><li>步骤1. 在越狱手机AppStore上下载爱奇艺App.</li><li>步骤2. 在越狱手机上找到爱奇艺的AppID, 这里可以通过<a href="https://github.com/CoderMJLee/MJAppTools" target="_blank" rel="noopener">MJAppTools</a>, 快速查询(这里也可以通过<a href="http://www.cycript.org/" target="_blank" rel="noopener">Cycript</a>来找到)，代码如下：</li></ul><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 终端</span></span><br><span class="line">MJAppTools -l</span><br><span class="line"></span><br><span class="line"><span class="comment">// 显示</span></span><br><span class="line">【爱奇艺】 &lt;com.qiyi.iphone&gt;</span><br><span class="line"><span class="regexp">/private/</span>var<span class="regexp">/mobile/</span>Containers<span class="regexp">/Bundle/</span>Application<span class="regexp">/C8575DD1-889E-4E70-AF66-4E4CC920F6AC/</span>iQiYiPhoneVideo.app</span><br><span class="line"><span class="regexp">/private/</span>var<span class="regexp">/mobile/</span>Containers<span class="regexp">/Data/</span>Application/CD9280DD-C4C3<span class="number">-4</span>CF2<span class="number">-84E0</span><span class="number">-5</span>F484596E211</span><br><span class="line">  arm_64 加壳</span><br></pre></td></tr></table></figure><ul><li>步骤3. 创建一个名叫<strong>libReveal.plist</strong>的文件，将刚才的AppIDcopy进plist中，如下:</li></ul><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="built_in">Filter </span>= &#123;</span><br><span class="line">Bundles = (</span><br><span class="line"><span class="string">"com.qiyi.iphone"</span></span><br><span class="line">);</span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>步骤4. 打开Reveal</li></ul><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1. 找到</span></span><br><span class="line">H<span class="function"><span class="title">elpe</span> -&gt;</span> S<span class="function"><span class="title">how</span> Reveal Library <span class="built_in">in</span> Finder -&gt;</span> iOS Library</span><br><span class="line"><span class="comment">//2. 重命名</span></span><br><span class="line">R<span class="function"><span class="title">evealServer</span> -&gt;</span> libReveal</span><br></pre></td></tr></table></figure><ul><li>步骤5. 将libReveal.plist 和 libReveal.dylib 同时上传到越狱机器以下路径（可以通过iFunBox）：</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Device<span class="regexp">/Library/</span>MobileSubStrate<span class="regexp">/DynamicLibraries</span></span><br></pre></td></tr></table></figure><ul><li><p>步骤6. 此时打开Reveal和越狱机器上的爱奇艺App，结合<a href="http://www.cycript.org/" target="_blank" rel="noopener">Cycript</a>或者<a href="https://github.com/CoderMJLee/mjcript" target="_blank" rel="noopener">mjcript</a>, 可以找到你想要修改的东西所属的类，这里如果我们需要修改播放的广告。</p></li><li><p>步骤7. 通过Reveal可以找到启动页面相关的广告View是<code>QYStartADView</code>, 它所属的类是<code>QYStartADViewController</code></p></li><li><p>步骤8. 通过<a href="https://github.com/KJCracks/Clutch" target="_blank" rel="noopener">Clutch</a>或<a href="https://github.com/stefanesser/dumpdecrypted" target="_blank" rel="noopener">dumpdecrypted</a>脱壳，得到脱壳后的新App。我用的是Clutch,代码如下:</p></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">// 罗列手机上可以脱壳的App</span><br><span class="line">Clutch -i</span><br><span class="line">// 脱壳指定App</span><br><span class="line">Clutch -d x(爱奇异的前面的数字)</span><br><span class="line">// 返回</span><br><span class="line">com.qiyi.iphone contains watchOS 2 compatible application. It's not possible to dump watchOS 2 apps <span class="keyword">with</span> Clutch <span class="number">2.0</span><span class="number">.4</span> <span class="keyword">at</span> this moment.</span><br><span class="line">Zipping iQiYiPhoneVideo.app</span><br><span class="line">ASLR slide: <span class="number">0x100004000</span></span><br><span class="line">Dumping &lt;QiYiUserNotification&gt; (arm64)</span><br><span class="line">Patched cryptid (<span class="number">64</span><span class="built_in">bit</span> <span class="keyword">segment</span>)</span><br><span class="line">ASLR slide: <span class="number">0x1000dc000</span></span><br><span class="line">Dumping &lt;QYToday&gt; (arm64)</span><br><span class="line">Patched cryptid (<span class="number">64</span><span class="built_in">bit</span> <span class="keyword">segment</span>)</span><br><span class="line">ASLR slide: <span class="number">0x1000bc000</span></span><br><span class="line">Dumping &lt;QYSiriShortCuts&gt; (arm64)</span><br><span class="line">Patched cryptid (<span class="number">64</span><span class="built_in">bit</span> <span class="keyword">segment</span>)</span><br><span class="line">Writing <span class="keyword">new</span> <span class="keyword">checksum</span></span><br><span class="line">Writing <span class="keyword">new</span> <span class="keyword">checksum</span></span><br><span class="line">Writing <span class="keyword">new</span> <span class="keyword">checksum</span></span><br><span class="line">objc[<span class="number">4015</span>]: <span class="keyword">Class</span> ZipArchive <span class="keyword">is</span> implemented <span class="keyword">in</span> <span class="keyword">both</span> /<span class="keyword">var</span>/tmp/clutch/<span class="number">1</span>C8BA028<span class="number">-6</span>FC4<span class="number">-4975</span>-B4E9<span class="number">-644</span>D2935FB55/clutch <span class="keyword">and</span> /<span class="keyword">private</span>/<span class="keyword">var</span>/mobile/Containers/Bundle/Application/C8575DD1<span class="number">-889E-4</span>E70-AF66<span class="number">-4E4</span>CC920F6AC/iQiYiPhoneVideo.app/Frameworks/QYUniversalFramework.framework/QYUniversalFramework. One <span class="keyword">of</span> the two will be used. Which one <span class="keyword">is</span> undefined.</span><br><span class="line">Dumping &lt;QYUniversalFramework&gt; arm64</span><br><span class="line">ASLR slide: <span class="number">0x100054000</span></span><br><span class="line">Dumping &lt;iQiYiPhoneVideo&gt; (arm64)</span><br><span class="line">Patched cryptid (<span class="number">64</span><span class="built_in">bit</span> <span class="keyword">segment</span>)</span><br><span class="line">Successfully dumped framework QYUniversalFramework!</span><br><span class="line"><span class="keyword">Child</span> exited <span class="keyword">with</span> <span class="keyword">status</span> <span class="number">0</span></span><br><span class="line">Zipping QYUniversalFramework.framework</span><br><span class="line">Zipping QYSiriShortCuts.appex</span><br><span class="line">Zipping QYToday.appex</span><br><span class="line">Zipping QiYiUserNotification.appex</span><br><span class="line">Writing <span class="keyword">new</span> <span class="keyword">checksum</span></span><br><span class="line">DONE: /<span class="keyword">private</span>/<span class="keyword">var</span>/mobile/Documents/Dumped/com.qiyi.iphone-iOS9<span class="number">.0</span>-(Clutch<span class="number">-2.0</span><span class="number">.4</span>).ipa</span><br><span class="line">Finished dumping com.qiyi.iphone <span class="keyword">in</span> <span class="number">38.5</span> seconds</span><br></pre></td></tr></table></figure><ul><li>步骤9. copy出来已经脱壳了的App,然后找到包中的Mach-O文件，最后运用<a href="http://stevenygard.com/projects/class-dump/" target="_blank" rel="noopener">class-dump</a>, 执行以下的命令得到相应的头文件：</li></ul><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span>-<span class="title">dump</span> -<span class="title">H</span> -<span class="title">o</span> <span class="title">iqiHeaders</span> <span class="title">iQiYiPhoneVideo</span>.<span class="title">app</span></span></span><br></pre></td></tr></table></figure><ul><li>步骤10. 通过查看类<code>QYStartADView</code>的相关头文件，代码如下:</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//     Generated by class-dump 3.5 (64 bit).</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//     class-dump is Copyright (C) 1997-1998, 2000-2001, 2004-2013 by Steve Nygard.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">"UIView.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">"QYStartADViewControllerDelegate.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"QYStartAdPlayerControllerDelegate.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@class</span> <span class="title">AdsClient</span>, <span class="title">CupidAd</span>, <span class="title">NSString</span>, <span class="title">NSTimer</span>, <span class="title">QYStartADViewController</span>, <span class="title">QYStartAdPlayerController</span>, <span class="title">QYWebContainer</span>, <span class="title">UILabel</span>, <span class="title">UIWindow</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">QYStartADView</span> : <span class="title">UIView</span> &lt;<span class="title">QYStartAdPlayerControllerDelegate</span>, <span class="title">QYStartADViewControllerDelegate</span>&gt;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">UIWindow</span> *_window;</span><br><span class="line">    <span class="built_in">NSTimer</span> *_adTimer;</span><br><span class="line">    <span class="keyword">float</span> _iAdTime;</span><br><span class="line">    _Bool _shouldRun;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> _addedTime;</span><br><span class="line">    <span class="keyword">float</span> _adShowTime;</span><br><span class="line">    _Bool _isFullScreenAd;</span><br><span class="line">    <span class="keyword">int</span> _type;</span><br><span class="line">    <span class="keyword">id</span> &lt;QYPhoneStartADViewDelegate&gt; _delegate;</span><br><span class="line">    <span class="built_in">UILabel</span> *_secords;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> _duration;</span><br><span class="line">    <span class="keyword">double</span> _logoBackHeight;</span><br><span class="line">    <span class="keyword">double</span> _needToCut;</span><br><span class="line">    <span class="built_in">UIView</span> *_adImageView;</span><br><span class="line">    QYWebContainer *_webView;</span><br><span class="line">    AdsClient *_adClient;</span><br><span class="line">    CupidAd *_adCupid;</span><br><span class="line">    QYStartAdPlayerController *_player;</span><br><span class="line">    QYStartADViewController *_startAdViewController;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) QYStartADViewController *startAdViewController; <span class="comment">// @synthesize startAdViewController=_startAdViewController;</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) QYStartAdPlayerController *player; <span class="comment">// @synthesize player=_player;</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="keyword">int</span> type; <span class="comment">// @synthesize type=_type;</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) CupidAd *adCupid; <span class="comment">// @synthesize adCupid=_adCupid;</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) AdsClient *adClient; <span class="comment">// @synthesize adClient=_adClient;</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) QYWebContainer *webView; <span class="comment">// @synthesize webView=_webView;</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) <span class="built_in">UIView</span> *adImageView; <span class="comment">// @synthesize adImageView=_adImageView;</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="keyword">double</span> needToCut; <span class="comment">// @synthesize needToCut=_needToCut;</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="keyword">double</span> logoBackHeight; <span class="comment">// @synthesize logoBackHeight=_logoBackHeight;</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="keyword">long</span> <span class="keyword">long</span> duration; <span class="comment">// @synthesize duration=_duration;</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>, <span class="keyword">nonatomic</span>) <span class="built_in">UILabel</span> *secords; <span class="comment">// @synthesize secords=_secords;</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) _Bool isFullScreenAd; <span class="comment">// @synthesize isFullScreenAd=_isFullScreenAd;</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) __<span class="keyword">weak</span> <span class="keyword">id</span> &lt;QYPhoneStartADViewDelegate&gt; delegate; <span class="comment">// @synthesize delegate=_delegate;</span></span><br><span class="line">- (<span class="keyword">void</span>).cxx_destruct;</span><br><span class="line">- (<span class="keyword">id</span>)imageFromImage:(<span class="keyword">id</span>)arg1 inRect:(<span class="keyword">struct</span> <span class="built_in">CGRect</span>)arg2;</span><br><span class="line">- (<span class="keyword">void</span>)playToEnd;</span><br><span class="line">- (<span class="keyword">void</span>)playError;</span><br><span class="line">- (<span class="keyword">void</span>)h5WillJumpToPage;</span><br><span class="line">- (<span class="keyword">void</span>)userInteractWithHtml;</span><br><span class="line">- (<span class="keyword">void</span>)sendH5AdClickPingback;</span><br><span class="line">- (<span class="keyword">void</span>)finishDisplayHtml;</span><br><span class="line">- (<span class="keyword">void</span>)keyboardDidHide;</span><br><span class="line">- (<span class="keyword">id</span>)labelWithFrame:(<span class="keyword">struct</span> <span class="built_in">CGRect</span>)arg1 backgroundColor:(<span class="keyword">id</span>)arg2 textColor:(<span class="keyword">id</span>)arg3 font:(<span class="keyword">id</span>)arg4 text:(<span class="keyword">id</span>)arg5 textAlignment:(<span class="keyword">long</span> <span class="keyword">long</span>)arg6;</span><br><span class="line">- (<span class="keyword">id</span>)imageViewWithFrame:(<span class="keyword">struct</span> <span class="built_in">CGRect</span>)arg1 image:(<span class="keyword">id</span>)arg2;</span><br><span class="line">- (<span class="keyword">void</span>)delegateCallStartADViewDidEnd;</span><br><span class="line">- (<span class="keyword">void</span>)showEnds;</span><br><span class="line">- (<span class="keyword">void</span>)updateTime;</span><br><span class="line">- (<span class="keyword">void</span>)updateUI:(<span class="keyword">id</span>)arg1;</span><br><span class="line">- (<span class="keyword">void</span>)finishAdShowForHtml;</span><br><span class="line">- (<span class="keyword">void</span>)prepareForEndAd;</span><br><span class="line">- (<span class="keyword">void</span>)secondChange;</span><br><span class="line">- (<span class="keyword">void</span>)timerStart;</span><br><span class="line">- (<span class="keyword">void</span>)showAdDetail;</span><br><span class="line">- (<span class="keyword">void</span>)skipAd;</span><br><span class="line">- (<span class="keyword">id</span>)createTouchScreenPromptView;</span><br><span class="line">- (<span class="keyword">id</span>)createViewWithType:(<span class="keyword">int</span>)arg1 withURL:(<span class="keyword">id</span>)arg2;</span><br><span class="line">- (<span class="keyword">void</span>)addBottomView;</span><br><span class="line">- (<span class="keyword">void</span>)addTimeBg;</span><br><span class="line">- (<span class="keyword">id</span>)initWithType:(<span class="keyword">int</span>)arg1 withURL:(<span class="keyword">id</span>)arg2 withDur:(<span class="keyword">long</span> <span class="keyword">long</span>)arg3 withAdData:(<span class="keyword">id</span>)arg4 withADCupid:(<span class="keyword">id</span>)arg5;</span><br><span class="line">- (<span class="keyword">void</span>)dealloc;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Remaining properties</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">readonly</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *debugDescription;</span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">readonly</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *description;</span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">readonly</span>) <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> hash;</span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">readonly</span>) Class superclass;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><blockquote><p>这里的代码量不是很多，我们看到这个<code>- (id)initWithType:(int)arg1 withURL:(id)arg2 withDur:(long long)arg3 withAdData:(id)arg4 withADCupid:(id)arg5;</code>有可能就是一个实例化方法，我们可以覆写这个方法来达到取消启动广告的效果（这里只是一个猜测！）</p></blockquote><ul><li>步骤11. 下面通过编写<a href="https://github.com/theos/theos/wiki/Installation-iOS" target="_blank" rel="noopener">theos</a>, 来覆写这个实例化方法，假设你已经按照github上的教程安装好了，此时就可以按照下面的流程开始：</li><li>xxx.xm的相关语法的编写可以参考<a href="http://iphonedevwiki.net/index.php/Logos#File_Extensions_for_Logos" target="_blank" rel="noopener">语法</a></li></ul><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*------1-------*/</span></span><br><span class="line"><span class="comment">// 在合适的位置执行，下面的命令</span></span><br><span class="line">nic.pl</span><br><span class="line"></span><br><span class="line"><span class="comment">/*------2-------*/</span></span><br><span class="line"><span class="comment">// 终端的显示</span></span><br><span class="line">NIC <span class="number">2.0</span> - New Instance Creator</span><br><span class="line">------------------------------</span><br><span class="line">  [<span class="meta">1.</span>] iphone/activator_event</span><br><span class="line">  [<span class="meta">2.</span>] iphone/application_modern</span><br><span class="line">  [<span class="meta">3.</span>] iphone/application_swift</span><br><span class="line">  [<span class="meta">4.</span>] iphone/cydget</span><br><span class="line">  [<span class="meta">5.</span>] iphone/flipswitch_switch</span><br><span class="line">  [<span class="meta">6.</span>] iphone/framework</span><br><span class="line">  [<span class="meta">7.</span>] iphone/ios7_notification_center_widget</span><br><span class="line">  [<span class="meta">8.</span>] iphone/library</span><br><span class="line">  [<span class="meta">9.</span>] iphone/notification_center_widget</span><br><span class="line">  [<span class="meta">10.</span>] iphone/preference_bundle_modern</span><br><span class="line">  [<span class="meta">11.</span>] iphone/tool</span><br><span class="line">  [<span class="meta">12.</span>] iphone/tool_swift</span><br><span class="line">  [<span class="meta">13.</span>] iphone/tweak</span><br><span class="line">  [<span class="meta">14.</span>] iphone/xpc_service</span><br><span class="line"><span class="function">Choose a <span class="title">Template</span> (<span class="params">required</span>):</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">/*------3-------*/</span></span></span><br><span class="line"><span class="function"><span class="comment">// 这里我们选择13，然后回车, 这里唯一需要注意的就是这个AppID,必须要填写爱奇艺的AppID, 其他的可以随便填写、或者直接回车</span></span></span><br><span class="line"><span class="function">Choose a <span class="title">Template</span> (<span class="params">required</span>): 13</span></span><br><span class="line"><span class="function">Project <span class="title">Name</span> (<span class="params">required</span>): ghiqyTest</span></span><br><span class="line"><span class="function">Package Name [com.yourcompany.ghiqytest]: com.ghcoder.ghiqyTest</span></span><br><span class="line"><span class="function">Author/Maintainer Name [龚欢]:</span></span><br><span class="line"><span class="function">[iphone/tweak] MobileSubstrate Bundle filter [com.apple.springboard]: com.qiyi.iphone</span></span><br><span class="line"><span class="function">[iphone/tweak] List of applications to terminate upon <span class="title">installation</span> (<span class="params">space-separated, <span class="string">'-'</span> <span class="keyword">for</span> none</span>) [SpringBoard]:</span></span><br><span class="line"><span class="function">Instantiating iphone/tweak <span class="keyword">in</span> ghiqytest/...</span></span><br><span class="line"><span class="function">Done.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">/*------4-------*/</span></span></span><br><span class="line"><span class="function"><span class="comment">// 创建完成之后，会发现自动创建了一个名叫ghiqytest的文件夹，里面存在四个文件，依次是:control(相关的配置信息)、ghiqyTest.plist(你需要修改的应用的AppID)、Makefile(配置文件)、Tweak.xm(需要修改的相关类)</span></span></span><br><span class="line"><span class="function"><span class="comment">// 下面是我对Tweak.xm修改的内容如下：</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">%hook QYStartADView</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">- (<span class="params">id</span>)initWithType:(<span class="params"><span class="keyword">int</span></span>)arg1 withURL:(<span class="params">id</span>)arg2 withDur:(<span class="params"><span class="keyword">long</span> <span class="keyword">long</span></span>)arg3 withAdData:(<span class="params">id</span>)arg4 withADCupid:(<span class="params">id</span>)arg5</span> &#123;</span><br><span class="line"><span class="keyword">return</span> nil;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line"><span class="comment">/*------5-------*/</span></span><br><span class="line"><span class="comment">// ssh到越狱手机，并且要在Makefile的开头加上下面两行配置</span></span><br><span class="line">export THEOS_DEVICE_IP=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">export THEOS_DEVICE_PORT=<span class="number">10010</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*------6-------*/</span></span><br><span class="line"><span class="comment">// 如果一切正常的话，执行完成之后，越狱机器就会自动重启了</span></span><br><span class="line">make clean &amp;&amp;  make package &amp;&amp; make install</span><br></pre></td></tr></table></figure><h4 id="2-将这个修改过的App重签名"><a href="#2-将这个修改过的App重签名" class="headerlink" title="2. 将这个修改过的App重签名"></a>2. 将这个修改过的App重签名</h4><ul><li>步骤1. 要完成这个重签名，我们需要有如下几个文件 </li></ul><ol><li>我们刚才编写的xxx.xm文件，其实刚才在我们重启之后，它就生成一个动态库文件，这个文件存放在越狱机的如下路径中：(Device-&gt;Library-&gt;MobileSubstrate-&gt;DynamicLibraries-&gt;ghiqyTest.dylib).</li><li>在越狱机器中加载这个动态库的Framework（CydiaSubstrate) [路径如下Device-&gt;Library-&gt;Frameworks-&gt;CydiaSubstrate.framework-&gt;CydiaSubstrate]</li><li>已经脱壳了的App</li><li>xxx.mobileprovision文件，这个是需要一年99美金才可以，可以通过创建一个空的Xcode项目，编译之后在Target的App中找到这个xxx.mobileprovision文件（或者可以去apple.developer.com后台去下载）</li></ol><ul><li><p>步骤2. 然后将上面提到三个文件<em>ghiqyTest.dylib</em>、<em>CydiaSubstrate</em>、<em>xxx.mobileprovision</em>一起拷贝到已经脱壳了的App中。</p></li><li><p>步骤3. 在脱壳了的App中找到<strong>info.plist</strong>文件，把里面的<strong>UISupportedDevices</strong>这一栏统一删除掉。</p></li><li>步骤4. 此时我们需要查看一些动态库，以及我们的Mach-O文件依赖的库是否配置正确:</li></ul><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">/*------<span class="number">1</span>-------*<span class="regexp">/</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 查看爱奇艺Mach-O依赖的动态库</span></span><br><span class="line"><span class="regexp">otool -L iQiYiPhoneVideo</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 终端显示</span></span><br><span class="line"><span class="regexp">/usr</span><span class="regexp">/lib/libc</span>++.<span class="number">1</span>.dylib (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">400.9</span>.<span class="number">4</span>)</span><br><span class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">libresolv</span>.9.<span class="title">dylib</span> (<span class="title">compatibility</span> <span class="title">version</span> 1.0.0, <span class="title">current</span> <span class="title">version</span> 1.0.0)</span></span><br><span class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">libsqlite3</span>.<span class="title">dylib</span> (<span class="title">compatibility</span> <span class="title">version</span> 9.0.0, <span class="title">current</span> <span class="title">version</span> 274.20.0)</span></span><br><span class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">libxml2</span>.2.<span class="title">dylib</span> (<span class="title">compatibility</span> <span class="title">version</span> 10.0.0, <span class="title">current</span> <span class="title">version</span> 10.9.0)</span></span><br><span class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">libz</span>.1.<span class="title">dylib</span> (<span class="title">compatibility</span> <span class="title">version</span> 1.0.0, <span class="title">current</span> <span class="title">version</span> 1.2.11)</span></span><br><span class="line">/System/Library/Frameworks/AVFoundation.framework/AVFoundation (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">2.0</span>.<span class="number">0</span>)</span><br><span class="line">/System/Library/Frameworks/Accelerate.framework/Accelerate (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">4.0</span>.<span class="number">0</span>)</span><br><span class="line">/System/Library/Frameworks/AdSupport.framework/AdSupport (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">1.0</span>.<span class="number">0</span>)</span><br><span class="line">/System/Library/Frameworks/AssetsLibrary.framework/AssetsLibrary (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">1.0</span>.<span class="number">0</span>)</span><br><span class="line">/System/Library/Frameworks/CFNetwork.framework/CFNetwork (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">974.2</span>.<span class="number">1</span>)</span><br><span class="line">/System/Library/Frameworks/CoreFoundation.framework/CoreFoundation (compatibility version <span class="number">150.0</span>.<span class="number">0</span>, current version <span class="number">1556.0</span>.<span class="number">0</span>)</span><br><span class="line">/System/Library/Frameworks/CoreGraphics.framework/CoreGraphics (compatibility version <span class="number">64.0</span>.<span class="number">0</span>, current version <span class="number">1245.8</span>.<span class="number">0</span>)</span><br><span class="line">/System/Library/Frameworks/CoreLocation.framework/CoreLocation (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">2245.4</span>.<span class="number">104</span>)</span><br><span class="line">/System/Library/Frameworks/CoreMotion.framework/CoreMotion (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">2245.4</span>.<span class="number">104</span>)</span><br><span class="line">/System/Library/Frameworks/CoreTelephony.framework/CoreTelephony (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">0.0</span>.<span class="number">0</span>)</span><br><span class="line">/System/Library/Frameworks/Foundation.framework/Foundation (compatibility version <span class="number">300.0</span>.<span class="number">0</span>, current version <span class="number">1556.0</span>.<span class="number">0</span>)</span><br><span class="line">/System/Library/Frameworks/ImageIO.framework/ImageIO (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">0.0</span>.<span class="number">0</span>)</span><br><span class="line">/System/Library/Frameworks/MapKit.framework/MapKit (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">14.0</span>.<span class="number">0</span>)</span><br><span class="line">/System/Library/Frameworks/MobileCoreServices.framework/MobileCoreServices (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">932.2</span>.<span class="number">0</span>)</span><br><span class="line">/System/Library/Frameworks/OpenAL.framework/OpenAL (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">1.0</span>.<span class="number">0</span>)</span><br><span class="line">@rpath/QYUniversalFramework.framework/QYUniversalFramework (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">1.0</span>.<span class="number">0</span>)</span><br><span class="line">/System/Library/Frameworks/QuartzCore.framework/QuartzCore (compatibility version <span class="number">1.2</span>.<span class="number">0</span>, current version <span class="number">1.11</span>.<span class="number">0</span>)</span><br><span class="line">/System/Library/Frameworks/SceneKit.framework/SceneKit (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">470.0</span>.<span class="number">0</span>)</span><br><span class="line">/System/Library/Frameworks/Security.framework/Security (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">58286.202</span>.<span class="number">3</span>)</span><br><span class="line">/System/Library/Frameworks/StoreKit.framework/StoreKit (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">1.0</span>.<span class="number">0</span>)</span><br><span class="line">/System/Library/Frameworks/SystemConfiguration.framework/SystemConfiguration (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">963.200</span>.<span class="number">27</span>)</span><br><span class="line">/System/Library/Frameworks/UIKit.framework/UIKit (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">61000.0</span>.<span class="number">0</span>)</span><br><span class="line">/System/Library/Frameworks/WebKit.framework/WebKit (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">606.1</span>.<span class="number">36</span>)</span><br><span class="line">/System/Library/Frameworks/Intents.framework/Intents (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">1.0</span>.<span class="number">0</span>)</span><br><span class="line">/System/Library/Frameworks/IntentsUI.framework/IntentsUI (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">1.0</span>.<span class="number">0</span>)</span><br><span class="line">/System/Library/Frameworks/ReplayKit.framework/ReplayKit (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">1.0</span>.<span class="number">0</span>)</span><br><span class="line">/System/Library/Frameworks/UserNotifications.framework/UserNotifications (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">1.0</span>.<span class="number">0</span>)</span><br><span class="line">/System/Library/Frameworks/Speech.framework/Speech (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">1.0</span>.<span class="number">0</span>)</span><br><span class="line">/System/Library/Frameworks/CoreData.framework/CoreData (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">865.0</span>.<span class="number">0</span>)</span><br><span class="line">/System/Library/Frameworks/EventKit.framework/EventKit (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">100.0</span>.<span class="number">0</span>)</span><br><span class="line">/System/Library/Frameworks/WatchConnectivity.framework/WatchConnectivity (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">175.0</span>.<span class="number">0</span>)</span><br><span class="line">/System/Library/Frameworks/PassKit.framework/PassKit (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">1.0</span>.<span class="number">0</span>)</span><br><span class="line">/System/Library/Frameworks/GLKit.framework/GLKit (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">103.2</span>.<span class="number">0</span>)</span><br><span class="line">/System/Library/Frameworks/Photos.framework/Photos (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">1.0</span>.<span class="number">0</span>)</span><br><span class="line">/System/Library/Frameworks/CoreSpotlight.framework/CoreSpotlight (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">1.0</span>.<span class="number">0</span>)</span><br><span class="line">/System/Library/Frameworks/LocalAuthentication.framework/LocalAuthentication (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">425.202</span>.<span class="number">1</span>)</span><br><span class="line">/System/Library/Frameworks/VideoToolbox.framework/VideoToolbox (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">1.0</span>.<span class="number">0</span>)</span><br><span class="line">/System/Library/Frameworks/AVKit.framework/AVKit (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">1.0</span>.<span class="number">0</span>)</span><br><span class="line">/System/Library/Frameworks/MessageUI.framework/MessageUI (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">3445.100</span>.<span class="number">35</span>)</span><br><span class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">libiconv</span>.2.<span class="title">dylib</span> (<span class="title">compatibility</span> <span class="title">version</span> 7.0.0, <span class="title">current</span> <span class="title">version</span> 7.0.0)</span></span><br><span class="line">/System/Library/Frameworks/CoreText.framework/CoreText (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">1.0</span>.<span class="number">0</span>)</span><br><span class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">libbz2</span>.1.0.<span class="title">dylib</span> (<span class="title">compatibility</span> <span class="title">version</span> 1.0.0, <span class="title">current</span> <span class="title">version</span> 1.0.5)</span></span><br><span class="line">/System/Library/Frameworks/CoreMedia.framework/CoreMedia (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">1.0</span>.<span class="number">0</span>)</span><br><span class="line">/System/Library/Frameworks/MediaPlayer.framework/MediaPlayer (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">1.0</span>.<span class="number">0</span>)</span><br><span class="line">/System/Library/Frameworks/AudioToolbox.framework/AudioToolbox (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">492.0</span>.<span class="number">0</span>)</span><br><span class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">libicucore</span>.<span class="title">A</span>.<span class="title">dylib</span> (<span class="title">compatibility</span> <span class="title">version</span> 1.0.0, <span class="title">current</span> <span class="title">version</span> 62.1.0)</span></span><br><span class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">libobjc</span>.<span class="title">A</span>.<span class="title">dylib</span> (<span class="title">compatibility</span> <span class="title">version</span> 1.0.0, <span class="title">current</span> <span class="title">version</span> 228.0.0)</span></span><br><span class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">libSystem</span>.<span class="title">B</span>.<span class="title">dylib</span> (<span class="title">compatibility</span> <span class="title">version</span> 1.0.0, <span class="title">current</span> <span class="title">version</span> 1252.200.5)</span></span><br><span class="line">/System/Library/Frameworks/CoreImage.framework/CoreImage (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">5.0</span>.<span class="number">0</span>)</span><br><span class="line">/System/Library/Frameworks/CoreML.framework/CoreML (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">1.0</span>.<span class="number">0</span>)</span><br><span class="line">/System/Library/Frameworks/CoreVideo.framework/CoreVideo (compatibility version <span class="number">1.2</span>.<span class="number">0</span>, current version <span class="number">1.5</span>.<span class="number">0</span>)</span><br><span class="line">/System/Library/Frameworks/JavaScriptCore.framework/JavaScriptCore (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">606.1</span>.<span class="number">36</span>)</span><br><span class="line">/System/Library/Frameworks/OpenGLES.framework/OpenGLES (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">1.0</span>.<span class="number">0</span>)</span><br><span class="line">/System/Library/Frameworks/SpriteKit.framework/SpriteKit (compatibility version <span class="number">1.0</span>.<span class="number">0</span>, current version <span class="number">2.0</span>.<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">/*------<span class="number">2</span>-------*<span class="regexp">/</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 需要把我们刚才创建的动态库链接进来，执行如下的命令</span></span><br><span class="line"><span class="regexp">insert_dylib @executable_path/ghiqy</span>Test.dylib iQiYiPhoneVideo iQiYiPhoneVideo --all-yes</span><br><span class="line"></span><br><span class="line">/*------<span class="number">3</span>-------*<span class="regexp">/</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 再次执行第一步的命令，会发现最下多了一行，就代表链接成功</span></span><br><span class="line"><span class="regexp">@executable_path/ghiqy</span>Test.dylib (compatibility version <span class="number">0.0</span>.<span class="number">0</span>, current version <span class="number">0.0</span>.<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">/*------<span class="number">4</span>-------*<span class="regexp">/</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 此时我们再看一下ghiqyTest.dylib, 这个动态库有没有依赖的其他动态库</span></span><br><span class="line"><span class="regexp">otool -L ghiqyTest.dylib</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 终端显示</span></span><br><span class="line"><span class="regexp">ghiqyTest.dylib (architecture arm64):</span></span><br><span class="line"><span class="regexp">/</span>Library/MobileSubstrate/DynamicLibraries/ghiqyTest.dylib (compatibility version <span class="number">0.0</span>.<span class="number">0</span>, current version <span class="number">0.0</span>.<span class="number">0</span>)</span><br><span class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">libobjc</span>.<span class="title">A</span>.<span class="title">dylib</span> (<span class="title">compatibility</span> <span class="title">version</span> 1.0.0, <span class="title">current</span> <span class="title">version</span> 228.0.0)</span></span><br><span class="line">/System/Library/Frameworks/Foundation.framework/Foundation (compatibility version <span class="number">300.0</span>.<span class="number">0</span>, current version <span class="number">1560.10</span>.<span class="number">0</span>)</span><br><span class="line">/System/Library/Frameworks/CoreFoundation.framework/CoreFoundation (compatibility version <span class="number">150.0</span>.<span class="number">0</span>, current version <span class="number">1560.10</span>.<span class="number">0</span>)</span><br><span class="line">/Library/Frameworks/CydiaSubstrate.framework/CydiaSubstrate (compatibility version <span class="number">0.0</span>.<span class="number">0</span>, current version <span class="number">0.0</span>.<span class="number">0</span>)</span><br><span class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">libc</span>++.1.<span class="title">dylib</span> (<span class="title">compatibility</span> <span class="title">version</span> 1.0.0, <span class="title">current</span> <span class="title">version</span> 400.9.4)</span></span><br><span class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">libSystem</span>.<span class="title">B</span>.<span class="title">dylib</span> (<span class="title">compatibility</span> <span class="title">version</span> 1.0.0, <span class="title">current</span> <span class="title">version</span> 1252.200.5)</span></span><br><span class="line"></span><br><span class="line">/*------<span class="number">5</span>-------*<span class="regexp">/</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 这里需要修改/</span>Library/Frameworks/CydiaSubstrate.framework/CydiaSubstrate路径，执行下面的命令就可以修改了</span><br><span class="line">install_name_tool -change /Library/Frameworks/CydiaSubstrate.framework/CydiaSubstrate @loader_path/CydiaSubstrate ghiqyTest.dylib</span><br><span class="line"></span><br><span class="line">/<span class="regexp">/ 再次执行第四部：就会发现之前路径修改了</span></span><br><span class="line"><span class="regexp">ghiqyTest.dylib (architecture arm64):</span></span><br><span class="line"><span class="regexp">/</span>Library/MobileSubstrate/DynamicLibraries/ghiqyTest.dylib (compatibility version <span class="number">0.0</span>.<span class="number">0</span>, current version <span class="number">0.0</span>.<span class="number">0</span>)</span><br><span class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">libobjc</span>.<span class="title">A</span>.<span class="title">dylib</span> (<span class="title">compatibility</span> <span class="title">version</span> 1.0.0, <span class="title">current</span> <span class="title">version</span> 228.0.0)</span></span><br><span class="line">/System/Library/Frameworks/Foundation.framework/Foundation (compatibility version <span class="number">300.0</span>.<span class="number">0</span>, current version <span class="number">1560.10</span>.<span class="number">0</span>)</span><br><span class="line">/System/Library/Frameworks/CoreFoundation.framework/CoreFoundation (compatibility version <span class="number">150.0</span>.<span class="number">0</span>, current version <span class="number">1560.10</span>.<span class="number">0</span>)</span><br><span class="line">@loader_path/CydiaSubstrate (compatibility version <span class="number">0.0</span>.<span class="number">0</span>, current version <span class="number">0.0</span>.<span class="number">0</span>)</span><br><span class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">libc</span>++.1.<span class="title">dylib</span> (<span class="title">compatibility</span> <span class="title">version</span> 1.0.0, <span class="title">current</span> <span class="title">version</span> 400.9.4)</span></span><br><span class="line">/usr/<span class="class"><span class="keyword">lib</span>/<span class="title">libSystem</span>.<span class="title">B</span>.<span class="title">dylib</span> (<span class="title">compatibility</span> <span class="title">version</span> 1.0.0, <span class="title">current</span> <span class="title">version</span> 1252.200.5)</span></span><br></pre></td></tr></table></figure><ul><li>步骤5. 我们要先找到我们签名证书的Identity,通过如下的命令可以找到</li></ul><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">security find-identity -v -p codesigning</span><br><span class="line"></span><br><span class="line"><span class="comment">// 终端显示</span></span><br><span class="line"><span class="number">1</span>) E797391C5ABBC9FB40EE04252C5679A6FEC1B351 <span class="string">"iPhone Developer: ******"</span></span><br><span class="line"><span class="number">2</span>) EF3725BCB7AB3C3F12AFC9C3A82C16B84A2925EC <span class="string">"iPhone Developer: *******"</span> (CSSMERR_TP_CERT_REVOKED)</span><br><span class="line">     <span class="number">2</span> valid identities found</span><br></pre></td></tr></table></figure><ul><li>步骤6. 开始签名：</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  iQiYiPhoneVideo<span class="selector-class">.app</span> codesign -fs E797391C5ABBC9FB40EE04252C5679A6FEC1B351 ghiqyTest.dylib</span><br><span class="line">ghiqyTest<span class="selector-class">.dylib</span>: replacing existing signature</span><br><span class="line">➜  iQiYiPhoneVideo<span class="selector-class">.app</span> codesign -fs E797391C5ABBC9FB40EE04252C5679A6FEC1B351 CydiaSubstrate</span><br><span class="line">CydiaSubstrate: replacing existing signature</span><br></pre></td></tr></table></figure><ul><li>步骤7. 最后我们对App整体签名，这里可以使用一个方便工具<a href="https://github.com/DanTheMan827/ios-app-signer" target="_blank" rel="noopener">iOSAppSinger</a></li><li>步骤7.1 也可以通过codesign，来完成对App的整体签名:</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*------1-------*/</span></span><br><span class="line"><span class="comment">// 先从xxx.mobileprovision导出xxx.entitlements</span></span><br><span class="line">security cms -D -<span class="selector-tag">i</span> embedded<span class="selector-class">.mobileprovision</span> &gt; temp.plist</span><br><span class="line">/usr/libexec/PlistBuddy -x -c <span class="string">'Print:Entitlements'</span> temp<span class="selector-class">.plist</span> &gt; entitlements.plist</span><br><span class="line"></span><br><span class="line"><span class="comment">/*------2-------*/</span></span><br><span class="line"><span class="comment">// 生成完成之后的entitlements.plist，配合codeSign进行重签名</span></span><br><span class="line">codesign -fs E797391C5ABBC9FB40EE04252C5679A6FEC1B351 --entitlements entitlements<span class="selector-class">.plist</span> xxx.app</span><br><span class="line"></span><br><span class="line"><span class="comment">/*------3-------*/</span></span><br><span class="line"><span class="comment">// 生成之后的xxx.app,放到Payload的文件夹中，然后进行压缩，然后再修改后缀名为.ipa</span></span><br></pre></td></tr></table></figure><h3 id="3-安装在未越狱手机上"><a href="#3-安装在未越狱手机上" class="headerlink" title="3. 安装在未越狱手机上"></a>3. 安装在未越狱手机上</h3><ul><li>直接通过iFunbox安装在非越狱机器上。</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;目标：&quot;&gt;&lt;a href=&quot;#目标：&quot; class=&quot;headerlink&quot; title=&quot;目标：&quot;&gt;&lt;/a&gt;目标：&lt;/h3&gt;&lt;p&gt;1.修改爱奇艺App&lt;br&gt;2.将这个修改过的App重签名&lt;br&gt;3.安装在未越狱手机上&lt;/p&gt;
&lt;h3 id=&quot;准备：&quot;&gt;&lt;a href=&quot;#准备：&quot; class=&quot;headerlink&quot; title=&quot;准备：&quot;&gt;&lt;/a&gt;准备：&lt;/h3&gt;&lt;p&gt;1.越狱手机和一台未越狱手机&lt;br&gt;2.Mac电脑&lt;/p&gt;
    
    </summary>
    
      <category term="日志" scheme="http://www.ghcoder.com/categories/%E6%97%A5%E5%BF%97/"/>
    
    
      <category term="Object-C、加密" scheme="http://www.ghcoder.com/tags/Object-C%E3%80%81%E5%8A%A0%E5%AF%86/"/>
    
  </entry>
  
  <entry>
    <title>Swift语法备忘录</title>
    <link href="http://www.ghcoder.com/2018/11/03/20181103/"/>
    <id>http://www.ghcoder.com/2018/11/03/20181103/</id>
    <published>2018-11-03T08:29:12.000Z</published>
    <updated>2018-11-04T02:38:12.915Z</updated>
    
    <content type="html"><![CDATA[<h2 id="for-xx-xx-xx-在swift中的写法：-gt-stride-from-to-by-从起始位置开始，每次增加或者减少确定的数量，到终点为止（不包含终点为止）"><a href="#for-xx-xx-xx-在swift中的写法：-gt-stride-from-to-by-从起始位置开始，每次增加或者减少确定的数量，到终点为止（不包含终点为止）" class="headerlink" title="for(xx;xx;xx) 在swift中的写法：-&gt; stride(from:to:by:) 从起始位置开始，每次增加或者减少确定的数量，到终点为止（不包含终点为止）"></a>for(xx;xx;xx) 在swift中的写法：-&gt; stride(from:to:by:) 从起始位置开始，每次增加或者减少确定的数量，到终点为止（不包含终点为止）</h2><blockquote><p>Returns a sequence from a starting value to, but not including, an end value, stepping by the specified amount.</p></blockquote><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> index <span class="keyword">in</span> stride(<span class="string">from:</span> <span class="number">10</span>, <span class="string">to:</span> <span class="number">1</span>, <span class="string">by:</span> <span class="number">-1</span>) &#123;</span><br><span class="line">    print(<span class="string">"index:\(index)"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;!-- more --&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 终端打印</span></span><br><span class="line"><span class="string">index:</span><span class="number">10</span></span><br><span class="line"><span class="string">index:</span><span class="number">9</span></span><br><span class="line"><span class="string">index:</span><span class="number">8</span></span><br><span class="line"><span class="string">index:</span><span class="number">7</span></span><br><span class="line"><span class="string">index:</span><span class="number">6</span></span><br><span class="line"><span class="string">index:</span><span class="number">5</span></span><br><span class="line"><span class="string">index:</span><span class="number">4</span></span><br><span class="line"><span class="string">index:</span><span class="number">3</span></span><br><span class="line"><span class="string">index:</span><span class="number">2</span></span><br></pre></td></tr></table></figure><h2 id="将一个String用一个Character-String分隔："><a href="#将一个String用一个Character-String分隔：" class="headerlink" title="将一个String用一个Character/String分隔："></a>将一个String用一个Character/String分隔：</h2><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">let</span> stringArray = <span class="built_in">string</span>.<span class="built_in">components</span>(separatedBy: <span class="string">"xx"</span>)</span><br></pre></td></tr></table></figure><h2 id="找到某个subString，并且remove掉-ps-这里只能找到一处并且删除掉-："><a href="#找到某个subString，并且remove掉-ps-这里只能找到一处并且删除掉-：" class="headerlink" title="找到某个subString，并且remove掉(ps: 这里只能找到一处并且删除掉)："></a>找到某个subString，并且remove掉(ps: 这里只能找到一处并且删除掉)：</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var conetent = <span class="string">"Hello World"</span></span><br><span class="line"><span class="keyword">let</span> <span class="built_in">range</span> = conetent.<span class="built_in">range</span>(of: <span class="string">" "</span>)!</span><br><span class="line"><span class="keyword">let</span> <span class="built_in">index</span> = conetent.distance(from: conetent.startIndex, <span class="keyword">to</span>: <span class="built_in">range</span>.lowerBound)</span><br><span class="line">conetent = String(conetent[..&lt;conetent.<span class="built_in">index</span>(conetent.startIndex, offsetBy: <span class="built_in">index</span>)]) + String(conetent[conetent.<span class="built_in">index</span>(conetent.startIndex, offsetBy: <span class="built_in">index</span>+<span class="number">1</span>)..&lt;conetent.endIndex])</span><br></pre></td></tr></table></figure><h2 id="替换某个字符"><a href="#替换某个字符" class="headerlink" title="替换某个字符"></a>替换某个字符</h2><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">conetent</span> = <span class="string">"Hello World"</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">newContent</span> = conetent.replacingOccurrences(of: <span class="string">" "</span>, <span class="keyword">with</span>: <span class="string">"&amp;"</span>)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;for-xx-xx-xx-在swift中的写法：-gt-stride-from-to-by-从起始位置开始，每次增加或者减少确定的数量，到终点为止（不包含终点为止）&quot;&gt;&lt;a href=&quot;#for-xx-xx-xx-在swift中的写法：-gt-stride-fro
      
    
    </summary>
    
      <category term="日志" scheme="http://www.ghcoder.com/categories/%E6%97%A5%E5%BF%97/"/>
    
    
      <category term="Swift" scheme="http://www.ghcoder.com/tags/Swift/"/>
    
  </entry>
  
  <entry>
    <title>每日一刷LeetCode算法</title>
    <link href="http://www.ghcoder.com/2018/02/23/20180223/"/>
    <id>http://www.ghcoder.com/2018/02/23/20180223/</id>
    <published>2018-02-23T03:22:12.000Z</published>
    <updated>2018-02-23T03:37:11.000Z</updated>
    
    <content type="html"><![CDATA[<ul><li>这道题是LeetCode上的第2题，难度为Midea的一到题目，这是一道关于链表的题目，原题如下：</li></ul><blockquote><p>You are given two non-empty linked lists representing two non-negative integers. The digits are stored in reverse order and each of their nodes contain a single digit. Add the two numbers and return it as a linked list.<br>You may assume the two numbers do not contain any leading zero, except the number 0 itself.</p></blockquote><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Example</span></span><br><span class="line"></span><br><span class="line">Input: (<span class="number">2</span> -&gt; <span class="number">4</span> -&gt; <span class="number">3</span>) + (<span class="number">5</span> -&gt; <span class="number">6</span> -&gt; <span class="number">4</span>)</span><br><span class="line">Output: <span class="number">7</span> -&gt; <span class="number">0</span> -&gt; <span class="number">8</span></span><br><span class="line">Explanation: <span class="number">342</span> + <span class="number">465</span> = <span class="number">807.</span></span><br></pre></td></tr></table></figure><a id="more"></a><ol><li>看到这道题目我主要的想法就是利用递归循环去遍历链表，并且将数值相加起来，如果超多数值9，相应位置上的数值减10，并且进一位</li><li>循环的遍历条件是Input中两个NodeList只要有一个存在值，就会继续递归。</li></ol><h3 id="如何创建链表"><a href="#如何创建链表" class="headerlink" title="如何创建链表"></a>如何创建链表</h3><ul><li>这个问题我想了一会，最好的创建方式，就是入参就是就是一个Array的数据结构，能够返回一个ListNode?值，函数如下：</li></ul><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">func createList(_ values: [Int]) -&gt; ListNode? &#123;</span><br><span class="line">    var head: ListNode? = nil</span><br><span class="line">    var trail: ListNode? = nil</span><br><span class="line">    values.forEach &#123; (value) <span class="keyword">in</span></span><br><span class="line">        let <span class="keyword">node</span> <span class="title">= ListNode</span>(value)</span><br><span class="line">        if head == nil &#123;</span><br><span class="line">            head = <span class="keyword">node</span><span class="title"></span></span><br><span class="line"><span class="title">        &#125; else</span> &#123;</span><br><span class="line">            trail!.next = <span class="keyword">node</span><span class="title"></span></span><br><span class="line"><span class="title">        &#125;</span></span><br><span class="line"><span class="title">        trail</span> = <span class="keyword">node</span><span class="title"></span></span><br><span class="line"><span class="title">    &#125;</span></span><br><span class="line"><span class="title">    return</span> head</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="如何递归："><a href="#如何递归：" class="headerlink" title="如何递归："></a>如何递归：</h3><ul><li>这里开始第一次提交的时候，错误了，就是入参在<code>[5][5]</code>的时候，我的返回值是<code>[0]</code>,但是应该是<code>[0,1]</code>,是因为我的循环条件忽略了<code>resultNode</code>值的判断。</li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">func addTwoNumbers(_ l1: ListNode?, _ l2: ListNode?) -&gt; ListNode? &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> n1 = l1</span><br><span class="line">    <span class="keyword">var</span> n2 = l2</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> resultNode: ListNode?</span><br><span class="line">    <span class="keyword">var</span> arr: [<span class="built_in">Int</span>] = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> n1?.<span class="keyword">val</span> != nil || n2?.<span class="keyword">val</span> != nil || resultNode?.<span class="keyword">val</span> != nil &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> temp1: <span class="built_in">Int</span> = <span class="number">0</span></span><br><span class="line">        <span class="keyword">var</span> temp2: <span class="built_in">Int</span> = <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> let v1 = n1?.<span class="keyword">val</span> &#123; temp1 = v1 &#125;</span><br><span class="line">        <span class="keyword">if</span> let v2 = n2?.<span class="keyword">val</span> &#123; temp2 = v2 &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> last: <span class="built_in">Int</span> = temp1 + temp2</span><br><span class="line">        <span class="keyword">if</span> let resultNode = resultNode &#123;</span><br><span class="line">            last += resultNode.<span class="keyword">val</span></span><br><span class="line">        &#125;</span><br><span class="line">   </span><br><span class="line">        <span class="keyword">if</span> (last &gt; <span class="number">9</span>) &#123;</span><br><span class="line">            resultNode = ListNode(last - <span class="number">10</span>)</span><br><span class="line">            resultNode?.next = ListNode(<span class="number">1</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resultNode = ListNode(last)</span><br><span class="line">        &#125;</span><br><span class="line">        arr.append(resultNode!.<span class="keyword">val</span>)</span><br><span class="line">        n1 = n1?.next</span><br><span class="line">        n2 = n2?.next</span><br><span class="line">        resultNode = resultNode?.next</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> createList(arr)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;ul&gt;
&lt;li&gt;这道题是LeetCode上的第2题，难度为Midea的一到题目，这是一道关于链表的题目，原题如下：&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;You are given two non-empty linked lists representing two non-negative integers. The digits are stored in reverse order and each of their nodes contain a single digit. Add the two numbers and return it as a linked list.&lt;br&gt;You may assume the two numbers do not contain any leading zero, except the number 0 itself.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight clean&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Example&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Input: (&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt; -&amp;gt; &lt;span class=&quot;number&quot;&gt;4&lt;/span&gt; -&amp;gt; &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;) + (&lt;span class=&quot;number&quot;&gt;5&lt;/span&gt; -&amp;gt; &lt;span class=&quot;number&quot;&gt;6&lt;/span&gt; -&amp;gt; &lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Output: &lt;span class=&quot;number&quot;&gt;7&lt;/span&gt; -&amp;gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; -&amp;gt; &lt;span class=&quot;number&quot;&gt;8&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Explanation: &lt;span class=&quot;number&quot;&gt;342&lt;/span&gt; + &lt;span class=&quot;number&quot;&gt;465&lt;/span&gt; = &lt;span class=&quot;number&quot;&gt;807.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="日志" scheme="http://www.ghcoder.com/categories/%E6%97%A5%E5%BF%97/"/>
    
    
      <category term="Swift、Algorithm" scheme="http://www.ghcoder.com/tags/Swift%E3%80%81Algorithm/"/>
    
  </entry>
  
  <entry>
    <title>自定义创建UIViewController Transition的动画效果</title>
    <link href="http://www.ghcoder.com/2017/12/20/20171221/"/>
    <id>http://www.ghcoder.com/2017/12/20/20171221/</id>
    <published>2017-12-20T02:58:12.000Z</published>
    <updated>2017-12-21T04:13:14.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="这篇文章翻译自raywenderlich上的最新一篇文章，原链接这里-https-www-raywenderlich-com-167198-make-uiviewcontroller-transition-animation-like-ping-app"><a href="#这篇文章翻译自raywenderlich上的最新一篇文章，原链接这里-https-www-raywenderlich-com-167198-make-uiviewcontroller-transition-animation-like-ping-app" class="headerlink" title="这篇文章翻译自raywenderlich上的最新一篇文章，原链接这里[https://www.raywenderlich.com/167198/make-uiviewcontroller-transition-animation-like-ping-app]"></a>这篇文章翻译自raywenderlich上的最新一篇文章，原链接这里[<a href="https://www.raywenderlich.com/167198/make-uiviewcontroller-transition-animation-like-ping-app]" target="_blank" rel="noopener">https://www.raywenderlich.com/167198/make-uiviewcontroller-transition-animation-like-ping-app]</a></h3><a id="more"></a><ul><li>作者的目标就是开发一个这样的切换样式，主要是实现的是<strong>主页面</strong>与 <strong>menu页面</strong>切换。</li></ul><p><img src="https://koenig-media.raywenderlich.com/uploads/2017/10/BasicPushPop.gif" alt="ping"></p><ul><li>这个教程中主要是用<strong>UIViewController transition animation</strong>来完成这个动画效果，在这个教程中你会学到下面的知识点：</li></ul><ol><li><strong>shape layer</strong></li><li><strong>masking</strong></li><li><strong>UIViewControllerAnimatedTransitioning protocol</strong></li><li><strong>UIPercentDrivenInteractiveTransition class</strong> </li><li>…</li></ol><h3 id="初始项目"><a href="#初始项目" class="headerlink" title="初始项目"></a>初始项目</h3><ul><li>项目的起始代码在这里[<a href="https://www.raywenderlich.com/170144/custom-uiviewcontroller-transitions-getting-started]" target="_blank" rel="noopener">https://www.raywenderlich.com/170144/custom-uiviewcontroller-transitions-getting-started]</a></li></ul><h3 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h3><h4 id="1-情况介绍"><a href="#1-情况介绍" class="headerlink" title="1.情况介绍"></a>1.情况介绍</h4><ol><li>首先我们要知道我们要做的这个动画效果主要是用在这种情况下： 从一个VC切换到其他的VC时候所发生的动画[这里的VC指的就是ViewController]。</li><li>在iOS中，我们可以通过将一系列的VC统一都放入到一个<code>UINavigationController</code>中，通过遵循<code>UIViewControllerAnimatedTransitioning</code>的代理来实现自定义的动画。</li><li>其实这里你可以通过使用 <code>UIView</code>/<code>UIKit Dynamics</code> 或者是一些更底层<code>Core Animation API</code>来实现上述的动画效果，但是我们这里主要使用的是<code>UIView</code>和<code>Core Animation APIS</code>来实现这些效果。</li></ol><h4 id="2-表象"><a href="#2-表象" class="headerlink" title="2.表象"></a>2.表象</h4><ol><li>这里的动画是从右上角开始，慢慢扩大，直到整个界面完整出现。</li><li>消失VC上的文字是从左边消失的。</li><li>出现的VC上的文字是从右边显示出来</li></ol><h4 id="3-开始搞"><a href="#3-开始搞" class="headerlink" title="3.开始搞"></a>3.开始搞</h4><ol><li>运行开始的代码，就会发现，现在是最简单的样式，两个VC通过<code>UINavigationController</code>来<code>push</code>和<code>pop</code>。</li><li>在<code>UINavigationController</code>的实例变量有一个<code>UINavigationControllerDelegate</code>的协议，这个协议有四个方法，能够确定VC以及VC的滑动方向。</li></ol><ul><li>新建一个<code>TransitionCoordinator</code>类的文件，继承自<code>NSObject</code>,并且遵循<code>UINavigationControllerDelegate</code>的协议：</li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TransitionCoordinator</span>: <span class="type">NSObject</span>, <span class="type">UINavigationControllerDelegate &#123;&#125;</span></span></span><br></pre></td></tr></table></figure><ul><li>然后给这个类里面添加一个协议方法，方法名如下, 目前先返回<code>nil</code>，后面会来补充进去：</li><li>这个方法主要确定了进入的VC/离开的VC,并且这个函数返回的是一个<code>animation</code>的对象。</li><li>当<code>navigationController</code>想要知道这个<code>animation</code>的对象的时候，而这里你却返回了一个<code>nil</code>的对象，这样的话，系统就会用默认的<code>push</code>、<code>pop</code>的动画效果。</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">navigationController</span><span class="params">(<span class="number">_</span> navigationController: UINavigationController,</span></span></span><br><span class="line"><span class="function"><span class="params">                      animationControllerFor operation: UINavigationControllerOperation,</span></span></span><br><span class="line"><span class="function"><span class="params">                      from fromVC: UIViewController,</span></span></span><br><span class="line"><span class="function"><span class="params">                      to toVC: UIViewController)</span></span> -&gt; <span class="type">UIViewControllerAnimatedTransitioning</span>? &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>–</p><ul><li>这里我们需要为<code>UINavigationController</code>的代理指定一下，回到<code>Appdelegate</code>的文件里面：</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在文件的Appdelegate.swift的文件头上声明一个变量</span></span><br><span class="line">let transitionCoordinator = TransitionCoordinator()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 并且在didFinishLaunch...</span></span><br><span class="line"><span class="selector-tag">nav</span><span class="selector-class">.isNavigationBarHidden</span> = true</span><br><span class="line"><span class="selector-tag">nav</span><span class="selector-class">.delegate</span> = transitionCoordinator</span><br></pre></td></tr></table></figure><ul><li>在<code>TransitionCoordinator</code>这个类里面，我们需要返回的是一个遵循<code>UIViewControllerAnimatedTransitioning</code>协议的对象。遵循这个协议也是一件很简单的事情。遵循这个协议需要确定两个函数：</li></ul><ol><li>第一个函数是：返回了动画需要执行的时间。</li><li>第二个函数是：这个函数里面入参是一个<code>context</code>的对象，这个对象包含了在执行这个动画时候需要的信息。</li></ol><p>–</p><ul><li>在这里，我们新建了一个对象，这个对象名字为<code>CircularTransition</code>,继承自<code>NSObject</code>，同事还需要继承<code>UIViewControllerAnimatedTransitioning</code>协议的对象，实现下面的两个方法：</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">transitionDuration</span><span class="params">(using transitionContext: UIViewControllerContextTransitioning?)</span></span> </span><br><span class="line">  -&gt; <span class="type">TimeInterval</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0.5</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里先空着，后面会重点来写这里的代码</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">animateTransition</span><span class="params">(using transitionContext: UIViewControllerContextTransitioning)</span></span> &#123;</span><br><span class="line">  <span class="comment">//make some magic happen</span></span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>并且将之前的<code>TransitionCoordinator.swift</code>文件里面返回<code>nil</code>的修改为：</li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> CircularTransition()</span><br></pre></td></tr></table></figure><ul><li>这样你就已经完成了一件事情，告诉<code>UINavigationController</code>,现在所有<code>VC</code>之前的切换都需要去询问<code>UIViewControllerAnimatedTransitioning object</code>,这里也就是我们新建的那个对象<code>CircularTransition</code></li></ul><ul><li>首先在<code>CircularTransition.swift</code>的开头，我们需要定义一个协议，协议如下：</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">CircleTransitionable</span> </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> triggerButton: <span class="type">UIButton</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">  <span class="keyword">var</span> contentTextView: <span class="type">UITextView</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">  <span class="keyword">var</span> mainView: <span class="type">UIView</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>首先定义了一个<code>triggerButton</code>,这将是我们VC中需要点击切换的按钮。</li><li>定义了一个<code>contentTextView</code>我们需要动画移入移除的View。</li><li><p><code>mainView</code>是显示的主内容。</p></li><li><p>下面我们切换到<code>ColoredViewController.swift</code>,这个<code>ColoredViewController.swift</code>是<code>BlackViewController</code> <code>WhiteViewController</code>的父类,让这个VC的遵循这个协议，并且这个VC里面已经存在<code>triggerButton</code>和<code>contentTextView</code>，只需要添加下面的代码：</p></li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mainView: UIView &#123;</span><br><span class="line">  <span class="keyword">return</span> view</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>–</p><ul><li>下面真正开始动手写动画的代码,切换到<code>CircularTransition.swift</code>里的<code>animateTransition(transitionContext:)</code>的函数，添加如下的代码：</li></ul><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">guard <span class="keyword">let</span> fromVC = transitionContext.viewController(forKey: .<span class="keyword">from</span>) <span class="keyword">as</span>? CircleTransitionable,</span><br><span class="line">  <span class="keyword">let</span> toVC = transitionContext.viewController(forKey: .to) <span class="keyword">as</span>? CircleTransitionable,</span><br><span class="line">  <span class="keyword">let</span> snapshot = fromVC.mainView.snapshotView(afterScreenUpdates: <span class="literal">false</span>) <span class="keyword">else</span> &#123;</span><br><span class="line">    transitionContext.completeTransition(<span class="literal">false</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>这里要确保你能获得所有的东西，通过<code>transitionContext</code>的对象，可以获取到切换的<code>viewcontrollers</code>,并且将这些vc修饰为<code>CircleTransitionable</code>,这样你就可以获得<code>main views</code>以及<code>text views</code>.</li><li><code>snapshotView(afterScreenUpdates:)</code>能够直接返回<code>fromVC</code>的暂存二进制照片。这是一个视图的副本拷贝。</li><li>在<code>else</code>的情况下，你调用了<code>transitionContext.completeTransition(false)</code>,你这里传递给<code>UIKit</code>一个false就是要告诉你没有完成动画，也不应该切换到下一个VC</li><li>通过<code>context</code>来获取切换的容器视图内容：<code>let containerView = transitionContext.containerView</code>,这个view，就是在VC切换中的主内容视图。[1. 当你做动画的时候，其实操作的就是这个containerView对象。2. 从这个containerView中移除fromVC 的view, 3. 在containerView中添加toVC的view]</li></ul><p>–</p><ul><li><strong>为了移动之前页面，而不会打乱之前的布局，这这里我们实际动画操作的是之前页面的副本</strong>在函数<code>animateTransition(transitionContext:):</code>的结尾添加如下的方法：</li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">containerView</span><span class="selector-class">.addSubview</span>(<span class="selector-tag">snapshot</span>)</span><br></pre></td></tr></table></figure><ul><li>而你真正需要移除的当前的view，需要在下面调用如下的方法：</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fromVC<span class="selector-class">.mainView</span><span class="selector-class">.removeFromSuperview</span>()</span><br></pre></td></tr></table></figure><p>–</p><ul><li>在下面添加如下的方法:</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">func animateOldTextOffscreen(fromView: UIView) &#123;</span><br><span class="line">  <span class="comment">// 1</span></span><br><span class="line">  UIView.animate(withDuration: <span class="number">0.25</span>, </span><br><span class="line">                 delay: <span class="number">0.0</span>, </span><br><span class="line">                 options: [.curveEaseIn], </span><br><span class="line">                 animations: &#123;</span><br><span class="line">    <span class="comment">// 2</span></span><br><span class="line">    fromView<span class="selector-class">.center</span> = CGPoint(x: fromView<span class="selector-class">.center</span><span class="selector-class">.x</span> - <span class="number">1300</span>,</span><br><span class="line">                              y: fromView<span class="selector-class">.center</span><span class="selector-class">.y</span> + <span class="number">1500</span>)</span><br><span class="line">    <span class="comment">// 3</span></span><br><span class="line">    fromView<span class="selector-class">.transform</span> = CGAffineTransform(scaleX: <span class="number">5.0</span>, y: <span class="number">5.0</span>)</span><br><span class="line">  &#125;, completion: nil)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>定义了一个0.25秒时间间隔的动画。</li><li>移动view的center的坐标。</li><li>并且将view的尺寸放大5倍。</li><li>这将会导致text的视图放大、并且同时移除界面。</li></ul><p>–</p><ul><li>在<code>animateTransition(transitionContext:):</code>的底部添加如下的代码：</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">animateOldTextOffscreen</span><span class="params">(fromView: snapshot)</span></span></span><br></pre></td></tr></table></figure><p>–</p><ul><li>此时运行代码的时候，会发现可以正常移动了，但是在以后的时候背景色一直是个黑色背景。</li><li>这个黑色的背景其实就是<code>containerView</code>的背景色，其实这里作者想动画的东西是文本，而不是整个view的动画，这里我们需要添加一个新的背景，并且这个新的背景我们不需要添加动画。切换到<code>CircularTransition.swift</code>里的<code>animateTransition(using:)</code>，在添加<code>snapshotView</code>作为子视图之前添加如下的代码：</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">let backgroundView = UIView()</span><br><span class="line">backgroundView<span class="selector-class">.frame</span> = toVC<span class="selector-class">.mainView</span><span class="selector-class">.frame</span></span><br><span class="line">backgroundView<span class="selector-class">.backgroundColor</span> = fromVC<span class="selector-class">.mainView</span><span class="selector-class">.backgroundColor</span></span><br><span class="line">containerView.addSubview(backgroundView)</span><br></pre></td></tr></table></figure><p>–</p><ul><li>以此在下面添加如下的代码,这个函数主要完成圆的动画效果:</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">animate</span><span class="params">(toView: UIView, fromTriggerButton triggerButton: UIButton)</span></span> &#123;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>并且在<code>animateTransition(using:)</code>中，在方法<code>animateOldTextOffscreen(fromView:snapshot):</code>之后添加如下的代码：</li></ul><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">containerView.addSubview(<span class="keyword">to</span>VC.mainView)</span><br><span class="line">animate(<span class="keyword">to</span>View: <span class="keyword">to</span>VC.mainView, <span class="keyword">from</span>TriggerButton: <span class="keyword">from</span>VC.triggerButton)</span><br></pre></td></tr></table></figure><p>–</p><ul><li>这里其实你已经大概的了解了动画的大体想法了，但是具体这个动画，我们还需要用到一个新的对象，这个对象是<code>CAShapeLayer</code>,<code>CAShapeLayer</code>是<code>CALayer</code>的一个特殊类，他不仅仅总是呈现正方形的图形，而是可以通过定义贝赛尔曲线路径，然后将路径丢给图层的路径，就可以实现自定义的图案了。</li><li>在这种情况下，我们需要定义两种不同的贝赛尔曲线路径。</li><li>在函数<code>animate(toView:triggerButton:):</code>里面添加如下的代码：</li></ul><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1</span></span><br><span class="line">let <span class="built_in">rect</span> = CGRect(x: triggerButton.frame.origin.x,</span><br><span class="line">                  y: triggerButton.frame.origin.y,</span><br><span class="line">                  <span class="built_in">width</span>: triggerButton.frame.<span class="built_in">width</span>,</span><br><span class="line">                  <span class="built_in">height</span>: triggerButton.frame.<span class="built_in">width</span>)</span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line">let circleMaskPathInitial = UIBezierPath(ovalIn: <span class="built_in">rect</span>)</span><br></pre></td></tr></table></figure><ul><li>这里创建了一个新的贝赛尔曲线，创建的是一个小小的圆，起始的位置，起始就是<code>triggerButton</code>的坐标。这也就是起始动画的圆的状态。</li><li>下面在创建相应的动画结束状态，由于你看到只是一个圈圈内的东西，圈圈边缘以及外部的东西都是看不到的，因此添加如下的代码：</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1</span></span><br><span class="line">let fullHeight = toView<span class="selector-class">.bounds</span><span class="selector-class">.height</span></span><br><span class="line">let extremePoint = CGPoint(x: triggerButton<span class="selector-class">.center</span><span class="selector-class">.x</span>,</span><br><span class="line">                           y: triggerButton<span class="selector-class">.center</span><span class="selector-class">.y</span> - fullHeight)</span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line">let radius = sqrt((extremePoint.x*extremePoint.x) +</span><br><span class="line">                  (extremePoint.y*extremePoint.y))</span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line">let circleMaskPathFinal = UIBezierPath(ovalIn: triggerButton<span class="selector-class">.frame</span><span class="selector-class">.insetBy</span>(dx: -radius,</span><br><span class="line">                                                                           dy: -radius))</span><br></pre></td></tr></table></figure><ul><li>首先定义了界面的总高度。</li><li>通过勾股定理来计算圆的半径。</li><li>然后定义出新的贝赛尔曲线路径。<strong>这里还用到一个新的api叫做insetBy，这里的作用就是设置边框的大小，当设置的值为负值的时候，原来的frame值就会变大</strong></li></ul><p>–</p><ul><li>现在已经获得了起始、终点的状态的贝塞尔曲线路径，所以在函数<code>animate(toView:triggerButton:)</code>中添加如下的代码：</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">let maskLayer = CAShapeLayer()</span><br><span class="line">maskLayer<span class="selector-class">.path</span> = circleMaskPathFinal.cgPath</span><br><span class="line">toView<span class="selector-class">.layer</span><span class="selector-class">.mask</span> = maskLayer</span><br></pre></td></tr></table></figure><ul><li>这里创建了一个<code>CAShapeLayer</code>的对象，并且将它的<code>path</code>的属性值设置为我们刚才创建的最终状态的贝塞尔曲线值，并且将这个<code>mask</code>的值赋值给<code>toView.layer.mask</code>。</li></ul><p>–</p><h4 id="CALayer-Masking是如何生效的呢？"><a href="#CALayer-Masking是如何生效的呢？" class="headerlink" title="CALayer Masking是如何生效的呢？"></a>CALayer Masking是如何生效的呢？</h4><ul><li>当一个view的alpha为1的时候，将会显示mask图层下的东西。</li><li>而当alpha为0的时候，就会隐藏mask下面的东西，这个就是图表解释：</li></ul><p><img src="https://koenig-media.raywenderlich.com/uploads/2014/10/mask-diagram-700x381.png" alt=""></p><p>–</p><ul><li>在函数<code>animate(toView:triggerButton:)</code>里创建了一个<code>CABasicAnimation</code>的对象,并且告诉它animation修改<code>path</code>的属性:</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">let maskLayerAnimation = CABasicAnimation(keyPath: <span class="string">"path"</span>)</span><br><span class="line">maskLayerAnimation<span class="selector-class">.fromValue</span> = circleMaskPathInitial.cgPath</span><br><span class="line">maskLayerAnimation<span class="selector-class">.toValue</span> = circleMaskPathFinal.cgPath</span><br><span class="line">maskLayerAnimation<span class="selector-class">.duration</span> = <span class="number">0.15</span></span><br><span class="line">maskLayerAnimation<span class="selector-class">.delegate</span> = self</span><br></pre></td></tr></table></figure><ul><li>然后到文件的最底下，创建如下的代码：</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">CircularTransition</span>: <span class="title">CAAnimationDelegate</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">func</span> <span class="title">animationDidStop</span><span class="params">(<span class="number">_</span> anim: CAAnimation, finished flag: Bool)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>当回调到这个函数的时候，就代表这个动画已经运行成功，并且结束了。在这个回调中，你需要给这个<code>context</code>调用<code>completeTransition()</code>的方法<code>,需要在这个回调的方法中获得</code>context<code>的对象，你需要将这个对象设置为全局的，在</code>CircularTransition`头部，添加如下的代码：</li></ul><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">weak</span> <span class="keyword">var</span> <span class="keyword">context</span>: UIViewControllerContextTransitioning?</span><br></pre></td></tr></table></figure><ul><li>并且在函数<code>animateTransition(transitionContext:)</code>中的guard之后添加如下的代码：</li></ul><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">context</span> = transitionContext</span><br></pre></td></tr></table></figure><ul><li>最后还需要将这个动画效果添加这个<code>Layer</code>上：</li></ul><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">maskLayer</span><span class="selector-class">.add</span>(maskLayerAnimation, <span class="attribute">forKey</span>: <span class="string">"path"</span>)</span><br></pre></td></tr></table></figure><p>–</p><h4 id="效果的完善"><a href="#效果的完善" class="headerlink" title="效果的完善"></a>效果的完善</h4><ul><li>在<code>CircularTransition</code>类里添加如下的方法：</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">func animateToTextView(toTextView: UIView, fromTriggerButton: UIButton) &#123;</span><br><span class="line">  let originalCenter = toTextView.center</span><br><span class="line">toTextView<span class="selector-class">.alpha</span> = <span class="number">0.0</span></span><br><span class="line">toTextView<span class="selector-class">.center</span> = fromTriggerButton.center</span><br><span class="line">toTextView<span class="selector-class">.transform</span> = CGAffineTransform(scaleX: <span class="number">0.1</span>, y: <span class="number">0.1</span>)</span><br><span class="line">UIView.animate(withDuration: <span class="number">0.25</span>, delay: <span class="number">0.1</span>, options: [.curveEaseOut], animations: &#123;</span><br><span class="line">  toTextView<span class="selector-class">.transform</span> = CGAffineTransform(scaleX: <span class="number">1.0</span>, y: <span class="number">1.0</span>)</span><br><span class="line">  toTextView<span class="selector-class">.center</span> = originalCenter</span><br><span class="line">  toTextView<span class="selector-class">.alpha</span> = <span class="number">1.0</span></span><br><span class="line">&#125;, completion: nil)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>最后再<code>animateTransition(transitionContext:).</code>方法中添加如下的按钮：</li></ul><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">animateToTextView(<span class="keyword">to</span>TextView: <span class="keyword">to</span>VC.contentTextView, <span class="keyword">from</span>TriggerButton: <span class="keyword">from</span>VC.triggerButton)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;这篇文章翻译自raywenderlich上的最新一篇文章，原链接这里-https-www-raywenderlich-com-167198-make-uiviewcontroller-transition-animation-like-ping-app&quot;&gt;&lt;a href=&quot;#这篇文章翻译自raywenderlich上的最新一篇文章，原链接这里-https-www-raywenderlich-com-167198-make-uiviewcontroller-transition-animation-like-ping-app&quot; class=&quot;headerlink&quot; title=&quot;这篇文章翻译自raywenderlich上的最新一篇文章，原链接这里[https://www.raywenderlich.com/167198/make-uiviewcontroller-transition-animation-like-ping-app]&quot;&gt;&lt;/a&gt;这篇文章翻译自raywenderlich上的最新一篇文章，原链接这里[&lt;a href=&quot;https://www.raywenderlich.com/167198/make-uiviewcontroller-transition-animation-like-ping-app]&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://www.raywenderlich.com/167198/make-uiviewcontroller-transition-animation-like-ping-app]&lt;/a&gt;&lt;/h3&gt;
    
    </summary>
    
      <category term="日志" scheme="http://www.ghcoder.com/categories/%E6%97%A5%E5%BF%97/"/>
    
    
      <category term="Swift、Animation" scheme="http://www.ghcoder.com/tags/Swift%E3%80%81Animation/"/>
    
  </entry>
  
  <entry>
    <title>关于RxSwift信息量的一些问题(二)</title>
    <link href="http://www.ghcoder.com/2017/10/11/20171011/"/>
    <id>http://www.ghcoder.com/2017/10/11/20171011/</id>
    <published>2017-10-11T08:50:12.000Z</published>
    <updated>2017-11-09T02:19:26.000Z</updated>
    
    <content type="html"><![CDATA[<ul><li>在之前的文章中，已经介绍了一些，过滤、筛选信号量的操作符，现在列举一些复杂操作符。</li></ul><hr><ul><li>首先要说的一个操作符叫做<code>Scan</code>，看到在官方文档中，<code>Scan</code>是属于在<code>Transforming</code>，也就可以猜到，这个操作符，其实也是信号转换的部分。</li></ul><a id="more"></a><ul><li>先看一下官方的介绍</li></ul><blockquote><p>The Scan operator applies a function to the first item emitted by the source Observable and then emits the result of that function as its own first emission. It also feeds the result of the function back into the function along with the second item emitted by the source Observable in order to generate its second emission. It continues to feed back its own subsequent emissions along with the subsequent emissions from the source Observable in order to create the rest of its sequence.</p></blockquote><ul><li>在看一下github上代码的：</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">scan</span>&lt;A&gt;<span class="params">(<span class="number">_</span> seed: A, accumulator: @escaping <span class="params">(A, E)</span></span></span> <span class="keyword">throws</span> -&gt; <span class="type">A</span>)</span><br><span class="line">    -&gt; <span class="type">Observable</span>&lt;<span class="type">A</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Scan</span>(source: <span class="keyword">self</span>.asObservable(), seed: seed, accumulator: accumulator)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">fileprivate</span> <span class="class"><span class="keyword">class</span> <span class="title">Scan</span>&lt;<span class="title">Element</span>, <span class="title">Accumulate</span>&gt;: <span class="title">Producer</span>&lt;<span class="title">Accumulate</span>&gt; </span>&#123;</span><br><span class="line"><span class="keyword">typealias</span> <span class="type">Accumulator</span> = (<span class="type">Accumulate</span>, <span class="type">Element</span>) <span class="keyword">throws</span> -&gt; <span class="type">Accumulate</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">fileprivate</span> <span class="keyword">let</span> _source: <span class="type">Observable</span>&lt;<span class="type">Element</span>&gt;</span><br><span class="line"><span class="keyword">fileprivate</span> <span class="keyword">let</span> _seed: <span class="type">Accumulate</span></span><br><span class="line"><span class="keyword">fileprivate</span> <span class="keyword">let</span> _accumulator: <span class="type">Accumulator</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">init</span>(source: <span class="type">Observable</span>&lt;<span class="type">Element</span>&gt;, seed: <span class="type">Accumulate</span>, accumulator: @escaping <span class="type">Accumulator</span>) &#123;</span><br><span class="line">    _source = source</span><br><span class="line">    _seed = seed</span><br><span class="line">    _accumulator = accumulator</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>这就可以根据官方的介绍可以知道，什么是<code>Scan</code></li><li><code>Scan</code>操作符，需要接受两个参数，一个参数是泛型A, 第二个参数是<code>block</code>，<code>block</code>的参数类型以及返回值的类型是<code>(A, Element) -&gt; A</code>.</li><li>这里的<code>Element</code>，是在也不是随编的泛型，可以看源码中知道，<code>Scan</code>在实例化的时候，出入了三个参数，其中第一个参数，是讲自己转化为可订阅的对象<code>self.asObservable()</code>,在入参中<code>Observable&lt;Element&gt;</code>,这就说明了，这个<code>Element</code>的类型，和你起初的订阅的对象的订阅类型是同一个类型。</li><li>看一下demo：</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">//</span> <span class="string">这里只是将字符打印出来</span></span><br><span class="line"><span class="string">let</span> <span class="string">bag</span> <span class="string">=</span> <span class="string">DisposeBag()</span></span><br><span class="line"><span class="string">let</span> <span class="string">subject</span> <span class="string">=</span> <span class="string">PublishSubject&lt;String&gt;()</span></span><br><span class="line">    </span><br><span class="line"><span class="string">_</span> <span class="string">=</span> <span class="string">subject</span></span><br><span class="line">    <span class="string">.subscribe(onNext:</span> <span class="string">&#123;print($0)&#125;)</span></span><br><span class="line">    <span class="string">.addDisposableTo(bag)</span></span><br><span class="line">    </span><br><span class="line"><span class="string">subject.onNext("gong")</span></span><br><span class="line"><span class="string">subject.onNext("h")</span></span><br><span class="line"></span><br><span class="line"><span class="string">//终端输出</span></span><br><span class="line"><span class="string">gong</span></span><br><span class="line"><span class="string">h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="string">//</span> <span class="string">这里是用来计算我输入字符长度的累加</span></span><br><span class="line"><span class="string">let</span> <span class="string">bag</span> <span class="string">=</span> <span class="string">DisposeBag()</span></span><br><span class="line"><span class="string">let</span> <span class="string">subject</span> <span class="string">=</span> <span class="string">PublishSubject&lt;String&gt;()</span></span><br><span class="line">    </span><br><span class="line"><span class="string">_</span> <span class="string">=</span> <span class="string">subject</span></span><br><span class="line">    <span class="string">.scan(0)</span> <span class="string">&#123;(count:</span> <span class="string">Int,</span> <span class="attr">content:</span> <span class="string">String)</span> <span class="string">in</span></span><br><span class="line">        <span class="string">return</span> <span class="string">count</span> <span class="string">+</span> <span class="string">content.characters.count</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line">    <span class="string">.subscribe(onNext:</span> <span class="string">&#123;print($0)&#125;)</span></span><br><span class="line">    <span class="string">.addDisposableTo(bag)</span></span><br><span class="line">    </span><br><span class="line"><span class="string">subject.onNext("gong")</span></span><br><span class="line"><span class="string">subject.onNext("h")</span></span><br><span class="line"><span class="string">//终端输出</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure><ul><li>你可以试试，看看能不能将Content的类型修改任意类型呢？答案是肯定不行的，之前在看源码的时候，我已经解释过为什么了，这里的<code>content</code>的类型必须要和我们制定定义<code>subject</code>的类型相同。</li></ul><hr><ul><li><code>skpiWhile</code>之前一直没有绕清楚，今天还是打算看一下源码，这只我已经说了，这个是用来筛选信号的时候用的，之前一直不清楚为什么为true的时候，就会过滤信号呢？</li><li>查看github上代码，可以看到在，关键的代码：</li></ul><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">func <span class="title">on</span>(<span class="params">_ <span class="keyword">event</span>: Event&lt;Element&gt;</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> <span class="keyword">event</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> .next(<span class="keyword">let</span> <span class="keyword">value</span>):</span><br><span class="line">        <span class="keyword">if</span> !_running &#123;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                _running = <span class="keyword">try</span> !_parent._predicate(<span class="keyword">value</span>)</span><br><span class="line">            &#125; <span class="keyword">catch</span> <span class="keyword">let</span> e &#123;</span><br><span class="line">                forwardOn(.error(e))</span><br><span class="line">                dispose()</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> _running &#123;</span><br><span class="line">            forwardOn(.next(<span class="keyword">value</span>))</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">case</span> .error, .completed:</span><br><span class="line">        forwardOn(<span class="keyword">event</span>)</span><br><span class="line">        dispose()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>看到代码就知道，除非是<code>.onError()/onCompleted()</code>事件，其他<code>.onNext()</code>的时间，都会先执行，你传入的<code>block</code>,看看你的返回值是什么？如果是true的话，就会执行<code>forwardOn()</code>的函数：</li></ul><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">final func <span class="title">forwardOn</span>(<span class="params">_ <span class="keyword">event</span>: Event&lt;O.E&gt;</span>)</span> &#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> DEBUG</span></span><br><span class="line">        <span class="function"><span class="keyword">if</span> <span class="title">AtomicIncrement</span>(<span class="params">&amp;_numberOfConcurrentCalls</span>) &gt; 1</span> &#123;</span><br><span class="line">            rxFatalError(<span class="string">"Warning: Recursive call or synchronization error!"</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        defer &#123;</span><br><span class="line">            _ = AtomicDecrement(&amp;_numberOfConcurrentCalls)</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">if</span> _disposed &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    _observer.<span class="keyword">on</span>(<span class="keyword">event</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>这里可以看到，他讲下一个值有递归传到同一个函数中了，这样就起到了过滤的效果。</li></ul><hr><ul><li>还有一些关于信号转换的问题，如何转化为数组类型,这里我用到<code>toArray()</code>,Demo:</li><li>这种转化是一次性的，并当你下次发送<code>.onNext()</code>的时候，他是不会转化，也就不会接受到<code>.onNext()</code>的回调.</li><li>如果在调用<code>.onNext()</code>值之前，你已经转化为Array，在你下次转化的时候，就无法再转化了。</li></ul><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Observable.of(1,2,3,4)</span><br><span class="line">.toArray()</span><br><span class="line">    .subscribe(onNext: &#123;</span><br><span class="line">        dump(type(of: $0))</span><br><span class="line">        dump($0)</span><br><span class="line">    &#125;)</span><br><span class="line"> </span><br><span class="line"><span class="comment"> //终端输出</span></span><br><span class="line">-<span class="ruby"> Swift.Array&lt;Swift.Int&gt; <span class="comment">#0</span></span></span><br><span class="line"><span class="ruby">▿ <span class="number">4</span> elements</span></span><br><span class="line"><span class="ruby">- <span class="number">1</span></span></span><br><span class="line"><span class="ruby">- <span class="number">2</span></span></span><br><span class="line"><span class="ruby">- <span class="number">3</span></span></span><br><span class="line"><span class="ruby">- <span class="number">4</span></span></span><br></pre></td></tr></table></figure><hr><ul><li>操作符<code>map</code>的操作，也是接受一个block，这里直接上代码：</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">on</span><span class="params">(<span class="number">_</span> event: Event&lt;SourceType&gt;)</span></span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> event &#123;</span><br><span class="line">    <span class="keyword">case</span> .next(<span class="keyword">let</span> element):</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> mappedElement = <span class="keyword">try</span> _transform(element)</span><br><span class="line">            forwardOn(.next(mappedElement))</span><br><span class="line">        &#125;</span><br><span class="line">        ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>这里可以看到我们出入的block 就像一个加工厂一样，会将接受到的<code>element</code>的参数，经过我们传入的block加工后，会返回一个新的值，然后又会回传给自己。这样每次接受到的就是新值了。</li></ul><hr><ul><li>而操作符<code>mapWithIndex会回传回来两个参数，一个value值，一个是index值</code>，这里又是什么意思呢？看一下源代码：</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">....</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> _index = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">on</span><span class="params">(<span class="number">_</span> event: Event&lt;SourceType&gt;)</span></span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> event &#123;</span><br><span class="line">    <span class="keyword">case</span> .next(<span class="keyword">let</span> element):</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> mappedElement = <span class="keyword">try</span> _selector(element, <span class="keyword">try</span> incrementChecked(&amp;_index))</span><br><span class="line">            forwardOn(.next(mappedElement))</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">incrementChecked</span><span class="params">(<span class="number">_</span> i: <span class="keyword">inout</span> Int)</span></span> <span class="keyword">throws</span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line"><span class="keyword">if</span> i == <span class="type">Int</span>.<span class="built_in">max</span> &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="type">RxError</span>.overflow</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> &#123; i += <span class="number">1</span> &#125;</span><br><span class="line"><span class="keyword">return</span> i</span><br><span class="line">&#125;</span><br><span class="line">        </span><br><span class="line">        ...</span><br></pre></td></tr></table></figure><ul><li>很明显了，index初始值是从0开始，每次都会拿到指针，进行累加，然后回传回去，也就是我们所说的index了。</li></ul><hr><ul><li>下面一个比较难理解的操作符叫做<code>flatMap</code>,看官网上的介绍为是这样的：</li></ul><blockquote><p>transform the items emitted by an Observable into Observables, then flatten the emissions from those into a single Observable</p></blockquote><ul><li>这句话其实非常绕，可能不理解的人可能一直读不懂。首先理解第一句话，<code>transform the items emitted by an Observable into Observables</code>: 我的理解是，由<em>一个</em><code>可被订阅的对象</code>发出的多个值，通过我们传入的<code>block</code>,来变换为多个<code>可订阅的对象</code></li></ul><figure class="highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> bag = DisposeBag()</span><br><span class="line"><span class="keyword">let</span> subject = PublishSubject&lt;GHObject&gt;()</span><br><span class="line">    </span><br><span class="line"><span class="number">_</span> = subject</span><br><span class="line">    .flatMap&#123;</span><br><span class="line">        <span class="number">$0</span>.gh<span class="number">_</span><span class="keyword">value</span>.asObservable()</span><br><span class="line">    &#125;</span><br><span class="line">    .subscribe(onNext: &#123;</span><br><span class="line">        print(type(<span class="keyword">of</span>: <span class="number">$0</span>))</span><br><span class="line">        dump(<span class="number">$0</span>)</span><br><span class="line">    &#125;).addDisposableTo(bag)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">let</span> gh<span class="number">1</span> = GHObject(gh<span class="number">_</span><span class="keyword">value</span>: Variable(<span class="number">10</span>))</span><br><span class="line">    </span><br><span class="line">subject.onNext(gh<span class="number">1</span>)</span><br><span class="line">gh<span class="number">1</span>.gh<span class="number">_</span><span class="keyword">value</span>.<span class="keyword">value</span> = <span class="number">11</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">struct GHObject &#123;</span><br><span class="line">    var gh<span class="number">_</span><span class="keyword">value</span>: Variable&lt;Int&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//终端输出</span></span><br><span class="line">- <span class="number">10</span></span><br><span class="line">- <span class="number">11</span></span><br></pre></td></tr></table></figure><ul><li>那第二句话怎么理解呢？<code>then flatten the emissions from those into a single Observable</code>,通过上面的代码已经知道了，我们通过<code>flatMap</code>操作符，已经将<code>GHObject</code>-&gt;<code>Int</code>，如果我存在多个<code>GHObject</code>的对象，同事发出值，此时我们就可以看做是将多个<code>Int</code>的值发送了出来，至于是哪个<code>GHObject</code>发送出来的，我们不需要关心：</li></ul><figure class="highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> bag = DisposeBag()</span><br><span class="line"><span class="keyword">let</span> subject = PublishSubject&lt;GHObject&gt;()</span><br><span class="line">    </span><br><span class="line"><span class="number">_</span> = subject</span><br><span class="line">    .flatMap&#123;</span><br><span class="line">        <span class="number">$0</span>.gh<span class="number">_</span><span class="keyword">value</span>.asObservable()</span><br><span class="line">    &#125;</span><br><span class="line">    .subscribe(onNext: &#123;</span><br><span class="line">        dump(<span class="number">$0</span>)</span><br><span class="line">    &#125;).addDisposableTo(bag)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">let</span> gh<span class="number">1</span> = GHObject(gh<span class="number">_</span><span class="keyword">value</span>: Variable(<span class="number">10</span>))</span><br><span class="line">    </span><br><span class="line">subject.onNext(gh<span class="number">1</span>)</span><br><span class="line">gh<span class="number">1</span>.gh<span class="number">_</span><span class="keyword">value</span>.<span class="keyword">value</span> = <span class="number">11</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">let</span> gh<span class="number">2</span> = GHObject(gh<span class="number">_</span><span class="keyword">value</span>: Variable(<span class="number">100</span>))</span><br><span class="line">subject.onNext(gh<span class="number">2</span>)</span><br><span class="line">    </span><br><span class="line">gh<span class="number">1</span>.gh<span class="number">_</span><span class="keyword">value</span>.<span class="keyword">value</span> = <span class="number">12</span></span><br><span class="line">gh<span class="number">2</span>.gh<span class="number">_</span><span class="keyword">value</span>.<span class="keyword">value</span> = <span class="number">101</span></span><br><span class="line">gh<span class="number">2</span>.gh<span class="number">_</span><span class="keyword">value</span>.<span class="keyword">value</span> = <span class="number">102</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//终端输出</span></span><br><span class="line">- <span class="number">10</span></span><br><span class="line">- <span class="number">11</span></span><br><span class="line">- <span class="number">100</span></span><br><span class="line">- <span class="number">12</span></span><br><span class="line">- <span class="number">101</span></span><br><span class="line">- <span class="number">102</span></span><br></pre></td></tr></table></figure><ul><li>至于和<code>flatMap</code>类似的一个操作符,我们叫做<code>flatMapLatest</code>,我是这么李操操作符的：<code>一点接受了一个新的GHObject发的gh_value值之后，之前旧的GHObject_value发出的gh_value我们都会统统过滤掉</code>，Demo:</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">let bag = DisposeBag()</span><br><span class="line">let subject = PublishSubject&lt;GHObject&gt;()</span><br><span class="line">    </span><br><span class="line">_ = subject</span><br><span class="line">    .flatMapLatest&#123;</span><br><span class="line">        $<span class="number">0</span><span class="selector-class">.gh_value</span><span class="selector-class">.asObservable</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    .subscribe(onNext: &#123;</span><br><span class="line">        dump($<span class="number">0</span>)</span><br><span class="line">    &#125;).addDisposableTo(bag)</span><br><span class="line">    </span><br><span class="line">let gh1 = GHObject(gh_value: Variable(<span class="number">10</span>))</span><br><span class="line">    </span><br><span class="line">subject.onNext(gh1)</span><br><span class="line">gh1<span class="selector-class">.gh_value</span><span class="selector-class">.value</span> = <span class="number">11</span></span><br><span class="line">    </span><br><span class="line">let gh2 = GHObject(gh_value: Variable(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line">subject.onNext(gh2)</span><br><span class="line">    </span><br><span class="line">gh1<span class="selector-class">.gh_value</span><span class="selector-class">.value</span> = <span class="number">12</span></span><br><span class="line">gh2<span class="selector-class">.gh_value</span><span class="selector-class">.value</span> = <span class="number">101</span></span><br><span class="line">gh2<span class="selector-class">.gh_value</span><span class="selector-class">.value</span> = <span class="number">102</span></span><br><span class="line">    </span><br><span class="line">gh1<span class="selector-class">.gh_value</span><span class="selector-class">.value</span> = <span class="number">13</span></span><br><span class="line">gh1<span class="selector-class">.gh_value</span><span class="selector-class">.value</span> = <span class="number">14</span></span><br><span class="line">gh1<span class="selector-class">.gh_value</span><span class="selector-class">.value</span> = <span class="number">15</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//终端输出</span></span><br><span class="line">- <span class="number">10</span></span><br><span class="line">- <span class="number">11</span></span><br><span class="line">- <span class="number">100</span></span><br><span class="line">- <span class="number">101</span></span><br><span class="line">- <span class="number">102</span></span><br></pre></td></tr></table></figure><ul><li>这个<code>flatMapLatest</code>听上去比较绕，但是一旦拿起笔画画，就会很清晰了。</li></ul><hr><ul><li>在获取某些信号量的时候，我们需要在此之前获取其他的信号，这里我们可以用到<code>.startWith(_ elements: E ...)</code>，看一下github中的源码，就会发现了：</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">startWith</span><span class="params">(<span class="number">_</span> elements: E ...)</span></span></span><br><span class="line">    -&gt; <span class="type">Observable</span>&lt;<span class="type">E</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">StartWith</span>(source: <span class="keyword">self</span>.asObservable(), elements: elements)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">run</span>&lt;O : ObserverType&gt;<span class="params">(<span class="number">_</span> observer: O, cancel: Cancelable)</span></span> -&gt; (sink: <span class="type">Disposable</span>, subscription: <span class="type">Disposable</span>) <span class="keyword">where</span> <span class="type">O</span>.<span class="type">E</span> == <span class="type">Element</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> e <span class="keyword">in</span> elements &#123;</span><br><span class="line">        observer.on(.next(e))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (sink: <span class="type">Disposables</span>.create(), subscription: source.subscribe(observer))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure><ul><li>看到这里，你应该也就知道了，这个startWith接受的是一个可变参数，在正在订阅到自己想要的数据之前，会先遍历打印之前的信号。看一下Demo:</li></ul><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> bag = DisposeBag()</span><br><span class="line"><span class="keyword">let</span> subject = PublishSubject&lt;<span class="keyword">String</span>&gt;()</span><br><span class="line">    </span><br><span class="line">subject</span><br><span class="line">    .startWith(<span class="string">"Step1"</span>, <span class="string">"Step2"</span>, <span class="string">"Step3"</span>)</span><br><span class="line">    .subscribe(onNext: &#123;</span><br><span class="line">        <span class="keyword">print</span>($<span class="number">0</span>)</span><br><span class="line">    &#125;).addDisposableTo(bag)</span><br><span class="line">    </span><br><span class="line">subject.onNext(<span class="string">"Do somethingA"</span>)</span><br><span class="line"><span class="keyword">print</span>(<span class="string">"----"</span>)</span><br><span class="line">subject.onNext(<span class="string">"Do somethingB"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//终端输出</span></span><br><span class="line">Step1</span><br><span class="line">Step2</span><br><span class="line">Step3</span><br><span class="line"><span class="keyword">Do</span> somethingA</span><br><span class="line">----</span><br><span class="line"><span class="keyword">Do</span> somethingB</span><br></pre></td></tr></table></figure><ul><li>可以看出，他不是每次订阅的时候，都会将startWith中的值打印一遍，只会打印一次。</li></ul><hr><ul><li>串联链接多个事件的操作符，我们可以使用<code>concat</code>,调用方式有很多种，看一下源码：</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">ObservableType</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     Concatenates the second observable sequence to `self` upon successful termination of `self`.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     - seealso: [concat operator on reactivex.io](http://reactivex.io/documentation/operators/concat.html)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     - parameter second: Second observable sequence.</span></span><br><span class="line"><span class="comment">     - returns: An observable sequence that contains the elements of `self`, followed by those of the second sequence.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">concat</span>&lt;O: ObservableConvertibleType&gt;<span class="params">(<span class="number">_</span> second: O)</span></span> -&gt; <span class="type">Observable</span>&lt;<span class="type">E</span>&gt; <span class="keyword">where</span> <span class="type">O</span>.<span class="type">E</span> == <span class="type">E</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">Observable</span>.concat([<span class="keyword">self</span>.asObservable(), second.asObservable()])</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>看这种定义的方式，我们可以这样实现<code>concat</code>:</li></ul><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">let</span> <span class="keyword">bag </span>= DisposeBag()</span><br><span class="line">    </span><br><span class="line"><span class="symbol">let</span> <span class="keyword">subjectA </span>= PublishSubject&lt;<span class="keyword">String&gt;()</span></span><br><span class="line"><span class="keyword">let </span><span class="keyword">subjectB </span>= PublishSubject&lt;<span class="keyword">String&gt;()</span></span><br><span class="line"><span class="keyword">let </span><span class="keyword">subjectC </span>= PublishSubject&lt;<span class="keyword">String&gt;()</span></span><br><span class="line"><span class="keyword"> </span>   </span><br><span class="line">_ = <span class="keyword">subjectA.concat(subjectB.concat(subjectC)).subscribe(onNext: </span>&#123;</span><br><span class="line">    print(<span class="number">$0</span>)</span><br><span class="line">&#125;).<span class="keyword">addDisposableTo(bag)</span></span><br><span class="line"><span class="keyword"> </span>   </span><br><span class="line"><span class="keyword">subjectA.onNext("A1")</span></span><br><span class="line"><span class="keyword">subjectA.onCompleted()</span></span><br><span class="line"><span class="keyword">subjectB.onNext("B1")</span></span><br><span class="line"><span class="keyword">subjectB.onCompleted()</span></span><br><span class="line"><span class="keyword">subjectC.onNext("C1")</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword">//终端的输出</span></span><br><span class="line"><span class="keyword">A1</span></span><br><span class="line"><span class="keyword">B1</span></span><br><span class="line"><span class="keyword">C1</span></span><br></pre></td></tr></table></figure><ul><li>这里你可以将<code>subjectA.onCompleted()</code>注释掉，你会发现终端的输出只有<code>A1</code>,这也就解释了<code>串行队列</code>，只有在<code>subjectA</code>完成的时候，他才会订阅下一个时间。</li><li>系统还给<code>Observable</code>写了个<code>extension</code>，这样在正在调用的时候，更加方便、直观。看源码：</li></ul><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">extension Observable &#123;</span><br><span class="line">    /**</span><br><span class="line">     Concatenates <span class="keyword">all</span> observable sequences in the given sequence, <span class="keyword">as</span> long <span class="keyword">as</span> the <span class="keyword">previous</span> observable sequence terminated successfully.</span><br><span class="line"></span><br><span class="line">     This operator <span class="built_in">has</span> tail recursive optimizations that will prevent stack overflow.</span><br><span class="line"></span><br><span class="line">     Optimizations will <span class="keyword">be</span> performed in cases equivalent <span class="keyword">to</span> followin<span class="variable">g:</span></span><br><span class="line"></span><br><span class="line">     [<span class="number">1</span>, [<span class="number">2</span>, [<span class="number">3</span>, .....].concat()].concat].concat()</span><br><span class="line"></span><br><span class="line">     - seealso: [concat operator <span class="keyword">on</span> reactivex.io](http://reactivex.io/documentation/operators/concat.html)</span><br><span class="line"></span><br><span class="line">     - <span class="keyword">return</span><span class="variable">s:</span> An observable sequence that contains the elements of each given sequence, in sequential order.</span><br><span class="line">     */</span><br><span class="line">    public static func concat&lt;S: Sequence &gt;(_ sequence: S) -&gt; Observable<span class="symbol">&lt;Element&gt;</span></span><br><span class="line">        where S.Iterator.Element == Observable<span class="symbol">&lt;Element&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Concat(<span class="keyword">source</span><span class="variable">s:</span> sequence, coun<span class="variable">t:</span> nil)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     Concatenates <span class="keyword">all</span> observable sequences in the given collection, <span class="keyword">as</span> long <span class="keyword">as</span> the <span class="keyword">previous</span> observable sequence terminated successfully.</span><br><span class="line"></span><br><span class="line">     This operator <span class="built_in">has</span> tail recursive optimizations that will prevent stack overflow.</span><br><span class="line"></span><br><span class="line">     Optimizations will <span class="keyword">be</span> performed in cases equivalent <span class="keyword">to</span> followin<span class="variable">g:</span></span><br><span class="line"></span><br><span class="line">     [<span class="number">1</span>, [<span class="number">2</span>, [<span class="number">3</span>, .....].concat()].concat].concat()</span><br><span class="line"></span><br><span class="line">     - seealso: [concat operator <span class="keyword">on</span> reactivex.io](http://reactivex.io/documentation/operators/concat.html)</span><br><span class="line"></span><br><span class="line">     - <span class="keyword">return</span><span class="variable">s:</span> An observable sequence that contains the elements of each given sequence, in sequential order.</span><br><span class="line">     */</span><br><span class="line">    public static func concat&lt;S: Collection &gt;(_ collection: S) -&gt; Observable<span class="symbol">&lt;Element&gt;</span></span><br><span class="line">        where S.Iterator.Element == Observable<span class="symbol">&lt;Element&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Concat(<span class="keyword">source</span><span class="variable">s:</span> collection, coun<span class="variable">t:</span> collection.<span class="built_in">count</span>.toIntMax())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     Concatenates <span class="keyword">all</span> observable sequences in the given collection, <span class="keyword">as</span> long <span class="keyword">as</span> the <span class="keyword">previous</span> observable sequence terminated successfully.</span><br><span class="line"></span><br><span class="line">     This operator <span class="built_in">has</span> tail recursive optimizations that will prevent stack overflow.</span><br><span class="line"></span><br><span class="line">     Optimizations will <span class="keyword">be</span> performed in cases equivalent <span class="keyword">to</span> followin<span class="variable">g:</span></span><br><span class="line"></span><br><span class="line">     [<span class="number">1</span>, [<span class="number">2</span>, [<span class="number">3</span>, .....].concat()].concat].concat()</span><br><span class="line"></span><br><span class="line">     - seealso: [concat operator <span class="keyword">on</span> reactivex.io](http://reactivex.io/documentation/operators/concat.html)</span><br><span class="line"></span><br><span class="line">     - <span class="keyword">return</span><span class="variable">s:</span> An observable sequence that contains the elements of each given sequence, in sequential order.</span><br><span class="line">     */</span><br><span class="line">    public static func concat(_ <span class="keyword">source</span><span class="variable">s:</span> Observable<span class="symbol">&lt;Element&gt;</span> ...) -&gt; Observable<span class="symbol">&lt;Element&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Concat(<span class="keyword">source</span><span class="variable">s:</span> sources, coun<span class="variable">t:</span> sources.<span class="built_in">count</span>.toIntMax())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>这里可以接受自定义的、系统的集合类型，以及一个可变的类型，都是可以这样使用的。上面的代码就可以按照Demo所写的那样完成:</li></ul><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">Observable.concat</span>([<span class="keyword">subjectA, </span><span class="keyword">subjectB, </span><span class="keyword">subjectC])</span></span><br><span class="line"><span class="keyword"> </span>       .<span class="keyword">subscribe(onNext: </span>&#123;</span><br><span class="line">            print(<span class="number">$0</span>)</span><br><span class="line">        &#125;).<span class="keyword">addDisposableTo(bag)</span></span><br><span class="line"><span class="keyword"> </span>       </span><br><span class="line"><span class="symbol">Observable.concat</span>(<span class="keyword">subjectA, </span><span class="keyword">subjectB, </span><span class="keyword">subjectC)</span></span><br><span class="line"><span class="keyword"> </span>   .<span class="keyword">subscribe(onNext: </span>&#123;print(<span class="number">$0</span>)&#125;)</span><br><span class="line">    .<span class="keyword">addDisposableTo(bag)</span></span><br></pre></td></tr></table></figure><hr><ul><li>如果是并行操作时间的话，我们可以选用<code>.merge()</code>的操作符:</li></ul><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">Observable</span><span class="selector-class">.merge</span>(subjectA, subjectB, subjectC)</span><br><span class="line">    <span class="selector-class">.subscribe</span>(<span class="attribute">onNext</span>: &#123;<span class="selector-tag">print</span>($<span class="number">0</span>)&#125;)</span><br><span class="line">    <span class="selector-class">.addDisposableTo</span>(bag)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="selector-tag">subjectA</span><span class="selector-class">.onNext</span>(<span class="string">"A1"</span>)</span><br><span class="line"><span class="comment">//subjectA.onCompleted()</span></span><br><span class="line"><span class="selector-tag">subjectB</span><span class="selector-class">.onNext</span>(<span class="string">"B1"</span>)</span><br><span class="line"><span class="comment">//subjectB.onCompleted()</span></span><br><span class="line"><span class="selector-tag">subjectC</span><span class="selector-class">.onNext</span>(<span class="string">"C1"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 终端输出</span></span><br><span class="line"><span class="selector-tag">A1</span></span><br><span class="line"><span class="selector-tag">B1</span></span><br><span class="line"><span class="selector-tag">C1</span></span><br></pre></td></tr></table></figure><ul><li>这样可以看出来，及时在之前的时间不完成的情况下，事件的打印依旧。</li></ul><hr><ul><li>为了方便控制并行的个数，我们也可以这样使用</li></ul><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">Observable</span><span class="selector-class">.of</span>(subjectA, subjectB, subjectC)</span><br><span class="line">       <span class="selector-class">.merge</span>(<span class="attribute">maxConcurrent</span>: <span class="number">2</span>)</span><br><span class="line">       <span class="selector-class">.subscribe</span>(<span class="attribute">onNext</span>: &#123;<span class="selector-tag">print</span>($<span class="number">0</span>)&#125;)</span><br><span class="line">       <span class="selector-class">.addDisposableTo</span>(bag)</span><br></pre></td></tr></table></figure><hr><ul><li>合并多个事件的操作符我们可以使用<code>combineLatest</code>,Demo：</li></ul><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">let</span> <span class="keyword">subjectA </span>= PublishSubject&lt;<span class="keyword">String&gt;()</span></span><br><span class="line"><span class="keyword">let </span><span class="keyword">subjectB </span>= PublishSubject&lt;<span class="keyword">String&gt;()</span></span><br><span class="line"><span class="keyword"> </span>   </span><br><span class="line"><span class="symbol">Observable.combineLatest</span>(<span class="keyword">subjectA, </span><span class="keyword">subjectB) </span>&#123;</span><br><span class="line">    a, <span class="keyword">b </span>in</span><br><span class="line">    </span><br><span class="line">    a + <span class="string">","</span> + <span class="keyword">b</span></span><br><span class="line"><span class="keyword"> </span>   </span><br><span class="line">&#125;.<span class="keyword">subscribe(onNext: </span>&#123;</span><br><span class="line">    dump(<span class="number">$0</span>)</span><br><span class="line">&#125;).<span class="keyword">addDisposableTo(bag)</span></span><br><span class="line"><span class="keyword"> </span>   </span><br><span class="line"><span class="keyword">subjectA.onNext("A1")</span></span><br><span class="line"><span class="keyword">subjectB.onNext("B1")</span></span><br><span class="line"><span class="keyword">subjectA.onNext("A2")</span></span><br><span class="line"><span class="keyword">subjectB.onNext("B2")</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword">//终端输出</span></span><br><span class="line"><span class="keyword">- </span><span class="string">"A1,B1"</span></span><br><span class="line">- <span class="string">"A2,B1"</span></span><br><span class="line">- <span class="string">"A2,B2"</span></span><br></pre></td></tr></table></figure><ul><li>如果是个时间的合并。类似下面：</li></ul><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">let</span> <span class="keyword">subjectA </span>= PublishSubject&lt;<span class="keyword">String&gt;()</span></span><br><span class="line"><span class="keyword">let </span><span class="keyword">subjectB </span>= PublishSubject&lt;<span class="keyword">String&gt;()</span></span><br><span class="line"><span class="keyword">let </span><span class="keyword">subjectC </span>= PublishSubject&lt;<span class="keyword">String&gt;()</span></span><br><span class="line"><span class="keyword"> </span>   </span><br><span class="line"><span class="symbol">Observable.combineLatest</span>([<span class="keyword">subjectA, </span><span class="keyword">subjectB, </span><span class="keyword">subjectC]) </span>&#123;</span><br><span class="line">    events in</span><br><span class="line">    </span><br><span class="line">    events.joined(separator: <span class="string">"--"</span>)</span><br><span class="line">    </span><br><span class="line">&#125;.<span class="keyword">subscribe(onNext: </span>&#123;</span><br><span class="line">    dump(<span class="number">$0</span>)</span><br><span class="line">&#125;).<span class="keyword">addDisposableTo(bag)</span></span><br><span class="line"><span class="keyword"> </span>   </span><br><span class="line"><span class="keyword">subjectA.onNext("A1")</span></span><br><span class="line"><span class="keyword">subjectB.onNext("B1")</span></span><br><span class="line"><span class="keyword">subjectA.onNext("A2")</span></span><br><span class="line"><span class="keyword">subjectB.onNext("B2")</span></span><br><span class="line"><span class="keyword">subjectC.onNext("C1")</span></span><br><span class="line"><span class="keyword">//终端输出</span></span><br><span class="line"><span class="keyword">- </span><span class="string">"A2--B2--C1"</span></span><br></pre></td></tr></table></figure><ul><li><code>combineLatest</code>合并的时间中，必须至少都发生了一次事件发送。</li><li>任一一个时间发生更新的时候，都会发生回调。</li><li>每次获取的值，都是当前事件的最新的值。</li><li><code>combineLatest</code>接受的合并事件也可以是不同的值类型 例如下面：</li></ul><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">let</span> <span class="keyword">bag </span>= DisposeBag()</span><br><span class="line">    </span><br><span class="line"><span class="symbol">let</span> <span class="keyword">subjectA </span>= PublishSubject&lt;<span class="keyword">String&gt;()</span></span><br><span class="line"><span class="keyword">let </span><span class="keyword">subjectB </span>= PublishSubject&lt;Int&gt;()</span><br><span class="line">    </span><br><span class="line"><span class="symbol">Observable.combineLatest</span>(<span class="keyword">subjectA, </span><span class="keyword">subjectB) </span>&#123;</span><br><span class="line">    a, <span class="keyword">b </span>in</span><br><span class="line">    </span><br><span class="line">    a + <span class="string">","</span> + <span class="string">"\(b)"</span></span><br><span class="line">    </span><br><span class="line">&#125;.<span class="keyword">subscribe(onNext: </span>&#123;</span><br><span class="line">    dump(<span class="number">$0</span>)</span><br><span class="line">&#125;).<span class="keyword">addDisposableTo(bag)</span></span><br><span class="line"><span class="keyword"> </span>   </span><br><span class="line"><span class="keyword">subjectA.onNext("A1")</span></span><br><span class="line"><span class="keyword">subjectB.onNext(11)</span></span><br><span class="line"><span class="keyword">subjectA.onNext("A2")</span></span><br><span class="line"><span class="keyword">subjectB.onNext(22)</span></span><br><span class="line"><span class="keyword">/、终端输出</span></span><br><span class="line"><span class="keyword">- </span><span class="string">"A1,11"</span></span><br><span class="line">- <span class="string">"A2,11"</span></span><br><span class="line">- <span class="string">"A2,22"</span></span><br></pre></td></tr></table></figure><hr><ul><li>每次只会合并多个最新的时间话，这里我可以使用<code>.zip()</code>的操作符:</li></ul><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">let</span> <span class="keyword">bag </span>= DisposeBag()</span><br><span class="line">    </span><br><span class="line"><span class="symbol">let</span> <span class="keyword">subjectA </span>= PublishSubject&lt;<span class="keyword">String&gt;()</span></span><br><span class="line"><span class="keyword">let </span><span class="keyword">subjectB </span>= PublishSubject&lt;Int&gt;()</span><br><span class="line">//let <span class="keyword">subjectC </span>= PublishSubject&lt;<span class="keyword">String&gt;()</span></span><br><span class="line"><span class="keyword"> </span>   </span><br><span class="line"><span class="symbol">Observable.zip</span>(<span class="keyword">subjectA, </span><span class="keyword">subjectB) </span>&#123;</span><br><span class="line">    a, <span class="keyword">b </span>in</span><br><span class="line">    </span><br><span class="line">    a + <span class="string">","</span> + <span class="string">"\(b)"</span></span><br><span class="line">    </span><br><span class="line">&#125;.<span class="keyword">subscribe(onNext: </span>&#123;</span><br><span class="line">    dump(<span class="number">$0</span>)</span><br><span class="line">&#125;).<span class="keyword">addDisposableTo(bag)</span></span><br><span class="line"><span class="keyword"> </span>   </span><br><span class="line"><span class="keyword">subjectA.onNext("A1")</span></span><br><span class="line"><span class="keyword">subjectB.onNext(11)</span></span><br><span class="line"><span class="keyword">subjectA.onNext("A2")</span></span><br><span class="line"><span class="keyword">subjectB.onNext(22)</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword">//终端的输出</span></span><br><span class="line"><span class="keyword">- </span><span class="string">"A1,11"</span></span><br><span class="line">- <span class="string">"A2,22"</span></span><br></pre></td></tr></table></figure><ul><li>如果存在多个<code>observable</code>,并且存在一定的依赖关系，在某件事情发送的时候，会去获取另一时间的最新值:</li></ul><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">bag</span> = DisposeBag()</span><br><span class="line">    </span><br><span class="line"><span class="keyword">let</span> <span class="attr">triggerSubject</span> = PublishSubject&lt;Void&gt;()</span><br><span class="line"><span class="keyword">let</span> <span class="attr">contentSubject</span> = BehaviorSubject&lt;String&gt;(value: <span class="string">"Default value"</span>)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="attr">_</span> = triggerSubject.withLatestFrom(contentSubject)</span><br><span class="line">.subscribe(onNext: &#123;</span><br><span class="line">    print($<span class="number">0</span>)</span><br><span class="line">&#125;).addDisposableTo(bag)</span><br><span class="line">    </span><br><span class="line">triggerSubject.onNext(())</span><br><span class="line">contentSubject.onNext(<span class="string">"Input Extra Content"</span>)</span><br><span class="line">triggerSubject.onNext(())</span><br><span class="line"></span><br><span class="line">//终端输出</span><br><span class="line">Default value</span><br><span class="line">Input Extra Content</span><br></pre></td></tr></table></figure><ul><li>在不同的<code>observable</code>中，我们可以随意切换任意的时间，使用操作符<code>.switchLatest()</code>,这样只能在指定的模式下，做指定的事件：</li></ul><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">let bag = DisposeBag()</span><br><span class="line">    </span><br><span class="line">let reading = PublishSubject<span class="variable">&lt;String&gt;</span>()</span><br><span class="line">let writing = PublishSubject<span class="variable">&lt;String&gt;</span>()</span><br><span class="line">    </span><br><span class="line">let work = PublishSubject<span class="variable">&lt;Observable&lt;String&gt;</span>&gt;()</span><br><span class="line"></span><br><span class="line">work.switchLatest()</span><br><span class="line">    .subscribe(<span class="keyword">on</span>Next: &#123;</span><br><span class="line">        print(<span class="variable">$0</span>)</span><br><span class="line">    &#125;).addDisposableTo(bag)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">work.<span class="keyword">on</span>Next(reading)</span><br><span class="line">reading.<span class="keyword">on</span>Next(<span class="string">"Read 1"</span>)</span><br><span class="line">    </span><br><span class="line">work.<span class="keyword">on</span>Next(writing)</span><br><span class="line">writing.<span class="keyword">on</span>Next(<span class="string">"Write 1"</span>)</span><br><span class="line">    </span><br><span class="line">reading.<span class="keyword">on</span>Next(<span class="string">"Read Extra"</span>)</span><br><span class="line">    </span><br><span class="line">work.<span class="keyword">on</span>Next(reading)</span><br><span class="line">reading.<span class="keyword">on</span>Next(<span class="string">"Read 2"</span>)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;ul&gt;
&lt;li&gt;在之前的文章中，已经介绍了一些，过滤、筛选信号量的操作符，现在列举一些复杂操作符。&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;ul&gt;
&lt;li&gt;首先要说的一个操作符叫做&lt;code&gt;Scan&lt;/code&gt;，看到在官方文档中，&lt;code&gt;Scan&lt;/code&gt;是属于在&lt;code&gt;Transforming&lt;/code&gt;，也就可以猜到，这个操作符，其实也是信号转换的部分。&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="日志" scheme="http://www.ghcoder.com/categories/%E6%97%A5%E5%BF%97/"/>
    
    
      <category term="Swift" scheme="http://www.ghcoder.com/tags/Swift/"/>
    
  </entry>
  
  <entry>
    <title>关于RxSwift信息量的一些问题</title>
    <link href="http://www.ghcoder.com/2017/10/08/20171007/"/>
    <id>http://www.ghcoder.com/2017/10/08/20171007/</id>
    <published>2017-10-08T08:12:12.000Z</published>
    <updated>2017-10-08T10:59:24.000Z</updated>
    
    <content type="html"><![CDATA[<ul><li>之前的文章中，介绍了RxSwift中，将之前传统的模式修改为更<code>Rx</code>的模式，在转换的过程中，我们会发现，其实<code>RxSwift</code>只是将之前分散处理的恭喜，收拢起来，之前我们或许关心的是<code>block的回调</code>、<code>代理方法</code>、<code>function()调用</code>，而现在我们或许只需要关心一件事情<code>信号量</code>，可想而知，伴随着项目的庞大、功能的复杂，整个项目中充斥着的都是这些信号，此时我们就要学会分析、过滤、转化信号。</li></ul><a id="more"></a><ul><li>先不去深究下面列举的每个操作符的源代码，在碰到一些特别难以理解的操作符，我们再去查看一下源代码</li></ul><hr><ul><li>忽略信号的操作：</li><li>1.先来看一下最最普通的订阅模式：</li></ul><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">let</span> <span class="keyword">subject </span>= PublishSubject&lt;Int&gt;()</span><br><span class="line"><span class="symbol">let</span> <span class="keyword">bag </span>= DisposeBag()</span><br><span class="line">    </span><br><span class="line">_ = <span class="keyword">subject.subscribe(</span></span><br><span class="line"><span class="keyword"> </span>   onNext: &#123; print(<span class="number">$0</span>) &#125;,</span><br><span class="line"><span class="symbol">    onCompleted:</span> &#123; print(<span class="string">"Completed"</span>) &#125;</span><br><span class="line">).<span class="keyword">addDisposableTo(bag)</span></span><br><span class="line"><span class="keyword"> </span>   </span><br><span class="line"><span class="keyword">subject.onNext(1)</span></span><br><span class="line"><span class="keyword">subject.onNext(2)</span></span><br><span class="line"><span class="keyword">subject.onNext(3)</span></span><br><span class="line"><span class="keyword">subject.onNext(4)</span></span><br><span class="line"><span class="keyword">subject.onCompleted()</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword">// </span>终端输入</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="symbol">Completed</span></span><br></pre></td></tr></table></figure><ul><li><ol start="2"><li>如果我们需要忽略所有的<code>.onNext()</code>的时间话，我们可以用<code>.ignoreElements()</code>操作符</li></ol></li></ul><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">let</span> <span class="keyword">subject </span>= PublishSubject&lt;Int&gt;()</span><br><span class="line"><span class="symbol">let</span> <span class="keyword">bag </span>= DisposeBag()</span><br><span class="line">    </span><br><span class="line">_ = <span class="keyword">subject</span></span><br><span class="line"><span class="keyword"> </span>   .ignoreElements()</span><br><span class="line">    .<span class="keyword">subscribe(</span></span><br><span class="line"><span class="keyword"> </span>       onNext: &#123; print(<span class="number">$0</span>) &#125;,</span><br><span class="line"><span class="symbol">        onCompleted:</span> &#123; print(<span class="string">"Completed"</span>) &#125;</span><br><span class="line">    ).<span class="keyword">addDisposableTo(bag)</span></span><br><span class="line"><span class="keyword"> </span>   </span><br><span class="line"><span class="keyword">subject.onNext(1)</span></span><br><span class="line"><span class="keyword">subject.onNext(2)</span></span><br><span class="line"><span class="keyword">subject.onNext(3)</span></span><br><span class="line"><span class="keyword">subject.onNext(4)</span></span><br><span class="line"><span class="keyword">subject.onCompleted()</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword">//终端输出</span></span><br><span class="line"><span class="keyword">Completed</span></span><br></pre></td></tr></table></figure><ul><li><ol start="3"><li>如果忽略前几个<code>.onNext()</code>事件信号量，我们可以使用<code>.skip()</code>操作符,例如<code>.skip(2)</code>如果不足2个的话，那就都跳过,直接<code>.onCompleted()</code>或者<code>.onError()</code>:</li></ol></li></ul><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">_ = <span class="keyword">subject</span></span><br><span class="line"><span class="keyword"> </span>   <span class="meta">.skip</span>(<span class="number">2</span>)</span><br><span class="line">    .<span class="keyword">subscribe(</span></span><br><span class="line"><span class="keyword"> </span>       onNext: &#123; print(<span class="number">$0</span>) &#125;,</span><br><span class="line"><span class="symbol">        onCompleted:</span> &#123; print(<span class="string">"Completed"</span>) &#125;</span><br><span class="line">    ).<span class="keyword">addDisposableTo(bag)</span></span><br><span class="line"><span class="keyword"> </span>   </span><br><span class="line"><span class="keyword">subject.onNext(1)</span></span><br><span class="line"><span class="keyword">subject.onNext(2)</span></span><br><span class="line"><span class="keyword">subject.onNext(3)</span></span><br><span class="line"><span class="keyword">subject.onNext(4)</span></span><br><span class="line"><span class="keyword">subject.onCompleted()</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword">//终端输出</span></span><br><span class="line"><span class="keyword">3</span></span><br><span class="line"><span class="keyword">4</span></span><br><span class="line"><span class="keyword">Completed</span></span><br></pre></td></tr></table></figure><ul><li>指定条件过滤数据，我们可以选用<code>.skipWhile()</code>，这里<code>.skipWhile()</code>接受的是一个<code>block</code>，理解起来可能会比较绕，但是看一下github上的解释：</li></ul><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"> Bypasses elements in </span>an<span class="markdown"> observable sequence as long as </span>a<span class="markdown"> specified condition is true and then returns </span>the<span class="markdown"> remaining elements.</span></span></span><br><span class="line"><span class="comment"><span class="markdown"> - seealso: [<span class="string">skipWhile operator on reactivex.io</span>](<span class="link">http://reactivex.io/documentation/operators/skipwhile.html</span>)</span></span></span><br><span class="line"><span class="comment"><span class="markdown"> - parameter predicate: A function to test each element for </span>a<span class="markdown"> condition.</span></span></span><br><span class="line"><span class="comment"><span class="markdown"> - returns: An observable sequence that contains </span>the<span class="markdown"> elements from </span>the<span class="markdown"> input sequence starting at </span>the<span class="markdown"> first element in </span>the<span class="markdown"> linear series that does not pass </span>the<span class="markdown"> test specified by predicate.</span></span></span><br><span class="line"><span class="comment"><span class="markdown"> */</span></span></span><br><span class="line">public func skipWhile(_ predicate: <span class="meta">@escaping</span> (E) throws -&gt; Bool) -&gt; Observable&lt;E&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> SkipWhile(source: asObservable(), predicate: predicate)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>只要条件为<code>true</code>，我们就会绕过发出的信号，看一下Demo：</li></ul><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> subject = PublishSubject&lt;Int&gt;()</span><br><span class="line"><span class="keyword">let</span> bag = DisposeBag()</span><br><span class="line">    </span><br><span class="line">_ = subject</span><br><span class="line">    .skipWhile<span class="function"><span class="params">(&#123; (item) -&gt; Bool <span class="keyword">in</span></span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">return</span> item != <span class="number">3</span></span></span></span><br><span class="line"><span class="function"><span class="params">    &#125;)</span></span></span><br><span class="line"><span class="function">    .<span class="title">subscribe</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        onNext: &#123; <span class="built_in">print</span>($<span class="number">0</span>) &#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">        onCompleted: &#123; <span class="built_in">print</span>(<span class="string">"Completed"</span>) &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span>.<span class="title">addDisposableTo</span><span class="params">(bag)</span></span></span><br><span class="line"><span class="function">    </span></span><br><span class="line"><span class="function"><span class="title">subject</span>.<span class="title">onNext</span><span class="params">(<span class="number">1</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">subject</span>.<span class="title">onNext</span><span class="params">(<span class="number">2</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">subject</span>.<span class="title">onNext</span><span class="params">(<span class="number">3</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">subject</span>.<span class="title">onNext</span><span class="params">(<span class="number">4</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">subject</span>.<span class="title">onCompleted</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">//终端输出</span></span><br><span class="line"><span class="function">3</span></span><br><span class="line"><span class="function">4</span></span><br><span class="line"><span class="function"><span class="title">Completed</span></span></span><br></pre></td></tr></table></figure><ul><li>依赖某个信号量的时候，我们可以选用<code>.skipUntil()</code>,这里的入参是例外一个信号量：</li></ul><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">let subject = PublishSubject<span class="variable">&lt;Int&gt;</span>()</span><br><span class="line">let dependOnSubject = PublishSubject<span class="variable">&lt;Void&gt;</span>()</span><br><span class="line">let bag = DisposeBag()</span><br><span class="line">    </span><br><span class="line">_ = subject</span><br><span class="line">    .<span class="keyword">skip</span>Until(dependOnSubject)</span><br><span class="line">    .subscribe(</span><br><span class="line">        <span class="keyword">on</span>Next: &#123; print(<span class="variable">$0</span>) &#125;,</span><br><span class="line">        <span class="keyword">on</span>Completed: &#123; print(<span class="string">"Completed"</span>) &#125;</span><br><span class="line">    ).addDisposableTo(bag)</span><br><span class="line">    </span><br><span class="line">subject.<span class="keyword">on</span>Next(<span class="number">1</span>)</span><br><span class="line">subject.<span class="keyword">on</span>Next(<span class="number">2</span>)</span><br><span class="line">subject.<span class="keyword">on</span>Next(<span class="number">3</span>)</span><br><span class="line">dependOnSubject.<span class="keyword">on</span>Next(())</span><br><span class="line">subject.<span class="keyword">on</span>Next(<span class="number">4</span>)</span><br><span class="line">subject.<span class="keyword">on</span>Completed()</span><br><span class="line"></span><br><span class="line">//终端输出</span><br><span class="line"><span class="number">4</span></span><br><span class="line">Completed</span><br></pre></td></tr></table></figure><ul><li>忽略重复出现的相邻的信号量，我们可以使用<code>.distinctUntilChanged()</code>, demo:</li></ul><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">let</span> <span class="keyword">subject </span>= PublishSubject&lt;Int&gt;()</span><br><span class="line"><span class="symbol">let</span> <span class="keyword">bag </span>= DisposeBag()</span><br><span class="line">    </span><br><span class="line">_ = <span class="keyword">subject</span></span><br><span class="line"><span class="keyword"> </span>   .distinctUntilChanged()</span><br><span class="line">    .<span class="keyword">subscribe(</span></span><br><span class="line"><span class="keyword"> </span>       onNext: &#123; print(<span class="number">$0</span>) &#125;,</span><br><span class="line"><span class="symbol">        onCompleted:</span> &#123; print(<span class="string">"Completed"</span>) &#125;</span><br><span class="line">    ).<span class="keyword">addDisposableTo(bag)</span></span><br><span class="line"><span class="keyword"> </span>   </span><br><span class="line"><span class="keyword">subject.onNext(1)</span></span><br><span class="line"><span class="keyword">subject.onNext(2)</span></span><br><span class="line"><span class="keyword">subject.onNext(2)</span></span><br><span class="line"><span class="keyword">subject.onNext(3)</span></span><br><span class="line"><span class="keyword">subject.onNext(3)</span></span><br><span class="line"><span class="keyword">subject.onNext(3)</span></span><br><span class="line"><span class="keyword">subject.onNext(4)</span></span><br><span class="line"><span class="keyword">subject.onNext(2)</span></span><br><span class="line"><span class="keyword">subject.onNext(3)</span></span><br><span class="line"><span class="keyword">subject.onCompleted()</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword">//终端输出</span></span><br><span class="line"><span class="keyword">1</span></span><br><span class="line"><span class="keyword">2</span></span><br><span class="line"><span class="keyword">3</span></span><br><span class="line"><span class="keyword">4</span></span><br><span class="line"><span class="keyword">2</span></span><br><span class="line"><span class="keyword">3</span></span><br><span class="line"><span class="keyword">Completed</span></span><br></pre></td></tr></table></figure><hr><ul><li>选择信号的操作</li><li>选择指定第几个信号量的操作符，我们可以选用<code>.elementAt()</code>,当选择的个数超过了存在的信号量，此时就会报<code>.onError()</code>的错误，Demo：</li></ul><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">let subject = PublishSubject<span class="variable">&lt;Int&gt;</span>()</span><br><span class="line">let bag = DisposeBag()</span><br><span class="line">    </span><br><span class="line">_ = subject</span><br><span class="line">    .elementAt(<span class="number">2</span>)</span><br><span class="line">    .subscribe(</span><br><span class="line">        <span class="keyword">on</span>Next: &#123; print(<span class="variable">$0</span>) &#125;,</span><br><span class="line">        <span class="keyword">on</span>Error: &#123;_ <span class="keyword">in</span> print(<span class="string">"Error"</span>) &#125;,</span><br><span class="line">        <span class="keyword">on</span>Completed: &#123; print(<span class="string">"Completed"</span>) &#125;</span><br><span class="line">    ).addDisposableTo(bag)</span><br><span class="line">    </span><br><span class="line">subject.<span class="keyword">on</span>Next(<span class="number">1</span>)</span><br><span class="line">subject.<span class="keyword">on</span>Next(<span class="number">2</span>)</span><br><span class="line">subject.<span class="keyword">on</span>Next(<span class="number">3</span>)</span><br><span class="line">subject.<span class="keyword">on</span>Next(<span class="number">4</span>)</span><br><span class="line">subject.<span class="keyword">on</span>Completed()</span><br><span class="line">//终端的输出</span><br><span class="line"><span class="number">3</span></span><br><span class="line">Completed</span><br></pre></td></tr></table></figure><ul><li>根据某些条件，筛选过滤出自己想要的数据，我们可以选用<code>.filter()</code>的操作符：</li></ul><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> subject = PublishSubject&lt;Int&gt;()</span><br><span class="line"><span class="keyword">let</span> bag = DisposeBag()</span><br><span class="line">    </span><br><span class="line">_ = subject</span><br><span class="line">    .filter<span class="function"><span class="params">(&#123; (item) -&gt; Bool <span class="keyword">in</span></span></span></span><br><span class="line"><span class="function"><span class="params">        item == <span class="number">2</span></span></span></span><br><span class="line"><span class="function"><span class="params">    &#125;)</span></span></span><br><span class="line"><span class="function">    .<span class="title">subscribe</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        onNext: &#123; <span class="built_in">print</span>($<span class="number">0</span>) &#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">        onError: &#123;_ <span class="keyword">in</span> <span class="built_in">print</span>(<span class="string">"Error"</span>) &#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">        onCompleted: &#123; <span class="built_in">print</span>(<span class="string">"Completed"</span>) &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span>.<span class="title">addDisposableTo</span><span class="params">(bag)</span></span></span><br><span class="line"><span class="function">    </span></span><br><span class="line"><span class="function"><span class="title">subject</span>.<span class="title">onNext</span><span class="params">(<span class="number">1</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">subject</span>.<span class="title">onNext</span><span class="params">(<span class="number">2</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">subject</span>.<span class="title">onNext</span><span class="params">(<span class="number">3</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">subject</span>.<span class="title">onNext</span><span class="params">(<span class="number">4</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">subject</span>.<span class="title">onCompleted</span><span class="params">()</span></span></span><br><span class="line"><span class="function">//终端输出</span></span><br><span class="line"><span class="function">2</span></span><br><span class="line"><span class="function"><span class="title">Completed</span></span></span><br></pre></td></tr></table></figure><ul><li>获取指定数量的操作符，我们也可以选用<code>.take()</code>,当入参的数字大于已有的数据，就会把所有的<code>.onNext()</code>事件都打印出来:</li></ul><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">let subject = PublishSubject<span class="variable">&lt;Int&gt;</span>()</span><br><span class="line">let bag = DisposeBag()</span><br><span class="line">    </span><br><span class="line">_ = subject</span><br><span class="line">    .take(<span class="number">2</span>)</span><br><span class="line">    .subscribe(</span><br><span class="line">        <span class="keyword">on</span>Next: &#123; print(<span class="variable">$0</span>) &#125;,</span><br><span class="line">        <span class="keyword">on</span>Error: &#123;_ <span class="keyword">in</span> print(<span class="string">"Error"</span>) &#125;,</span><br><span class="line">        <span class="keyword">on</span>Completed: &#123; print(<span class="string">"Completed"</span>) &#125;</span><br><span class="line">    ).addDisposableTo(bag)</span><br><span class="line">    </span><br><span class="line">subject.<span class="keyword">on</span>Next(<span class="number">1</span>)</span><br><span class="line">subject.<span class="keyword">on</span>Next(<span class="number">2</span>)</span><br><span class="line">subject.<span class="keyword">on</span>Next(<span class="number">3</span>)</span><br><span class="line">subject.<span class="keyword">on</span>Next(<span class="number">4</span>)</span><br><span class="line">subject.<span class="keyword">on</span>Completed()</span><br><span class="line">//终端输出</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line">Completed</span><br></pre></td></tr></table></figure><ul><li>还有一个比较绕的操作符，叫做<code>takeWhile()</code>,和<code>skipWhile()</code>类似，只要<code>block</code>中返回的是<code>true</code>的话，就会选取这儿元素，一旦false就结束</li></ul><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> subject = PublishSubject&lt;Int&gt;()</span><br><span class="line"><span class="keyword">let</span> bag = DisposeBag()</span><br><span class="line">    </span><br><span class="line">_ = subject</span><br><span class="line">    .takeWhile<span class="function"><span class="params">(&#123; (item) -&gt; Bool <span class="keyword">in</span></span></span></span><br><span class="line"><span class="function"><span class="params">        item != <span class="number">2</span></span></span></span><br><span class="line"><span class="function"><span class="params">    &#125;)</span></span></span><br><span class="line"><span class="function">    .<span class="title">subscribe</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        onNext: &#123; <span class="built_in">print</span>($<span class="number">0</span>) &#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">        onError: &#123;_ <span class="keyword">in</span> <span class="built_in">print</span>(<span class="string">"Error"</span>) &#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">        onCompleted: &#123; <span class="built_in">print</span>(<span class="string">"Completed"</span>) &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span>.<span class="title">addDisposableTo</span><span class="params">(bag)</span></span></span><br><span class="line"><span class="function">    </span></span><br><span class="line"><span class="function"><span class="title">subject</span>.<span class="title">onNext</span><span class="params">(<span class="number">1</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">subject</span>.<span class="title">onNext</span><span class="params">(<span class="number">2</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">subject</span>.<span class="title">onNext</span><span class="params">(<span class="number">3</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">subject</span>.<span class="title">onNext</span><span class="params">(<span class="number">4</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">subject</span>.<span class="title">onCompleted</span><span class="params">()</span></span></span><br><span class="line"><span class="function">//终端输入</span></span><br><span class="line"><span class="function">1</span></span><br><span class="line"><span class="function"><span class="title">Completed</span></span></span><br></pre></td></tr></table></figure><ul><li>准备定位到第几个的话，可以选用下面的操作符<code>takeWhileWithIndex</code>, 它接受两个参数，一个index,一个value,同样为true，就会选取，为false，就立刻结束</li></ul><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> subject = PublishSubject&lt;Int&gt;()</span><br><span class="line"><span class="keyword">let</span> bag = DisposeBag()</span><br><span class="line">    </span><br><span class="line">_ = subject</span><br><span class="line">    .takeWhileWithIndex<span class="function"><span class="params">(&#123; (item, index) -&gt; Bool <span class="keyword">in</span></span></span></span><br><span class="line"><span class="function"><span class="params">        item != <span class="number">2</span> &amp;&amp; index != <span class="number">3</span></span></span></span><br><span class="line"><span class="function"><span class="params">    &#125;)</span></span></span><br><span class="line"><span class="function">    .<span class="title">subscribe</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        onNext: &#123; <span class="built_in">print</span>($<span class="number">0</span>) &#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">        onError: &#123;_ <span class="keyword">in</span> <span class="built_in">print</span>(<span class="string">"Error"</span>) &#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">        onCompleted: &#123; <span class="built_in">print</span>(<span class="string">"Completed"</span>) &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span>.<span class="title">addDisposableTo</span><span class="params">(bag)</span></span></span><br><span class="line"><span class="function">    </span></span><br><span class="line"><span class="function"><span class="title">subject</span>.<span class="title">onNext</span><span class="params">(<span class="number">1</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">subject</span>.<span class="title">onNext</span><span class="params">(<span class="number">2</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">subject</span>.<span class="title">onNext</span><span class="params">(<span class="number">3</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">subject</span>.<span class="title">onNext</span><span class="params">(<span class="number">4</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">subject</span>.<span class="title">onCompleted</span><span class="params">()</span></span></span><br><span class="line"><span class="function">//终端输出</span></span><br><span class="line"><span class="function">1</span></span><br><span class="line"><span class="function"><span class="title">Completed</span></span></span><br></pre></td></tr></table></figure><ul><li>依赖于某个信号，来获取信号量，可以选用<code>.takeUntil()</code>,Demo</li></ul><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">let subject = PublishSubject<span class="variable">&lt;Int&gt;</span>()</span><br><span class="line">let dependOnSubject = PublishSubject<span class="variable">&lt;Void&gt;</span>()</span><br><span class="line">let bag = DisposeBag()</span><br><span class="line">    </span><br><span class="line">_ = subject</span><br><span class="line">    .takeUntil(dependOnSubject)</span><br><span class="line">    .subscribe(</span><br><span class="line">        <span class="keyword">on</span>Next: &#123; print(<span class="variable">$0</span>) &#125;,</span><br><span class="line">        <span class="keyword">on</span>Error: &#123;_ <span class="keyword">in</span> print(<span class="string">"Error"</span>) &#125;,</span><br><span class="line">        <span class="keyword">on</span>Completed: &#123; print(<span class="string">"Completed"</span>) &#125;</span><br><span class="line">    ).addDisposableTo(bag)</span><br><span class="line">    </span><br><span class="line">subject.<span class="keyword">on</span>Next(<span class="number">1</span>)</span><br><span class="line">subject.<span class="keyword">on</span>Next(<span class="number">2</span>)</span><br><span class="line">dependOnSubject.<span class="keyword">on</span>Next(())</span><br><span class="line">subject.<span class="keyword">on</span>Next(<span class="number">3</span>)</span><br><span class="line">subject.<span class="keyword">on</span>Next(<span class="number">4</span>)</span><br><span class="line">subject.<span class="keyword">on</span>Completed()</span><br><span class="line">//终端输出</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line">Completed</span><br></pre></td></tr></table></figure><hr><ul><li>为了同时订阅同个数据的不同信号量，节约开销，我们可以使用这个<code>.share()</code></li></ul><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">let object = Observable.of(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>).share()</span><br><span class="line"></span><br><span class="line">_ = object.subscribe(&#123; print($<span class="number">0</span> )&#125;)</span><br><span class="line">_ = object.subscribe(&#123; print($<span class="number">0</span> )&#125;)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;ul&gt;
&lt;li&gt;之前的文章中，介绍了RxSwift中，将之前传统的模式修改为更&lt;code&gt;Rx&lt;/code&gt;的模式，在转换的过程中，我们会发现，其实&lt;code&gt;RxSwift&lt;/code&gt;只是将之前分散处理的恭喜，收拢起来，之前我们或许关心的是&lt;code&gt;block的回调&lt;/code&gt;、&lt;code&gt;代理方法&lt;/code&gt;、&lt;code&gt;function()调用&lt;/code&gt;，而现在我们或许只需要关心一件事情&lt;code&gt;信号量&lt;/code&gt;，可想而知，伴随着项目的庞大、功能的复杂，整个项目中充斥着的都是这些信号，此时我们就要学会分析、过滤、转化信号。&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="日志" scheme="http://www.ghcoder.com/categories/%E6%97%A5%E5%BF%97/"/>
    
    
      <category term="Swift" scheme="http://www.ghcoder.com/tags/Swift/"/>
    
  </entry>
  
  <entry>
    <title>实际项目中从传统模式切换为RxSwift模式</title>
    <link href="http://www.ghcoder.com/2017/10/05/20171005/"/>
    <id>http://www.ghcoder.com/2017/10/05/20171005/</id>
    <published>2017-10-05T05:57:12.000Z</published>
    <updated>2017-10-05T10:51:56.081Z</updated>
    
    <content type="html"><![CDATA[<ul><li><p>举一个简单的例子，来实现RxSwift的功能：</p></li><li><p>列表Controller里面的代码:</p></li></ul><a id="more"></a><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestRxSwiftViewController</span>: <span class="title">UIViewController</span>, <span class="title">UITableViewDataSource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> datas = [<span class="type">TestRxSwiftItemObject</span>]()</span><br><span class="line">    <span class="meta">@IBOutlet</span> <span class="keyword">weak</span> <span class="keyword">var</span> <span class="type">ItemTableview</span>: <span class="type">UITableView</span>!</span><br><span class="line"></span><br><span class="line">    <span class="comment">// MARK: -- Life Cycle</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line"></span><br><span class="line">        loadDatas()</span><br><span class="line">        <span class="type">ItemTableview</span>.reloadData()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">prepare</span><span class="params">(<span class="keyword">for</span> segue: UIStoryboardSegue, sender: <span class="keyword">Any</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> segue.identifier == <span class="string">"testRx"</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> detail: <span class="type">TestRxSwiftDetailViewController</span> = segue.destination <span class="keyword">as</span>! <span class="type">TestRxSwiftDetailViewController</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> index = <span class="type">ItemTableview</span>.indexPath(<span class="keyword">for</span>: sender <span class="keyword">as</span>! <span class="type">UITableViewCell</span>) &#123;</span><br><span class="line">                detail.<span class="type">Item</span> = datas[index.row]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// MARK: -- Private Methods</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">loadDatas</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">1</span>..&lt;<span class="number">10</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> itemObject = <span class="type">TestRxSwiftItemObject</span>(name: <span class="string">"Index-\(i)"</span>, isClicked: i % <span class="number">2</span> == <span class="number">0</span> ? <span class="literal">true</span> : <span class="literal">false</span>)</span><br><span class="line">            datas.append(itemObject)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// MARK: -- UITableView DataSource</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(<span class="number">_</span> tableView: UITableView, numberOfRowsInSection section: Int)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> datas.<span class="built_in">count</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(<span class="number">_</span> tableView: UITableView, cellForRowAt indexPath: IndexPath)</span></span> -&gt; <span class="type">UITableViewCell</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> cell = tableView.dequeueReusableCell(withIdentifier: <span class="string">"cell"</span>, <span class="keyword">for</span>: indexPath)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> itemObject = datas[indexPath.row]</span><br><span class="line">        cell.textLabel?.text = itemObject.name</span><br><span class="line">        cell.accessoryType   = itemObject.isClicked ? .checkmark : .<span class="keyword">none</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> cell</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><ul><li>详情Controller里面的代码：</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestRxSwiftDetailViewController</span>: <span class="title">UIViewController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@IBOutlet</span> <span class="keyword">weak</span> <span class="keyword">var</span> content: <span class="type">UITextField</span>!</span><br><span class="line">    <span class="meta">@IBOutlet</span> <span class="keyword">weak</span> <span class="keyword">var</span> isOn: <span class="type">UISwitch</span>!</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> <span class="type">Item</span>: <span class="type">TestRxSwiftItemObject</span>?</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Do any additional setup after loading the view.</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="type">Item</span> = <span class="type">Item</span> &#123;</span><br><span class="line">            content.text = <span class="type">Item</span>.name</span><br><span class="line">            isOn.isOn    = <span class="type">Item</span>.isClicked</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><ul><li>切换为RxSwift的模式</li><li><ol><li>首先我们将我们在列表控制器里面的<code>Array</code>, 更换为可以订阅的变量，这里我们用<code>Variable</code>来代替:</li></ol></li></ul><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//之前</span><br><span class="line">var datas = [<span class="string">TestRxSwiftItemObject</span>](<span class="link"></span>)</span><br><span class="line">//之后</span><br><span class="line">var datas = Variable<span class="xml"><span class="tag">&lt;<span class="name">[TestRxSwiftItemObject]</span>&gt;</span></span>([])</span><br></pre></td></tr></table></figure><ul><li>并且将所有的去数据中的对象的方法切换一下：</li></ul><figure class="highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//之前</span></span><br><span class="line"><span class="keyword">let</span> itemObject = datas[indexPath.row]</span><br><span class="line"><span class="comment">//之后</span></span><br><span class="line"><span class="keyword">let</span> itemObject = datas.<span class="keyword">value</span>[indexPath.row]</span><br></pre></td></tr></table></figure><ul><li>然后我们只需要更加、删除数据，关于UI的切换，我们可以统一做处理，如下：</li><li>以为之前我们已经将<code>data</code>，切换为<code>Variable</code>了，这样我们可以通过调用<code>asObservable()</code>就可以改为可定于的订阅的对象，并且可以接受到回调。</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">_</span> = datas.asObservable().subscribe(</span><br><span class="line">    onNext: &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] todos <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">self</span>?.updateUI(todos: todos)</span><br><span class="line">    &#125;</span><br><span class="line">).addDisposableTo(bag)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">updateUI</span><span class="params">(todos: [TestRxSwiftItemObject])</span></span> &#123;</span><br><span class="line">    title = todos.isEmpty ? <span class="string">"Todos"</span> : <span class="string">"\(todos.count) Todos"</span></span><br><span class="line">    addBtn.isEnabled = todos.<span class="built_in">filter</span> &#123; !$<span class="number">0</span>.isClicked &#125;.<span class="built_in">count</span> &lt; <span class="number">6</span></span><br><span class="line"></span><br><span class="line">    <span class="type">ItemTableview</span>.reloadData()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>关于的数据的传递，涉及到两点，第一个：我们如何从首页数据传递给第二个控制器呢？<code>通过公开的属性传递</code>：</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">let detail: TestRxSwiftDetailViewController = segue<span class="selector-class">.destination</span> as! TestRxSwiftDetailViewController</span><br><span class="line"><span class="keyword">if</span> let index = ItemTableview.indexPath(<span class="keyword">for</span>: sender as! UITableViewCell) &#123;</span><br><span class="line">detail<span class="selector-class">.Item</span> = datas<span class="selector-class">.value</span>[index.row]</span><br></pre></td></tr></table></figure><ul><li>第二点我们如何将第二个控制器里面的属性回传给首页控制器呢？，我们在第二页控制器里公开出一个可以订阅的对象，这样我们只要在第二个控制前里面修改数据值，并且传递，就能再第一个控制器里面接收到回调了。这里有个两点：</li></ul><figure class="highlight golo"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fileprivate <span class="keyword">var</span> itemSubject = PublishSubject&lt;TestRxSwiftItemObject&gt;()</span><br><span class="line"><span class="keyword">var</span> item: <span class="keyword">Observable</span>&lt;TestRxSwiftItemObject&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> itemSubject.asObservable()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>首先定义的<code>fileprivate</code>,阻止了外部给这个变量发送数据。而仅仅只是给外部暴露了一个<code>item</code>的对像。</li><li>而在对象内部，我们依旧可以通过<code>itemSubject</code>来发送数据，并且外部也能够接受到回调。</li><li>点击保存，第二个页面<code>dismiss之前</code>，我执行如下的保存操作：</li></ul><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> let <span class="built_in">item</span> = Item &#123;</span><br><span class="line">    <span class="built_in">item</span>.<span class="built_in">name</span> = content.<span class="built_in">text</span>!</span><br><span class="line">    <span class="built_in">item</span>.isClicked = isOn.isOn</span><br><span class="line"></span><br><span class="line">    itemSubject.onNext(<span class="built_in">item</span>)</span><br><span class="line">    itemSubject.onCompleted()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>这样在首页我们就可以这样接受到回调了：</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> detail: <span class="type">TestRxSwiftDetailViewController</span> = segue.destination <span class="keyword">as</span>! <span class="type">TestRxSwiftDetailViewController</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> index = <span class="type">ItemTableview</span>.indexPath(<span class="keyword">for</span>: sender <span class="keyword">as</span>! <span class="type">UITableViewCell</span>) &#123;</span><br><span class="line">    detail.<span class="type">Item</span> = datas.value[index.row]</span><br><span class="line">    <span class="number">_</span> = detail.item.subscribe(</span><br><span class="line">        onNext: &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] newTodo <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">self</span>?.datas.value[index.row] = newTodo</span><br><span class="line">        &#125;,</span><br><span class="line">        onDisposed: &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Finishing changing item content"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>关于最后一点异步的回调操作，简单的来说，我们将之前返回值<code>Void</code>-&gt;<code>Observable&lt;Void&gt;</code>或者<code>URL</code>-&gt;<code>Observable&lt;URL&gt;</code>,Demo:</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">CustomError</span>: <span class="title">Error</span> </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> someOptionErrors</span><br><span class="line">    <span class="keyword">case</span> urlIsNullError</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">syncToSaveDatas</span><span class="params">()</span></span> -&gt; <span class="type">Observable</span>&lt;<span class="type">URL</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="type">Observable</span>.create &#123; observer <span class="keyword">in</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> testURL: <span class="type">URL</span>?</span><br><span class="line">        <span class="keyword">var</span> someOptions: <span class="type">Bool</span></span><br><span class="line"></span><br><span class="line">        testURL     = <span class="type">URL</span>(string: <span class="string">""</span>)</span><br><span class="line">        someOptions = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Error 1</span></span><br><span class="line">        <span class="keyword">guard</span> someOptions <span class="keyword">else</span> &#123;</span><br><span class="line">            observer.onError(<span class="type">CustomError</span>.someOptionErrors)</span><br><span class="line">            <span class="keyword">return</span> <span class="type">Disposables</span>.create()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> testURL = testURL &#123;</span><br><span class="line">            <span class="comment">// success</span></span><br><span class="line">            observer.onNext(testURL)</span><br><span class="line">            observer.onCompleted()</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Error 2</span></span><br><span class="line">            observer.onError(<span class="type">CustomError</span>.urlIsNullError)</span><br><span class="line">            <span class="keyword">return</span> <span class="type">Disposables</span>.create()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="type">Disposables</span>.create()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@IBAction</span> <span class="function"><span class="keyword">func</span> <span class="title">saveDatas</span><span class="params">(<span class="number">_</span> sender: <span class="keyword">Any</span>)</span></span> &#123;</span><br><span class="line">    <span class="number">_</span> = syncToSaveDatas().subscribe(</span><br><span class="line">        onNext: &#123; url <span class="keyword">in</span></span><br><span class="line">            <span class="built_in">print</span>(url)</span><br><span class="line">        &#125;,</span><br><span class="line">        onError: &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"error is \($0)"</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">        onCompleted: &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Success"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;ul&gt;
&lt;li&gt;&lt;p&gt;举一个简单的例子，来实现RxSwift的功能：&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;列表Controller里面的代码:&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="日志" scheme="http://www.ghcoder.com/categories/%E6%97%A5%E5%BF%97/"/>
    
    
      <category term="Swift" scheme="http://www.ghcoder.com/tags/Swift/"/>
    
  </entry>
  
  <entry>
    <title>学习RxSwift</title>
    <link href="http://www.ghcoder.com/2017/10/03/20171003/"/>
    <id>http://www.ghcoder.com/2017/10/03/20171003/</id>
    <published>2017-10-03T03:57:12.000Z</published>
    <updated>2017-10-03T13:06:48.967Z</updated>
    
    <content type="html"><![CDATA[<ul><li>创建可以订阅的对象，在RxSwift中称之为<code>Observable</code>,我们可以通过系统介绍给我的方法来创建(我们称之为Operators)。</li></ul><a id="more"></a><hr><ul><li>这里我们通过<code>Create</code>的<code>Operators</code>的方法来创建，先看一下官网[<a href="http://reactivex.io/documentation/operators/create.html]" target="_blank" rel="noopener">http://reactivex.io/documentation/operators/create.html]</a> 的介绍:</li></ul><blockquote><p>You can create an Observable from scratch by using the Create operator. You pass this operator a function that accepts the observer as its parameter. Write this function so that it behaves as an Observable — by calling the observer’s onNext, onError, and onCompleted methods appropriately.<br>A well-formed finite Observable must attempt to call either the observer’s onCompleted method exactly once or its onError method exactly once, and must not thereafter attempt to call any of the observer’s other methods.</p></blockquote><ul><li>再看一下<code>github</code>上源码：</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Observable</span> </span>&#123;</span><br><span class="line">    <span class="comment">// MARK: create</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     Creates an observable sequence from a specified subscribe method implementation.</span></span><br><span class="line"><span class="comment">     - seealso: [create operator on reactivex.io](http://reactivex.io/documentation/operators/create.html)</span></span><br><span class="line"><span class="comment">     - parameter subscribe: Implementation of the resulting observable sequence's `subscribe` method.</span></span><br><span class="line"><span class="comment">     - returns: The observable sequence with the specified implementation for the `subscribe` method.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">create</span><span class="params">(<span class="number">_</span> subscribe: @escaping <span class="params">(AnyObserver&lt;E&gt;)</span></span></span> -&gt; <span class="type">Disposable</span>) -&gt; <span class="type">Observable</span>&lt;<span class="type">E</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">AnonymousObservable</span>(subscribe)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>按照官网的介绍，我们就可以通过<code>Create</code>来创建一个可被订阅的对象，这个对象的入参是一个block，任意对象的<code>Observer</code>,他可以发送<code>.onNext()/.onComplete()/.onError()</code></li><li>第二段的注释的意思，就是这个<code>Observer</code>可以发送<code>.onNext()</code>,但是这个对象一旦发送了一次<code>.onComplete()</code>或者<code>.onError()</code>,然后就不能尝试调用任何观察者的其他方法了。看一下Demo：</li></ul><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">enum CustomeError: Error &#123;</span><br><span class="line">    case somethingError</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">let customOB = Observable<span class="variable">&lt;Int&gt;</span>.create &#123; observer <span class="keyword">in</span></span><br><span class="line"></span><br><span class="line">observer.<span class="keyword">on</span>Next(<span class="number">1</span>)</span><br><span class="line">observer.<span class="keyword">on</span>Next(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">//observer.<span class="keyword">on</span>Error(CustomeError.somethingError)</span><br><span class="line"></span><br><span class="line">observer.<span class="keyword">on</span>Completed()</span><br><span class="line"></span><br><span class="line">return  Disposables.create()</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">let disposeBag1 = DisposeBag()</span><br><span class="line">customOB.subscribe(</span><br><span class="line">    <span class="keyword">on</span>Next: &#123; print(<span class="variable">$0</span>) &#125;,</span><br><span class="line">    <span class="keyword">on</span>Error: &#123; print(<span class="variable">$0</span>) &#125;,</span><br><span class="line">    <span class="keyword">on</span>Completed: &#123; print(<span class="string">"onCompleted"</span>) &#125;,</span><br><span class="line">    <span class="keyword">on</span>Disposed: &#123; print(<span class="string">"onDisposed"</span>) &#125;</span><br><span class="line">).addDisposableTo(disposeBag1)</span><br></pre></td></tr></table></figure><ul><li>这创建的依旧是一个<code>Observer</code>的对象，也可以调用其他的<code>Operator</code>,这里为了方便的调试，我们可以使用<code>.debug()</code>。使用如下：</li></ul><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> disposeBag1 = DisposeBag()</span><br><span class="line">customOB</span><br><span class="line">.<span class="keyword">debug</span>()</span><br><span class="line">.subscribe(</span><br><span class="line">    onNex<span class="variable">t:</span> &#123; <span class="keyword">print</span>($<span class="number">0</span>) &#125;,</span><br><span class="line">    onError: &#123; <span class="keyword">print</span>($<span class="number">0</span>) &#125;,</span><br><span class="line">    onCompleted: &#123; <span class="keyword">print</span>(<span class="string">"onCompleted"</span>) &#125;,</span><br><span class="line">    onDisposed: &#123; <span class="keyword">print</span>(<span class="string">"onDisposed"</span>) &#125;</span><br><span class="line">).addDisposableTo(disposeBag1)</span><br><span class="line"></span><br><span class="line">// 控制台的打印信息如下：</span><br><span class="line"><span class="number">2017</span>-<span class="number">10</span>-<span class="number">03</span> <span class="number">13</span>:<span class="number">58</span>:<span class="number">23.488</span>: ViewController.swif<span class="variable">t:35</span> (viewDidLoad()) -&gt; subscribed</span><br><span class="line"><span class="number">2017</span>-<span class="number">10</span>-<span class="number">03</span> <span class="number">13</span>:<span class="number">58</span>:<span class="number">23.493</span>: ViewController.swif<span class="variable">t:35</span> (viewDidLoad()) -&gt; Event <span class="keyword">next</span>(<span class="number">1</span>)</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">10</span>-<span class="number">03</span> <span class="number">13</span>:<span class="number">58</span>:<span class="number">23.493</span>: ViewController.swif<span class="variable">t:35</span> (viewDidLoad()) -&gt; Event <span class="keyword">next</span>(<span class="number">2</span>)</span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">10</span>-<span class="number">03</span> <span class="number">13</span>:<span class="number">58</span>:<span class="number">23.493</span>: ViewController.swif<span class="variable">t:35</span> (viewDidLoad()) -&gt; Event completed</span><br><span class="line">onCompleted</span><br><span class="line">onDisposed</span><br><span class="line"><span class="number">2017</span>-<span class="number">10</span>-<span class="number">03</span> <span class="number">13</span>:<span class="number">58</span>:<span class="number">23.493</span>: ViewController.swif<span class="variable">t:35</span> (viewDidLoad()) -&gt; isDisposed</span><br></pre></td></tr></table></figure><ul><li>在我们真是的项目中，我们可能需要不仅仅是一个订阅者或者发布者，我们需要的是一个不仅可以订阅、也可以发布的对象，在<code>RxSwift</code>中，我们称之为<code>Subjects</code>:</li></ul><hr><ul><li>首选我们要说的<code>Subjects</code>对象叫做<code>PublishSubject</code>,看一下github上的源码：</li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Represents an object that is both an observable sequence as well as an observer.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// Each notification is broadcasted to all subscribed observers.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PublishSubject</span>&lt;<span class="type">Element</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>再看官网上对<code>PublishSubject</code>对象的介绍：</li></ul><blockquote><p>PublishSubject emits to an observer only those items that are emitted by the source Observable(s) subsequent to the time of the subscription.</p></blockquote><blockquote><p>Note that a PublishSubject may begin emitting items immediately upon creation (unless you have taken steps to prevent this), and so there is a risk that one or more items may be lost between the time the Subject is created and the observer subscribes to it. If you need to guarantee delivery of all items from the source Observable, you’ll need either to form that Observable with Create so that you can manually reintroduce “cold” Observable behavior (checking to see that all observers have subscribed before beginning to emit items), or switch to using a ReplaySubject instead.</p></blockquote><blockquote><p>If the source Observable terminates with an error, the PublishSubject will not emit any items to subsequent observers, but will simply pass along the error notification from the source Observable.</p></blockquote><ul><li><em>只有先订阅消息，再发送消息，才能接受到消息</em></li><li>首先可以看出来，这个对象是<code>Cold Sign</code>,这里所谓的<code>Cold</code>，就代表，当创建完这个对象的时候，并不会立刻发送数据，而只有在有订阅者订阅它的时候，它才会发送数据。</li><li>而这里还有一点很重要的是，<em>PublishSubject只能够订阅在它之后发送的数据</em>，这一点也就是说，在这个订阅消息之前，不管我们发送了多少数据，在真正订阅之后，这些之前订阅的数据是不会发送的。</li><li>并且在约到失败的时候，这个对象就将被终止，除了在回调的<code>.onError()</code>方法之外，以后所有的数据都将无法接受。看一下Demo：</li></ul><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">let subject = PublishSubject<span class="variable">&lt;String&gt;</span>()</span><br><span class="line"></span><br><span class="line">subject.<span class="keyword">on</span>Next(<span class="string">"Test1"</span>)</span><br><span class="line">subject.<span class="keyword">on</span>Next(<span class="string">"Test2"</span>)</span><br><span class="line"></span><br><span class="line">let sub1 = subject.subscribe(</span><br><span class="line">    <span class="keyword">on</span>Next: &#123; print(<span class="string">"1:) \($0)"</span>)&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">subject.<span class="keyword">on</span>Next(<span class="string">"Test3"</span>)</span><br><span class="line"></span><br><span class="line">subject.<span class="keyword">on</span>Next(<span class="string">"Test4"</span>)</span><br><span class="line"></span><br><span class="line">sub1.dispose()</span><br><span class="line"></span><br><span class="line">subject.<span class="keyword">on</span>Next(<span class="string">"Test5"</span>)</span><br><span class="line"></span><br><span class="line">let sub2 = subject.subscribe(</span><br><span class="line">    <span class="keyword">on</span>Next: &#123; print(<span class="string">"2:) \($0)"</span>)&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">subject.<span class="keyword">on</span>Next(<span class="string">"Test6"</span>)</span><br><span class="line">subject.<span class="keyword">on</span>Next(<span class="string">"Test7"</span>)</span><br><span class="line"></span><br><span class="line">sub2.dispose()</span><br><span class="line"></span><br><span class="line">// 终端输出为</span><br><span class="line"><span class="number">1</span>:) Test3</span><br><span class="line"><span class="number">1</span>:) Test4</span><br><span class="line"><span class="number">2</span>:) Test6</span><br><span class="line"><span class="number">2</span>:) Test7</span><br></pre></td></tr></table></figure><hr><ul><li>第二种同时即可以订阅，也可以发送消息的对象，我们这里叫做<code>BehaviorSubject</code>。这里我们先看一下github中代码:</li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Represents a value that changes over time.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// Observers can subscribe to the subject to receive the last (or initial) value and all subsequent notifications.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BehaviorSubject</span>&lt;<span class="type">Element</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>再看一下官网上的介绍：</li></ul><blockquote><p>When an observer subscribes to a BehaviorSubject, it begins by emitting the item most recently emitted by the source Observable (or a seed/default value if none has yet been emitted) and then continues to emit any other items emitted later by the source Observable(s).</p><p>However, if the source Observable terminates with an error, the BehaviorSubject will not emit any items to subsequent observers, but will simply pass along the error notification from the source Observable.</p></blockquote><ul><li>看到注释以及代码的意思，这种<code>Subject</code>的对象的特点就是，<em>订阅这种对象，它就可以接收到最近的一次值或者是初始化的默认值</em></li><li>同样，这个<code>Subject</code>的对象，，一旦接受到<code>.onError()</code>或者<code>.onComplete()</code>, 这个对象将不会再发送任何值了。看一下Demo：</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">let</span> <span class="string">subject</span> <span class="string">=</span> <span class="string">BehaviorSubject&lt;String&gt;(value:</span> <span class="string">"Default Value"</span><span class="string">)</span></span><br><span class="line"></span><br><span class="line"><span class="string">let</span> <span class="string">sub1</span> <span class="string">=</span> <span class="string">subject.subscribe(</span></span><br><span class="line"><span class="attr">    onNext:</span> <span class="string">&#123;</span> <span class="string">print("From1:\($0)")</span> <span class="string">&#125;</span></span><br><span class="line"><span class="string">)</span></span><br><span class="line"></span><br><span class="line"><span class="string">subject.onNext("Test1")</span></span><br><span class="line"></span><br><span class="line"><span class="string">sub1.dispose()</span></span><br><span class="line"></span><br><span class="line"><span class="string">let</span> <span class="string">sub2</span> <span class="string">=</span> <span class="string">subject.subscribe(</span></span><br><span class="line"><span class="attr">    onNext:</span> <span class="string">&#123;print("From2:\($0)")&#125;</span></span><br><span class="line"><span class="string">)</span></span><br><span class="line"></span><br><span class="line"><span class="string">subject.onNext("Test2")</span></span><br><span class="line"><span class="string">subject.onNext("Test3")</span></span><br><span class="line"></span><br><span class="line"><span class="string">sub2.dispose()</span></span><br><span class="line"></span><br><span class="line"><span class="string">//</span> <span class="string">终端输出</span></span><br><span class="line"><span class="attr">From1:</span><span class="string">Default</span> <span class="string">Value</span></span><br><span class="line"><span class="attr">From1:</span><span class="string">Test1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">From2:</span><span class="string">Test1</span></span><br><span class="line"><span class="attr">From2:</span><span class="string">Test2</span></span><br><span class="line"><span class="attr">From2:</span><span class="string">Test3</span></span><br></pre></td></tr></table></figure><hr><ul><li>这里可以通过<code>BehaviorSubject</code>可以查看最近一次发送数据，如果是第一次，就会接受到默认的数据，但是如果我们想要接受指定数目的历史数据，我们可以使用另外一种subject，我们叫做：<code>ReplaySubject</code>.</li><li>看一下github上代码的：</li></ul><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/// Each notification <span class="keyword">is</span> broadcasted <span class="keyword">to</span> <span class="keyword">all</span> subscribed <span class="built_in">and</span> future observers, subject <span class="keyword">to</span> <span class="keyword">buffer</span> trimming policies.</span><br><span class="line">public class ReplaySubject<span class="symbol">&lt;Element&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>ReplaySubject emits to any observer all of the items that were emitted by the source Observable(s), regardless of when the observer subscribes.</p></blockquote><blockquote><p>There are also versions of ReplaySubject that will throw away old items once the replay buffer threatens to grow beyond a certain size, or when a specified timespan has passed since the items were originally emitted.</p></blockquote><blockquote><p>If you use a ReplaySubject as an observer, take care not to call its onNext method (or its other on methods) from multiple threads, as this could lead to coincident (non-sequential) calls, which violates the Observable contract and creates an ambiguity in the resulting Subject as to which item or notification should be replayed first.</p></blockquote><ul><li><em>ReplaySubject对象不能初始化默认值、并且每次打印历史数据的值是可以控制的</em>，看一下Demo：</li></ul><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> subject = ReplaySubject&lt;String&gt;.create(bufferSize: <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> sub1 = subject.subscribe(</span><br><span class="line">    onNext: &#123; print(<span class="string">"From 1:| \($0)"</span>)&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">subject.onNext(<span class="string">"Test1"</span>)</span><br><span class="line">subject.onNext(<span class="string">"Test2"</span>)</span><br><span class="line">subject.onNext(<span class="string">"Test3"</span>)</span><br><span class="line"></span><br><span class="line">sub1.dispose()</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> sub2 = subject.subscribe(</span><br><span class="line">    onNext: &#123; print(<span class="string">"From 2:| \($0)"</span>)&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">subject.onNext(<span class="string">"Test4"</span>)</span><br><span class="line"></span><br><span class="line">sub2.dispose()</span><br><span class="line"></span><br><span class="line">// 终端输出</span><br><span class="line"><span class="keyword">From</span> <span class="number">1</span>:| <span class="type">Test1</span></span><br><span class="line"><span class="keyword">From</span> <span class="number">1</span>:| <span class="type">Test2</span></span><br><span class="line"><span class="keyword">From</span> <span class="number">1</span>:| <span class="type">Test3</span></span><br><span class="line"><span class="keyword">From</span> <span class="number">2</span>:| <span class="type">Test2</span></span><br><span class="line"><span class="keyword">From</span> <span class="number">2</span>:| <span class="type">Test3</span></span><br><span class="line"><span class="keyword">From</span> <span class="number">2</span>:| <span class="type">Test4</span></span><br></pre></td></tr></table></figure><hr><ul><li>第三种<code>Subjects</code>, 我们叫做<code>Variable</code>, 看一下github上的注释:</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/// Variable is a wrapper for `BehaviorSubject`.</span><br><span class="line">///</span><br><span class="line">/// Unlike `BehaviorSubject` it can't terminate <span class="keyword">with</span> <span class="keyword">error</span>, <span class="keyword">and</span> <span class="keyword">when</span> <span class="keyword">variable</span> <span class="keyword">is</span> deallocated</span><br><span class="line">/// it will <span class="keyword">complete</span> its observable <span class="keyword">sequence</span> (<span class="string">`asObservable`</span>).</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="keyword">Variable</span>&lt;<span class="keyword">Element</span>&gt; &#123;</span><br></pre></td></tr></table></figure><ul><li>特点：<em>1.这个对象是对BehaviorSubject的上层封装。2.对象不能通过发送Error而终止对象发送数据。3.通过调用asObservable，可以转化为Observer对象。</em> Demo:</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">let subject = Variable(<span class="string">"Test1"</span>)</span><br><span class="line"></span><br><span class="line">let _ = subject.asObservable().subscribe(</span><br><span class="line">    onNext: &#123;print(<span class="string">"1:\($0)"</span>)&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">subject<span class="selector-class">.value</span> = <span class="string">"Changed"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(subject.value)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 终端输出</span></span><br><span class="line"><span class="number">1</span>:Test1</span><br><span class="line"><span class="number">1</span>:Changed</span><br><span class="line">Changed</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;ul&gt;
&lt;li&gt;创建可以订阅的对象，在RxSwift中称之为&lt;code&gt;Observable&lt;/code&gt;,我们可以通过系统介绍给我的方法来创建(我们称之为Operators)。&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="日志" scheme="http://www.ghcoder.com/categories/%E6%97%A5%E5%BF%97/"/>
    
    
      <category term="Swift" scheme="http://www.ghcoder.com/tags/Swift/"/>
    
  </entry>
  
  <entry>
    <title>学习Swift Tips(三)</title>
    <link href="http://www.ghcoder.com/2017/09/14/20170914/"/>
    <id>http://www.ghcoder.com/2017/09/14/20170914/</id>
    <published>2017-09-14T06:51:12.000Z</published>
    <updated>2017-09-15T08:09:45.000Z</updated>
    
    <content type="html"><![CDATA[<ul><li><code>final</code>修饰的<code>class</code>/<code>func</code>/<code>var</code>,表示内容不允许进行继承或者重写</li></ul><hr><ul><li><code>lazy</code>简单赋值：<code>lazy var str1: String = &quot;Hello&quot;</code></li><li><code>lazy</code>计算赋值：</li></ul><a id="more"></a><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">lazy var <span class="built_in">str</span>: <span class="keyword">String</span> = &#123;</span><br><span class="line"></span><br><span class="line">      let <span class="built_in">str</span> = <span class="string">"Hello"</span></span><br><span class="line">      <span class="built_in">print</span>(<span class="string">"只有首次访问输出"</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line">  &#125;()</span><br></pre></td></tr></table></figure><ul><li><code>lazy</code>用在一些<code>map</code>/<code>filter</code>：</li></ul><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> result = data.lazy.map &#123;</span><br><span class="line">    <span class="function"><span class="params">(i: Int)</span> -&gt;</span> Int <span class="keyword">in</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"正在处理 \(i)"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> i * <span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><ul><li>Swift 中的镜像以及反射的问题：我们可以通过<code>Mirror</code>来实现：</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> xiaoming = <span class="type">Person</span>(name: <span class="string">"XiaoMing"</span>, age: <span class="number">16</span>)</span><br><span class="line"><span class="keyword">let</span> r = <span class="type">Mirror</span>(reflecting: xiaoming)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> name = valueFrom(xiaoming, key: <span class="string">"name"</span>) <span class="keyword">as</span>? <span class="type">String</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"通过key 得到值:\(name)"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">dump</span>(xiaoming)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"xiaoming 是\(r.displayStyle!)"</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"属性个数:\(r.children.count)"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> child <span class="keyword">in</span> r.children &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"属性名:\(String(describing: child.label)),值:\(child.value)"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">valueFrom</span><span class="params">(<span class="number">_</span> object: <span class="keyword">Any</span>, key: String)</span></span> -&gt; <span class="type">Any</span>? &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> mirror = <span class="type">Mirror</span>(reflecting: object)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> child <span class="keyword">in</span> mirror.children &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> (targetKey, targetMirror) = (child.label, child.value)</span><br><span class="line">        <span class="keyword">if</span> key == targetKey &#123;</span><br><span class="line">            <span class="keyword">return</span> targetMirror</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><ul><li>隐式解包并不能确保属性一定有值，或者一定安全，而是在获取属性值的时候，自动强制解包，如果该值是<code>nil</code>的话，在调用的时候，也是会crash的。</li></ul><hr><ul><li>optional定义其实就是个枚举：</li></ul><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> aNil: <span class="keyword">String</span>? = nil</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> anotherNil: <span class="keyword">String</span>?? = aNil</span><br><span class="line"><span class="keyword">let</span> literalNil: <span class="keyword">String</span>?? = nil</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> _ = anotherNil &#123;</span><br><span class="line">    <span class="keyword">print</span>(<span class="string">"anotherNil"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> _ = literalNil &#123;</span><br><span class="line">    <span class="keyword">print</span>(<span class="string">"literalNil"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>打印<code>optional</code>可以通过<code>fr v -R xxx</code></li></ul><hr><ul><li><code>map</code>的使用，我见的最多的就是在数组等集合中的<code>map</code>使用，先来看一下<code>map</code>的定义:</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Returns an array containing the results of mapping the given closure</span></span><br><span class="line"><span class="comment">/// over the sequence's elements.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// In this example, `map` is used first to convert the names in the array</span></span><br><span class="line"><span class="comment">/// to lowercase strings and then to count their characters.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">///     let cast = ["Vivien", "Marlon", "Kim", "Karl"]</span></span><br><span class="line"><span class="comment">///     let lowercaseNames = cast.map &#123; $0.lowercaseString &#125;</span></span><br><span class="line"><span class="comment">///     // 'lowercaseNames' == ["vivien", "marlon", "kim", "karl"]</span></span><br><span class="line"><span class="comment">///     let letterCounts = cast.map &#123; $0.characters.count &#125;</span></span><br><span class="line"><span class="comment">///     // 'letterCounts' == [6, 6, 3, 4]</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// - Parameter transform: A mapping closure. `transform` accepts an</span></span><br><span class="line"><span class="comment">///   element of this sequence as its parameter and returns a transformed</span></span><br><span class="line"><span class="comment">///   value of the same or of a different type.</span></span><br><span class="line"><span class="comment">/// - Returns: An array containing the transformed elements of this</span></span><br><span class="line"><span class="comment">///   sequence.</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">map</span>&lt;T&gt;<span class="params">(<span class="number">_</span> transform: <span class="params">(Element)</span></span></span> <span class="keyword">throws</span> -&gt; <span class="type">T</span>) <span class="keyword">rethrows</span> -&gt; [<span class="type">T</span>]</span><br></pre></td></tr></table></figure><ul><li>清晰明了，这里定义的泛型为T, 函数内部的block，将另外一种泛型Element转化为T，最后还是生成一个[T]类型的数组。</li><li>除了数组的map外，这里作者还说了一下<code>Optional</code>的<code>map</code>行数，效果一样：</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Evaluates the given closure when this `Optional` instance is not `nil`,</span></span><br><span class="line"><span class="comment">/// passing the unwrapped value as a parameter.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// Use the `map` method with a closure that returns a nonoptional value.</span></span><br><span class="line"><span class="comment">/// This example performs an arithmetic operation on an</span></span><br><span class="line"><span class="comment">/// optional integer.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">///     let possibleNumber: Int? = Int("42")</span></span><br><span class="line"><span class="comment">///     let possibleSquare = possibleNumber.map &#123; $0 * $0 &#125;</span></span><br><span class="line"><span class="comment">///     print(possibleSquare)</span></span><br><span class="line"><span class="comment">///     // Prints "Optional(1746)"</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">///     let noNumber: Int? = nil</span></span><br><span class="line"><span class="comment">///     let noSquare = noNumber.map &#123; $0 * $0 &#125;</span></span><br><span class="line"><span class="comment">///     print(noSquare)</span></span><br><span class="line"><span class="comment">///     // Prints "nil"</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// - Parameter transform: A closure that takes the unwrapped value</span></span><br><span class="line"><span class="comment">///   of the instance.</span></span><br><span class="line"><span class="comment">/// - Returns: The result of the given closure. If this instance is `nil`,</span></span><br><span class="line"><span class="comment">///   returns `nil`.</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">map</span>&lt;U&gt;<span class="params">(<span class="number">_</span> transform: <span class="params">(Wrapped)</span></span></span> <span class="keyword">throws</span> -&gt; <span class="type">U</span>) <span class="keyword">rethrows</span> -&gt; <span class="type">U</span>?</span><br><span class="line"></span><br><span class="line"><span class="comment">// 例子如下：</span></span><br><span class="line"><span class="keyword">let</span> num: <span class="type">Int</span>? = <span class="number">3</span></span><br><span class="line"><span class="keyword">let</span> result = num.<span class="built_in">map</span> &#123;</span><br><span class="line">    $<span class="number">0</span> * <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(result) <span class="comment">// Optional(6)</span></span><br></pre></td></tr></table></figure><hr><ul><li><code>protocol</code>的<code>extension</code>的功能，为协议完成了方法的默认实现。这也，即使遵循了协议，你也可以不用写任何实现的代码。</li><li>如果类型推断是实际的类型： 如果类型中没有实现，就会调用拓展中的方法实现。</li><li>如果类型推断的是协议：1. 如果在协议中定义过，如果类型中没有实现，那就调用拓展中的实现。 2.如果在协议中没用定义过的话，拓展中的方法默认会被调用。</li></ul><hr><ul><li><code>where</code>字段的使用，目前已经不能再<code>if</code>/<code>guard</code>中使用<code>where</code>,但是在<code>swich</code>/<code>foreach</code>/<code>for</code>循环中，我们还是可以使用的。</li></ul><hr><ul><li><p>对于如果需要在<code>enum</code>中循环需要嵌套定义的话，这里我需要用的<code>indirect</code>,例如这样我们就可以这样定义一个单向连边的结构了：</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">indirect</span> <span class="class"><span class="keyword">enum</span> <span class="title">LinkedList</span>&lt;<span class="title">Element</span>: <span class="title">Comparable</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">case</span> empty</span><br><span class="line">   <span class="keyword">case</span> node(<span class="type">Element</span>, <span class="type">LinkedList</span>&lt;<span class="type">Element</span>&gt;)</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 删除链表中某个元素</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">removing</span><span class="params">(<span class="number">_</span> element: Element)</span></span> -&gt; <span class="type">LinkedList</span>&lt;<span class="type">Element</span>&gt; &#123;</span><br><span class="line">   <span class="keyword">guard</span> <span class="keyword">case</span> <span class="keyword">let</span> .node(value, next) = <span class="keyword">self</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> .empty &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> value == element ? next : <span class="type">LinkedList</span>.node(value, next.removing(element))</span><br><span class="line">&#125;    </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> linkedList = <span class="type">LinkedList</span>.node(<span class="number">1</span>, .node(<span class="number">2</span>, .node(<span class="number">3</span>, .node(<span class="number">4</span>, .empty))))</span><br><span class="line">  <span class="keyword">let</span> result = linkedList.removing(<span class="number">2</span>)</span><br><span class="line">  <span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure></li></ul><hr><ul><li><p>在<code>Object-c</code>中，返回<code>SEL</code>，我们会直接调用<code>@selector</code>，但是在<code>Swift</code>中我们已经不能这样调用了，我们需要用到一个字段<code>#selector</code>,使用方法类似：</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">func</span> <span class="title">callMe</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">func</span> <span class="title">callMeWithParam</span><span class="params">(obj: AnyObject!)</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">func</span> <span class="title">turn</span><span class="params">(by angle: Int, speed: Int)</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> someMethod = #selector(callMe)</span><br><span class="line"><span class="keyword">let</span> anotherMethod = #selector(callMeWithParam)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> method = #selector(turn)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果名字相同，我们这里需要定义类型：</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> method11 = #selector(comonFunc <span class="keyword">as</span> () -&gt;())</span><br><span class="line"><span class="keyword">let</span> method22 = #selector(commonFunc(input:) <span class="keyword">as</span> (<span class="type">Int</span>) -&gt; <span class="type">Int</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">func</span> <span class="title">comonFunc</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">func</span> <span class="title">commonFunc</span><span class="params">(input: Int)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">     <span class="keyword">return</span> input</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li></ul><hr><ul><li>实例化方法的动态调用：1.通过类获取方法，2.再传入实例得到方法，3.在根据情况传入参数</li></ul><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> MyClass <span class="comment">&#123;</span></span><br><span class="line"><span class="comment">    func method(number: Int) -&gt; Int &#123;</span></span><br><span class="line"><span class="comment">        return number + 1</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> func <span class="function"><span class="keyword">method</span><span class="params">(number: Int)</span> -&gt; <span class="title">Int</span> <span class="comment">&#123;</span></span></span><br><span class="line"><span class="function"><span class="comment">        return number</span></span></span><br><span class="line"><span class="function"><span class="comment">    &#125;</span></span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">let</span> <span class="title">f</span> = <span class="title">MyClass</span>.<span class="title">method</span></span></span><br><span class="line"><span class="function"><span class="title">let</span> <span class="title">object</span> = <span class="title">MyClass</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">let</span> <span class="title">result</span> = <span class="title">f</span><span class="params">(object)</span><span class="params">(1)</span></span></span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(<span class="keyword">result</span>)</span></span></span><br></pre></td></tr></table></figure><ul><li>如果存在相同名字的函数，可以显示定义类型来区分:</li></ul><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> f1 = MyClass.method</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> f2: <span class="function"><span class="params">(Int)</span> -&gt;</span> Int = MyClass.method</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> f3: <span class="function"><span class="params">(MyClass)</span> -&gt;</span> <span class="function"><span class="params">(Int)</span> -&gt;</span> Int = MyClass.method</span><br></pre></td></tr></table></figure><hr><ul><li>单例：</li></ul><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Manager</span> &#123;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">let</span> shared = Manager()</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">init</span>(<span class="params"></span>)</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><ul><li>自定义编译符号，在<code>Build Settings</code>中，找到<code>Swift Compiler - Custom Flag</code>,并且在<code>Other Swift Flags</code>中加上<code>-D FREE_VERSION</code></li></ul><hr><ul><li>编译符号： <code>// MARK:</code>、<code>// TODO:</code>、<code>// FIXME:</code></li></ul><hr><ul><li>app入口文件，这里默认创建app的时候，项目会自动为我们创建main的文件，在<code>swift</code>中，系统自动创建<code>@UIApplicationMain</code>,代表系统会自动将这个类标记为启动文件，但是这里我们可以通过如下的方法，可以将启动的文件指定为我们自定义的类，也可以将事件的接受者指定为我们想要的文件类：</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个main.swift 的文件</span></span><br><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span>: <span class="title">UIApplication</span> </span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">sendEvent</span><span class="params">(<span class="number">_</span> event: UIEvent)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.sendEvent(event)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Event sent: \(event)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">UIApplicationMain</span>(</span><br><span class="line">    <span class="type">CommandLine</span>.argc,</span><br><span class="line">    <span class="type">UnsafeMutableRawPointer</span>(<span class="type">CommandLine</span>.unsafeArgv)</span><br><span class="line">        .bindMemory(</span><br><span class="line">            to: <span class="type">UnsafeMutablePointer</span>&lt;<span class="type">Int8</span>&gt;.<span class="keyword">self</span>,</span><br><span class="line">            capacity: <span class="type">Int</span>(<span class="type">CommandLine</span>.argc)),</span><br><span class="line">    <span class="literal">nil</span>,</span><br><span class="line">    <span class="type">NSStringFromClass</span>(<span class="type">AppDelegate</span>.<span class="keyword">self</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure><hr><ul><li>在<code>Swift</code>中的协议默认都是必须要实现的，但是如果用在<code>Object-c</code>中，协议的方法是可选的，我们可以这样实现：</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@objc</span> <span class="class"><span class="keyword">protocol</span> <span class="title">OptionalProtocol</span> </span>&#123;</span><br><span class="line">    <span class="meta">@objc</span> <span class="keyword">optional</span> <span class="function"><span class="keyword">func</span> <span class="title">optionalMethod</span><span class="params">()</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>但是有了<code>Protocol Extension</code>，我也可以以<code>Swift</code>的方式来实现,对于<code>OC</code>中可选的协议方法，我们可以通过写protocol extension 来实现可选的功能。</li></ul><hr><ul><li><code>Swift</code>中的<code>unowned</code>和以前的<code>unsafe_unretained</code>: 即使它原来引用的内容已经被释放了，它仍然会保持对被释放对象的一个无效引用，它不是optional值，也不能被指向nil,如果调用属性或者方法的时候就会crash。作者建议:</li><li>如果确定在访问的时候，不会被释放的话，就使用<code>unowned</code>，如果存在释放的可能，那就用<code>weak</code></li></ul><hr><ul><li>在<code>swift</code>中，<code>Int</code>/<code>Bool</code>/<code>String</code>/<code>Array</code>/<code>Dictionary</code>都是值类型。</li><li>这些类型只是在简单的赋值的时候，在物理内存上都是同一个东西。</li><li>而当发生一个数据改变的时候，他们的内存地址才会发生变化。</li><li>值类型在赋值的时候，会将储存其中的值类型一并进行复制，而对其中的引用类型，则只是复制了一份引用。</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">let myObject = MyObject()</span><br><span class="line">let <span class="selector-tag">a</span> = [myObject]</span><br><span class="line"><span class="selector-tag">var</span> <span class="selector-tag">b</span> = a</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">b</span>.append(myObject)</span><br><span class="line"></span><br><span class="line">myObject<span class="selector-class">.number</span> = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(b[<span class="number">0</span>].number)</span></span> <span class="comment">//100</span></span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(b[<span class="number">1</span>].number)</span></span> <span class="comment">//100</span></span><br></pre></td></tr></table></figure><ul><li>处理大量数据并且频繁操作其中的元素的时候，我们需要使用<code>NSMutableArray</code>、<code>NSMutableDictionary</code>会更好。</li><li>对于容器内条目少、容器本身数目多的情况下，我们需要使用<code>Array</code>、<code>Dictionary</code></li></ul><hr><ul><li><code>swift</code>版本配合<code>range</code>的使用：</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">let levels = <span class="string">"ABCDE"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">let nsRange = NSMakeRange(<span class="number">1</span>, <span class="number">4</span>)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">((levels as NSString)</span></span>.replacingCharacters(<span class="keyword">in</span>: nsRange, with: <span class="string">"AAAA"</span>))</span><br><span class="line"></span><br><span class="line">let indexPositionOne = levels<span class="selector-class">.characters</span><span class="selector-class">.index</span>(levels<span class="selector-class">.startIndex</span>, offsetBy: <span class="number">1</span>)</span><br><span class="line">let swiftRange = indexPositionOne ..&lt; levels<span class="selector-class">.characters</span><span class="selector-class">.index</span>(levels<span class="selector-class">.startIndex</span>, offsetBy: <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(levels.replacingCharacters(in: swiftRange, with: <span class="string">"AAAA"</span>)</span></span>)</span><br></pre></td></tr></table></figure><hr>]]></content>
    
    <summary type="html">
    
      &lt;ul&gt;
&lt;li&gt;&lt;code&gt;final&lt;/code&gt;修饰的&lt;code&gt;class&lt;/code&gt;/&lt;code&gt;func&lt;/code&gt;/&lt;code&gt;var&lt;/code&gt;,表示内容不允许进行继承或者重写&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;lazy&lt;/code&gt;简单赋值：&lt;code&gt;lazy var str1: String = &amp;quot;Hello&amp;quot;&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;lazy&lt;/code&gt;计算赋值：&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="日志" scheme="http://www.ghcoder.com/categories/%E6%97%A5%E5%BF%97/"/>
    
    
      <category term="Swift" scheme="http://www.ghcoder.com/tags/Swift/"/>
    
  </entry>
  
  <entry>
    <title>学习Swift Tips(二)</title>
    <link href="http://www.ghcoder.com/2017/09/08/20170908/"/>
    <id>http://www.ghcoder.com/2017/09/08/20170908/</id>
    <published>2017-09-08T02:53:12.000Z</published>
    <updated>2017-09-13T06:47:06.000Z</updated>
    
    <content type="html"><![CDATA[<ul><li>在介绍（Tuple）的时候，说了交换输入的方法书写，在Object-C中，有很多方法，我们传入的是指针，这个问题主要的来源就是因为受制约C语言，单一返回，有了Tuple的时候，我们就可以方便的调用了。</li></ul><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">let rect = CGRect(<span class="string">x:</span> <span class="number">0</span>, <span class="string">y:</span> <span class="number">0</span>, <span class="string">width:</span> <span class="number">100</span>, <span class="string">height:</span> <span class="number">100</span>)</span><br><span class="line">let (small, large) = rect.divided(<span class="string">atDistance:</span> <span class="number">20</span>, <span class="string">from:</span> .minXEdge)</span><br></pre></td></tr></table></figure><a id="more"></a><hr><ul><li>在写swift的时候，我们常常需要和Optional打交道，这时候我们就需要常常用到解包，这里就提到了一个快速解包的方式<code>??</code>,首先看一下如何使用：</li></ul><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">var</span> lev<span class="symbol">el:</span> <span class="built_in">Int</span>?</span><br><span class="line"><span class="built_in">var</span> startLevel = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">var</span> currentLevel = level ?? startLevel</span><br></pre></td></tr></table></figure><ul><li>这里很简单，但是还是要说一下，这里的<code>??</code>判断左边的值，如果是非nil的<code>optional</code>的值，那就直接返回左边的value值，否则就返回右边的值,但是细细往下看一下源码的定义会发现：</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> ??&lt;T&gt;<span class="params">(<span class="keyword">optional</span>: T?, defaultValue: @autoclosure <span class="params">()</span></span></span> <span class="keyword">throws</span> -&gt; <span class="type">T</span>) <span class="keyword">rethrows</span> -&gt; <span class="type">T</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> ??&lt;T&gt;<span class="params">(<span class="keyword">optional</span>: T?, defaultValue: @autoclosure <span class="params">()</span></span></span> <span class="keyword">throws</span> -&gt; <span class="type">T</span>?) <span class="keyword">rethrows</span> -&gt; <span class="type">T</span>?</span><br></pre></td></tr></table></figure><ul><li>看到这里，我就有点疑惑了，这个<code>??</code>其实就是一个函数，那么问题来了，<code>函数的调用方式为什么那么另类呢？</code>,按照我们的理解，这个函数的调用方式不应该是这样的吗？<code>??(optional, xxx)</code>,但是发现这样写，会报错，所以这里我就决定把函数的定义直接copy下来，然后自己去实现，带入如下：</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">th</span>&lt;T&gt;<span class="params">(<span class="number">_</span> <span class="keyword">optional</span>: T?, <span class="number">_</span> defaultValue: @autoclosure <span class="params">()</span></span></span> <span class="keyword">throws</span> -&gt; <span class="type">T</span>) <span class="keyword">rethrows</span> -&gt; <span class="type">T</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="keyword">optional</span> = <span class="keyword">optional</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">optional</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">try</span> defaultValue()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> level: <span class="type">Int</span>?</span><br><span class="line"><span class="keyword">var</span> startLevel = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> test = th(level, startLevel)</span><br></pre></td></tr></table></figure><ul><li>看到这里我就开始猜测了，这或许是<code>swift</code>为了方便的我们的调用，所以它又定义了一个语法糖吧！</li></ul><hr><ul><li>@autoclosure 符号的意思，就是直接将：入参T 转化为 ()-&gt;T</li></ul><hr><ul><li>@escaping 符号的意思就是说明，这个参数是异步的，不是属于这个局部的函数，可以在这个函数执行完成之后再执行这里的回调，不加任何参数的block默认就是同步的，函数执行完成之前，这个block就会被收回。</li></ul><hr><ul><li>optional Chaining 如果某个属性是nil的话，会提前返回回来。</li></ul><hr><ul><li>重载符号的做法，用的比较少：</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">precedencegroup <span class="type">DotProductPrecedence</span> &#123;</span><br><span class="line">    <span class="keyword">associativity</span>: <span class="keyword">none</span></span><br><span class="line">    higherThan: <span class="type">MultiplicationPrecedence</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">infix</span> <span class="keyword">operator</span> +*: <span class="type">DotProductPrecedence</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> +*<span class="params">(<span class="keyword">left</span>: Vector2D, <span class="keyword">right</span>: Vector2D)</span></span> -&gt; <span class="type">Double</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">left</span>.x * <span class="keyword">right</span>.x + <span class="keyword">left</span>.y * <span class="keyword">right</span>.y</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><ul><li>外部传入的参数，如果需要在函数内部修改的话，需要在参数前面加上<code>inout</code>，这样传入参数的时候，就需要将之前传入的值改为地址，类似:</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">incrementor</span><span class="params">(variable: <span class="keyword">inout</span> Int)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">       variable += <span class="number">1</span></span><br><span class="line">       <span class="keyword">return</span> variable</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><hr><ul><li>字面量的作用，我就觉得很鸡肋，但是还是看一下，说白了，字面量的意思就是说：<code>可同直接实例化的时候，传入一个String、Int、Bool, 而返回的确实我们自定义的类型</code>，例如：</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>: <span class="title">ExpressibleByStringLiteral</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> name: <span class="type">String</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>(name value: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.name = value</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">convenience</span> <span class="keyword">init</span>(stringLiteral value: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.<span class="keyword">init</span>(name: value)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">convenience</span> <span class="keyword">init</span>(extendedGraphemeClusterLiteral value: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.<span class="keyword">init</span>(name: value)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">convenience</span> <span class="keyword">init</span>(unicodeScalarLiteral value: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.<span class="keyword">init</span>(name: value)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="keyword">let</span> p: <span class="type">Person</span> = <span class="string">"xiaoming"</span></span><br><span class="line"> <span class="built_in">print</span>(p.name)</span><br></pre></td></tr></table></figure><hr><ul><li>数组下标说实话，还是蛮不错的内容，用的好的话，可以节省很多的时间，通过对下面两个方法写一下拓展，就可以实现自定义的下标功能：</li></ul><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> subscript(<span class="built_in">index</span>: <span class="built_in">Int</span>) -&gt; Element</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> subscript(bounds: <span class="built_in">Range</span>&lt;<span class="built_in">Int</span>&gt;) -&gt; ArraySlice&lt;Element&gt;</span><br></pre></td></tr></table></figure><ul><li>onvcate 的例子中举出了下面的例子，方便我们通过下标来获取数组的数据：</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">var</span> arr = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>]</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(arr[[<span class="number">0</span>,<span class="number">2</span>,<span class="number">3</span>]])</span></span></span><br><span class="line">arr[[<span class="number">0</span>,<span class="number">2</span>,<span class="number">3</span>]] = [-<span class="number">1</span>, -<span class="number">3</span>, -<span class="number">4</span>]</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(arr)</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">extension Array &#123;</span><br><span class="line"></span><br><span class="line">    subscript(<span class="selector-tag">input</span>: [Int]) -&gt; ArraySlice&lt;Element&gt; &#123;</span><br><span class="line">        get&#123;</span><br><span class="line">            <span class="selector-tag">var</span> result = ArraySlice&lt;Element&gt;()</span><br><span class="line">            <span class="keyword">for</span> <span class="selector-tag">i</span> <span class="keyword">in</span> <span class="selector-tag">input</span> &#123;</span><br><span class="line">                assert(<span class="selector-tag">i</span> &lt; self<span class="selector-class">.count</span>, <span class="string">"Index out of range"</span>)</span><br><span class="line">                result.append(self[i])</span><br><span class="line">            &#125;</span><br><span class="line">            return result</span><br><span class="line">        &#125;</span><br><span class="line">        set&#123;</span><br><span class="line">            <span class="keyword">for</span>(index,i) <span class="keyword">in</span> <span class="selector-tag">input</span>.enumerated() &#123;</span><br><span class="line">                assert(<span class="selector-tag">i</span> &lt; self<span class="selector-class">.count</span>, <span class="string">"Index out of range"</span>)</span><br><span class="line">                self[i] = newValue[index]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>下面作者也说了，这个方式调用起来不是很优雅，然后就有了下面的拓展，是我自己写的：</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Array</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">subscript</span>(first: <span class="type">Int</span>, second: <span class="type">Int</span>, other: <span class="type">Int</span>...) -&gt; <span class="type">ArraySlice</span>&lt;<span class="type">Element</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">get</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> result = <span class="type">ArraySlice</span>&lt;<span class="type">Element</span>&gt;()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> first &lt; <span class="keyword">self</span>.<span class="built_in">count</span> &#123;</span><br><span class="line">                result.append(<span class="keyword">self</span>[first])</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> second &lt; <span class="keyword">self</span>.<span class="built_in">count</span> &#123;</span><br><span class="line">                result.append(<span class="keyword">self</span>[second])</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> other &#123;</span><br><span class="line">                <span class="built_in">assert</span>(i &lt; <span class="keyword">self</span>.<span class="built_in">count</span>, <span class="string">"Index out of range"</span>)</span><br><span class="line">                result.append(<span class="keyword">self</span>[i])</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> tempDatas = other.<span class="built_in">count</span> &gt; <span class="number">0</span> ? other : [<span class="type">Int</span>]()</span><br><span class="line">            <span class="keyword">if</span> (first &lt; <span class="keyword">self</span>.<span class="built_in">count</span>) &#123;</span><br><span class="line">                tempDatas.append(first)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (second &lt; <span class="keyword">self</span>.<span class="built_in">count</span>) &#123;</span><br><span class="line">                tempDatas.append(second)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span>(index,i) <span class="keyword">in</span> tempDatas.enumerated() &#123;</span><br><span class="line">                <span class="built_in">assert</span>(i &lt; <span class="keyword">self</span>.<span class="built_in">count</span>, <span class="string">"Index out of range"</span>)</span><br><span class="line">                <span class="keyword">self</span>[i] = newValue[index]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> t = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]</span><br><span class="line"><span class="built_in">print</span>( t[<span class="number">0</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>])</span><br><span class="line">t[<span class="number">0</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>] = [<span class="number">99</span>,<span class="number">99</span>,<span class="number">99</span>,<span class="number">99</span>]</span><br><span class="line"><span class="built_in">print</span>(t)</span><br></pre></td></tr></table></figure><hr><ul><li>函数作为一等公民，就是你可以把函数作为参数，返回值，或者可以在函数中定义任意多个函数，这样也可以控制代码的访问权限的问题。</li></ul><hr><ul><li>在不同的target(一个叫<code>GG</code>,一个叫<code>HH</code>)中，调用同一个类的，同一个方法，例如我们定义了一个<code>My</code>的类，里面定义了一个<code>hello</code>的类方法:</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">GG<span class="selector-class">.My</span><span class="selector-class">.hello</span>()</span><br><span class="line">HH<span class="selector-class">.My</span><span class="selector-class">.hello</span>()</span><br></pre></td></tr></table></figure><hr><ul><li>typealias 除了用在给变量、实例、属性定义别名外，还可以用在协议上，我认为这样的用户很大:</li></ul><figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">protocol <span class="keyword">Cat</span> &#123;&#125;</span><br><span class="line"><span class="keyword">protocol</span> <span class="keyword">Dog</span> &#123;&#125;</span><br><span class="line"><span class="keyword">typealias</span> <span class="keyword">Pat</span> = Cat &amp; Dog</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">ViewController</span>: <span class="title">UIViewController</span>, <span class="title">Pat</span> &#123;&#125;</span><br></pre></td></tr></table></figure><hr><ul><li>如果想对协议添加限定的话，我们就可以定义一个<code>associatedtype xx</code>,这样在遵循了协议的时候，就需要制定我们type的类型，这就和之前看官方<code>Array</code>定义的效果医院，需要我们制定类型，这样就能够更好的限制遵循协议的对象。</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Animal</span> </span>&#123;</span><br><span class="line">    <span class="keyword">associatedtype</span> <span class="type">F</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">eat</span><span class="params">(<span class="number">_</span> food: F)</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Meat</span>: <span class="title">Food</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Crass</span>: <span class="title">Food</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Tiger</span>: <span class="title">Animal</span> </span>&#123;</span><br><span class="line">    <span class="keyword">typealias</span> <span class="type">F</span> = <span class="type">Meat</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">eat</span><span class="params">(<span class="number">_</span> food: Meat)</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"eat \(food)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>但是一旦我们这样限制了协议之后，在进行独立判断的时候，我们就不能像之前那样直接进行判断了，例如：</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">isDangerous</span><span class="params">(animal: Animal)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> animal <span class="keyword">is</span> <span class="type">Tiger</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>这里错误的原因，是因为我们没有在编译的时候，限制协议中的type类型，在这种情况下，我们只能按照泛型的类型来书写了：</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">isDangerous</span>&lt;T: Animal&gt;<span class="params">(animal: T)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> animal <span class="keyword">is</span> <span class="type">Tiger</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><ul><li>可变参数的调用，不限制在指定哪个位置，接受可变参数的函数内部，把可变参数看作是对应数据的数组，但是每个函数只能接受一个可变参数，并且可变参数的类型必须是一致的。</li></ul><hr><ul><li>方法的调用顺序问题:</li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cat</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> name: String</span><br><span class="line">    <span class="keyword">init</span>() &#123;</span><br><span class="line">        name = <span class="string">"cat"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tiger</span>: <span class="type">Cat &#123;</span></span></span><br><span class="line">    let power: <span class="built_in">Int</span></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">init</span>() &#123;</span><br><span class="line">        power = <span class="number">10</span></span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>()</span><br><span class="line">        name = <span class="string">"gh"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>类在初始化的时候，必须要保证该类的所有成员都完成了初始化。</li><li>存在继承关系的类，必须要确保当前子类实例的所有成员完成初始化后才会调用父类的初始化。</li><li>可以显示的调用<code>super.init()</code>，如果不显示的调用的<code>super.init()</code>的时候，当我们完成子类的实例化方法的时候，就会自己调用<code>super.init()</code>,当然如果存在复写的情况的话，还是需要显示的调用的。</li></ul><hr><ul><li>Designated、Convenience、Required 使用注意点：</li></ul><ol><li>Swift的<code>init</code>只能被调用一次，而且是线程安全的，可以对let属性变量进行赋值。</li><li>在<code>init</code>前面加了<code>convenience</code>的初始化方法必须调用同一个类的<code>init</code>的方法。</li><li><code>convenience</code>的实例化方法不能被重写，并且也不能够被子类通过<code>super</code>的方式调用。</li><li>只要子类重写了<code>convenience</code>方法所需的<code>init</code>的方法后，子类就可以使用<code>convenience</code>的初始化方法。</li><li>当子类含有异于父类的初始化方法时（初始化方法参数类型和数量异于父类），子类必须要实现父类的required初始化方法，并且也要使用required修饰符而不是override。</li><li>当子类没有初始化方法时，可以不用实现父类的required初始化方法。</li></ol><hr><ul><li>对于可以返回nil的初始化方法，我们需要在<code>init?(xxx)</code>，加入<code>?</code></li></ul><hr><ul><li>如果想在protocol 里定义一个类型域上的方法或者计算属性，我们需要在定义的时候用<code>static</code>进行定义。</li></ul><hr><ul><li>在Swift中的集合类型，在定义中可以看出，我们可以将同一种类型的数据存放在集合中，但是如果类型不同呢？我们应该怎么办呢？</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Any 类型可以隐式转化</span></span><br><span class="line"><span class="keyword">let</span> mixed: [CustomStringConvertible] = [<span class="number">1</span>, <span class="string">"two"</span>, <span class="literal">false</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 转化为[NSObject]</span></span><br><span class="line"><span class="keyword">let</span> objectArray = [<span class="number">1</span> <span class="keyword">as</span> NSObject, <span class="string">"two"</span> <span class="keyword">as</span> NSObject, <span class="literal">false</span> <span class="keyword">as</span> NSObject]</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="built_in">any</span> = mixed[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> nsObject = objectArray[<span class="number">2</span>]</span><br></pre></td></tr></table></figure><ul><li>这样存储是没啥问题的，但是也会存在一个问题，那就是可能数据会部分丢失，这其实也是不建议的，因为既然你能存放在同一个集合中，那这些元素，就应该存在一定的共同点。</li></ul><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">IntOrString</span> &#123;</span></span><br><span class="line">    <span class="keyword">case</span> IntValue(Int)</span><br><span class="line">    <span class="keyword">case</span> StringValue(String)</span><br><span class="line">    <span class="keyword">case</span> BoolValue(Bool)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">let mixed = [IntOrString.IntValue(<span class="number">1</span>), IntOrString.StringValue(<span class="string">"two"</span>), IntOrString.BoolValue(<span class="literal">false</span>)]</span><br></pre></td></tr></table></figure><hr><ul><li>默认参数可以在任意的位置:</li></ul><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">func</span> sayHello1(<span class="keyword">str1: </span><span class="keyword">String </span>= <span class="string">"Hello"</span>, <span class="keyword">str2: </span><span class="keyword">String, </span><span class="keyword">str3: </span><span class="keyword">String) </span>&#123;</span><br><span class="line">    print(<span class="keyword">str1 </span>+ <span class="keyword">str2 </span>+ <span class="keyword">str3)</span></span><br><span class="line"><span class="keyword">&#125;</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword">func </span>sayHello2(<span class="keyword">str1: </span><span class="keyword">String, </span><span class="keyword">str2: </span><span class="keyword">String, </span><span class="keyword">str3: </span><span class="keyword">String </span>= <span class="string">"World"</span>) &#123;</span><br><span class="line">    print(<span class="keyword">str1 </span>+ <span class="keyword">str2 </span>+ <span class="keyword">str3)</span></span><br><span class="line"><span class="keyword">&#125;</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword">sayHello1(str2: </span><span class="string">" "</span>, <span class="keyword">str3: </span><span class="string">"World"</span>)</span><br><span class="line"><span class="symbol">sayHello2</span>(<span class="keyword">str1: </span><span class="string">"Hello"</span>, <span class="keyword">str2: </span><span class="string">" "</span>)</span><br></pre></td></tr></table></figure><hr><ul><li>swift 中没有专门的用来正则匹配的东西，但是围绕<code>NSRegularExpression</code>也是可以在swift上做一下拓展:</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">RegexHelper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> regex: <span class="type">NSRegularExpression</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>(<span class="number">_</span> pattern: <span class="type">String</span>) <span class="keyword">throws</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> regex = <span class="type">NSRegularExpression</span>(pattern: pattern, options: .caseInsensitive)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">match</span><span class="params">(<span class="number">_</span> input: String)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> matches = regex.matches(<span class="keyword">in</span>: input,</span><br><span class="line">                                    options: [],</span><br><span class="line">                                    range: <span class="type">NSMakeRange</span>(<span class="number">0</span>, input.utf16.<span class="built_in">count</span>))</span><br><span class="line">        <span class="keyword">return</span> matches.<span class="built_in">count</span> &gt; <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> mailPattern = <span class="string">"^([a-z0-9\\.-]+)@([\\da-z\\.-]+)\\.([a-z\\.]&#123;2,6&#125;)$"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> matcher: <span class="type">RegexHelper</span></span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    matcher = <span class="keyword">try</span> <span class="type">RegexHelper</span>(mailPattern)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> maybeMailAddress = <span class="string">"onev@onevcat.com"</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> matcher.match(maybeMailAddress) &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"有效的邮箱地址"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(error)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><ul><li><code>...</code>(闭区间)和<code>..&lt;</code>(开区间)，除了可以生成一个数字类型的范围外，还是可以生成字符串和ASCII编码：</li></ul><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> interval = <span class="string">"a"</span>...<span class="string">"z"</span></span><br><span class="line"><span class="keyword">let</span> xx = \<span class="number">0.</span>..~</span><br></pre></td></tr></table></figure><hr><ul><li>任意的类型有：<code>Any/AnyObject/AnyClass</code>, 而 <code>typealias AnyClass = AnyObject.Type</code>, <code>.self</code>用在类型后面取得类型本身，用在某实例后面表示取得实例本事</li><li>通过<code>AnyObject.Type</code>获取得到的是一个元类型， 也就是<code>AnyClass</code>,这时候我们需要调用<code>.self</code>来获取元类。</li></ul><hr><ul><li>在协议中返回值，我们可以返回<code>Self</code>,这个类型的意思是，遵循这个协议的类调用这个方法可以返回一个同样遵循该协议并且相同的类：</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Copyable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">copy</span><span class="params">()</span></span> -&gt; <span class="type">Self</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span>: <span class="title">Copyable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> num = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">copy</span><span class="params">()</span></span> -&gt; <span class="type">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> result = type(of: <span class="keyword">self</span>).<span class="keyword">init</span>()</span><br><span class="line">        result.num = num</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">init</span>() &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>这样书写之后，不管是<code>MyClass</code>还是<code>MyClass</code>的子类都可以同样适用该协议方法。</li><li>并且需要使用<code>required</code>来定义初始化方法，确保该类及其子类都能响应这个初始化方法。</li></ul><hr><ul><li>swift 是不支持动态派发的，所以他不会根据继承的关系，在运行时改变方法的执行：</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pet</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cat</span>: <span class="title">Pet</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span>: <span class="title">Pet</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printPet</span><span class="params">(<span class="number">_</span> pet: Pet)</span></span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Pet"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printPet</span><span class="params">(<span class="number">_</span> cat: Cat)</span></span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Meow"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printPet</span><span class="params">(<span class="number">_</span> dog: Dog)</span></span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Bark"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printThem</span><span class="params">(<span class="number">_</span> pet: Pet, <span class="number">_</span> cat: Cat)</span></span> &#123;</span><br><span class="line">    printPet(pet) <span class="comment">// Pet</span></span><br><span class="line">    printPet(cat) <span class="comment">// Meow</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">printThem(<span class="type">Dog</span>(), <span class="type">Cat</span>())</span><br></pre></td></tr></table></figure><ul><li>虽然我这里传入的是<code>Dog()</code>的实例，但是在函数内部，我们定义的确实它的父类，所以在实际调用的时候，不管你传入的是什么，在编译的时候，就已经决定了，函数调用的入参是<code>pet</code>，如果想要区分的话，只能通过类型的判断去执行：</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printThem</span><span class="params">(<span class="number">_</span> pet: Pet, <span class="number">_</span> cat: Cat)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> aCat = pet <span class="keyword">as</span>? <span class="type">Cat</span> &#123;</span><br><span class="line">        printPet(aCat)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">let</span> aDog = pet <span class="keyword">as</span>? <span class="type">Dog</span> &#123;</span><br><span class="line">        printPet(aDog)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    printPet(cat)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><ul><li>属性的监听在<code>willSet</code>是将<code>date</code>-&gt;<code>newValue</code>, 而<code>didSet</code>是从<code>oldValue</code>-&gt;<code>date</code>。</li><li>基本上在同一个类中对同一个属性值，不可能存在<code>set</code>/<code>willSet</code>/<code>didSet</code>, 但是如果复写父类的属性值的时候，我们就可以同时实现三个属性值：</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> number: <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"get"</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"set"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>: <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">var</span> number: <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">willSet</span> &#123; <span class="built_in">print</span>(<span class="string">"willset"</span>) &#125;</span><br><span class="line">        <span class="keyword">didSet</span>  &#123; <span class="built_in">print</span>(<span class="string">"didSet"</span>) &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> b = <span class="type">B</span>()</span><br><span class="line">b.number = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line"><span class="comment">// get</span></span><br><span class="line"><span class="comment">// willSet</span></span><br><span class="line"><span class="comment">// set</span></span><br><span class="line"><span class="comment">// didSet</span></span><br></pre></td></tr></table></figure><ul><li>这里首先打印<code>get</code>,是因为这里实现了<code>didSet</code>,在<code>didSet</code>中用到了<code>oldValue</code>, 而这个值需要在整个set动作之前进行获取并存储代用。</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;ul&gt;
&lt;li&gt;在介绍（Tuple）的时候，说了交换输入的方法书写，在Object-C中，有很多方法，我们传入的是指针，这个问题主要的来源就是因为受制约C语言，单一返回，有了Tuple的时候，我们就可以方便的调用了。&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight groovy&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;let rect = CGRect(&lt;span class=&quot;string&quot;&gt;x:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;y:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;width:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;height:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;100&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;let (small, large) = rect.divided(&lt;span class=&quot;string&quot;&gt;atDistance:&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;20&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;from:&lt;/span&gt; .minXEdge)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="日志" scheme="http://www.ghcoder.com/categories/%E6%97%A5%E5%BF%97/"/>
    
    
      <category term="Swift" scheme="http://www.ghcoder.com/tags/Swift/"/>
    
  </entry>
  
  <entry>
    <title>学习Masonry Autolayout布局实例</title>
    <link href="http://www.ghcoder.com/2017/09/07/20170907/"/>
    <id>http://www.ghcoder.com/2017/09/07/20170907/</id>
    <published>2017-09-07T03:33:12.000Z</published>
    <updated>2017-09-07T08:04:51.000Z</updated>
    
    <content type="html"><![CDATA[<h4 id="最近看到很多人都在转一篇博客，博客的链接为：-http-tutuge-me-2015-05-23-autolayout-example-with-masonry-其实文章的知识点不是很多，重点就是讲如何运用Masonry来实现一些东西，但是不得不承认这篇文章很使用，我在平时开发的时候，很多细节的地方，我也没有注意到，然后看了一下他的四篇博客，记录一下："><a href="#最近看到很多人都在转一篇博客，博客的链接为：-http-tutuge-me-2015-05-23-autolayout-example-with-masonry-其实文章的知识点不是很多，重点就是讲如何运用Masonry来实现一些东西，但是不得不承认这篇文章很使用，我在平时开发的时候，很多细节的地方，我也没有注意到，然后看了一下他的四篇博客，记录一下：" class="headerlink" title="最近看到很多人都在转一篇博客，博客的链接为：[http://tutuge.me/2015/05/23/autolayout-example-with-masonry/], 其实文章的知识点不是很多，重点就是讲如何运用Masonry来实现一些东西，但是不得不承认这篇文章很使用，我在平时开发的时候，很多细节的地方，我也没有注意到，然后看了一下他的四篇博客，记录一下："></a>最近看到很多人都在转一篇博客，博客的链接为：[<a href="http://tutuge.me/2015/05/23/autolayout-example-with-masonry/]" target="_blank" rel="noopener">http://tutuge.me/2015/05/23/autolayout-example-with-masonry/]</a>, 其实文章的知识点不是很多，重点就是讲如何运用Masonry来实现一些东西，但是不得不承认这篇文章很使用，我在平时开发的时候，很多细节的地方，我也没有注意到，然后看了一下他的四篇博客，记录一下：</h4><ul><li>第一部分重点讲的是两个属性: <code>Content Compression Resistance</code>、<code>Content Hugging</code>,这里我觉得作者的解释还是形象的：</li></ul><a id="more"></a><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Content Compression Resistance = 不许挤我</span><br><span class="line">值越高，内容越不容易被压缩</span><br><span class="line">当内容放不下的时候，优先挤压那些优先级低的元素</span><br><span class="line"></span><br><span class="line">Content Hugging = 抱紧</span><br><span class="line">子元素设置的属性值越高，子元素越不会随着父视图的变化而变化</span><br><span class="line"></span><br><span class="line"><span class="comment">//设置label1的content hugging 为1000</span></span><br><span class="line">[_label1 setContentHuggingPriority:<span class="built_in">UILayoutPriorityRequired</span></span><br><span class="line">                               forAxis:<span class="built_in">UILayoutConstraintAxisHorizontal</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//设置label1的content compression 为1000</span></span><br><span class="line">[_label1 setContentCompressionResistancePriority:<span class="built_in">UILayoutPriorityRequired</span></span><br><span class="line">                                             forAxis:<span class="built_in">UILayoutConstraintAxisHorizontal</span>];</span><br></pre></td></tr></table></figure><ul><li>居中显示四个元素:</li></ul><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">UIView __block *lastView = nil;</span><br><span class="line"> MASConstraint __block *widthConstraint = nil;</span><br><span class="line"> NSUInteger arrayCount = _imageViews.count;</span><br><span class="line"> [_imageViews enumerateObjectsUsingBlock:^(UIView *<span class="built_in">view</span>, NSUInteger idx, <span class="keyword">BOOL</span> *<span class="keyword">stop</span>) &#123;</span><br><span class="line">     [<span class="built_in">view</span> mas_makeConstraints:^(MASConstraintMaker *<span class="built_in">make</span>) &#123;</span><br><span class="line">         <span class="comment">//宽高固定</span></span><br><span class="line">         widthConstraint = <span class="built_in">make</span>.width.equalTo(<span class="comment">@(imageViewSize.width));</span></span><br><span class="line"><span class="comment">         make.height.equalTo(@</span>(imageViewSize.height));</span><br><span class="line">         <span class="comment">//左边约束</span></span><br><span class="line">         <span class="built_in">make</span>.left.equalTo(lastView ? lastView.mas_right : <span class="built_in">view</span>.superview.mas_left);</span><br><span class="line">         <span class="comment">//垂直中心对齐</span></span><br><span class="line">         <span class="built_in">make</span>.centerY.equalTo(<span class="built_in">view</span>.superview.mas_centerY);</span><br><span class="line">         <span class="comment">//设置最右边的imageView的右边与父view的最有对齐</span></span><br><span class="line">         <span class="keyword">if</span> (idx == arrayCount - <span class="number">1</span>) &#123;</span><br><span class="line">             <span class="built_in">make</span>.right.equalTo(<span class="built_in">view</span>.superview.mas_right);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         [_widthConstraints addObject:widthConstraint];</span><br><span class="line">         lastView = <span class="built_in">view</span>;</span><br><span class="line">     &#125;];</span><br><span class="line"> &#125;];</span><br><span class="line"></span><br><span class="line"> ...</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 隐藏元素的时候，就可以直接来修改约束</span></span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (sender.on) &#123;</span><br><span class="line">     width.equalTo(<span class="comment">@(IMAGE_SIZE));</span></span><br><span class="line"><span class="comment"> &#125; else &#123;</span></span><br><span class="line"><span class="comment">     width.equalTo(@</span><span class="number">0</span>);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><ul><li>a视图是b视图的倍数关系的：</li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">make</span><span class="selector-class">.width</span><span class="selector-class">.equalTo</span>(_<span class="selector-tag">containerView</span><span class="selector-class">.mas_width</span>)<span class="selector-class">.multipliedBy</span>(0<span class="selector-class">.5</span>);</span><br></pre></td></tr></table></figure><ul><li><p><code>UITableViewCell</code>高度的问题：</p></li><li><p>首先如果是在<code>iOS8以及以后的版本的话</code>，那就不需要考虑这个问题了，直接使用新特性</p></li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">_tableView.estimatedRowHeight = <span class="number">80.0</span>f;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">- (<span class="built_in">CGFloat</span>)tableView:(<span class="built_in">UITableView</span> *)tableView heightForRowAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#ifdef IOS_8_NEW_FEATURE_SELF_SIZING</span></span><br><span class="line">    <span class="comment">// iOS 8 的Self-sizing特性</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">UITableViewAutomaticDimension</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>如果是在旧版本<code>iOS7上的话</code>:</li></ul> <figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 根据当前数据，计算Cell的高度，注意+1</span></span><br><span class="line">dataEntity.cellHeight = [_templateCell.contentView systemLayoutSizeFittingSize:UILayoutFittingCompressedSize].<span class="built_in">height</span> + <span class="number">0.5</span>f;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算UILabel的preferredMaxLayoutWidth值，多行时必须设置这个值，否则系统无法决定Label的宽度</span></span><br><span class="line">    CGFloat preferredMaxWidth = [UIScreen mainScreen].bounds.<span class="built_in">size</span>.<span class="built_in">width</span> - <span class="number">44</span> - <span class="number">4</span> * <span class="number">3</span>; <span class="comment">// 44 = avatar宽度，4 * 3为padding</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Content - 多行</span></span><br><span class="line">    _contentLabel.preferredMaxLayoutWidth = preferredMaxWidth; <span class="comment">// 多行时必须设置</span></span><br></pre></td></tr></table></figure><ul><li><p>为了避免在转屏的时候，Header、Bottom差一截的问题，这里我们头，尾视图不需要根据父视图来设定约束，而是根据<code>topLayoutGuide</code>、<code>bottomLayoutGuide</code>来设定:</p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> [_topView mas_updateConstraints:^(MASConstraintMaker *<span class="built_in">make</span>) &#123;</span><br><span class="line">    <span class="comment">// 直接利用其length属性，避免iOS、SDK版本升级后topLayoutGuide不再是UIView</span></span><br><span class="line">    <span class="built_in">make</span>.top.equalTo(self.<span class="built_in">view</span>.mas_top).with.offset(self.topLayoutGuide.length);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据新的length值更新约束</span></span><br><span class="line">[_bottomView mas_updateConstraints:^(MASConstraintMaker *<span class="built_in">make</span>) &#123;</span><br><span class="line">    <span class="comment">// 直接利用其length属性，避免iOS、SDK版本升级后topLayoutGuide不再是UIView</span></span><br><span class="line">    <span class="built_in">make</span>.bottom.equalTo(self.<span class="built_in">view</span>.mas_bottom).with.offset(-(self.bottomLayoutGuide.length));</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure></li><li><p>自定义<code>baseline</code>的属性值：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 返回自定义的baseline的view</span></span><br><span class="line">- (UIView *)viewForBaselineLayout &#123;</span><br><span class="line">    <span class="keyword">return</span> _baseView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>可拉伸的<code>UITableView</code></p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> <span class="variable">_tableView</span>.contentInset = UIEdgeInsetsMake(ParallaxHeaderHeight, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"> ...</span><br><span class="line"></span><br><span class="line"> - (void)initView &#123;</span><br><span class="line">    <span class="variable">_parallaxHeaderView</span> = [UIImageView new];</span><br><span class="line">    [self.view insertSubview:<span class="variable">_parallaxHeaderView</span> belowSubview:<span class="variable">_tableView</span>];</span><br><span class="line">    <span class="variable">_parallaxHeaderView</span>.contentMode = UIViewContentModeScaleAspectFill;</span><br><span class="line">    <span class="variable">_parallaxHeaderView</span>.<span class="built_in">image</span> = [UIImage imageNamed:@<span class="string">"parallax_header_back"</span>];</span><br><span class="line"></span><br><span class="line">    [<span class="variable">_parallaxHeaderView</span> mas_makeConstraints:^(MASConstraintMaker *make) &#123;</span><br><span class="line">        make.left.<span class="built_in">and</span>.right.equalTo(self.view);</span><br><span class="line">        make.top.equalTo(self.mas_topLayoutGuideBottom);</span><br><span class="line">        <span class="variable">_parallaxHeaderHeightConstraint</span> = make.height.equalTo(@(ParallaxHeaderHeight));</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add KVO</span></span><br><span class="line">    [<span class="variable">_tableView</span> addObserver:self forKeyPath:@<span class="string">"contentOffset"</span> options:NSKeyValueObservingOptionNew context:<span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><ul><li>KVO的回调</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方法2：利用KVO</span></span><br><span class="line">- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath ofObject:(<span class="keyword">id</span>)object</span><br><span class="line">                        change:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *,<span class="keyword">id</span>&gt; *)change</span><br><span class="line">                       context:(<span class="keyword">void</span> *)context &#123;</span><br><span class="line">    <span class="keyword">if</span> ([keyPath isEqualToString:<span class="string">@"contentOffset"</span>]) &#123;</span><br><span class="line">        <span class="built_in">CGPoint</span> contentOffset = ((<span class="built_in">NSValue</span> *)change[<span class="built_in">NSKeyValueChangeNewKey</span>]).CGPointValue;</span><br><span class="line">        <span class="keyword">if</span> (contentOffset.y &lt; -ParallaxHeaderHeight) &#123;</span><br><span class="line">            _parallaxHeaderHeightConstraint.equalTo(@(-contentOffset.y));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h4 id=&quot;最近看到很多人都在转一篇博客，博客的链接为：-http-tutuge-me-2015-05-23-autolayout-example-with-masonry-其实文章的知识点不是很多，重点就是讲如何运用Masonry来实现一些东西，但是不得不承认这篇文章很使用，我在平时开发的时候，很多细节的地方，我也没有注意到，然后看了一下他的四篇博客，记录一下：&quot;&gt;&lt;a href=&quot;#最近看到很多人都在转一篇博客，博客的链接为：-http-tutuge-me-2015-05-23-autolayout-example-with-masonry-其实文章的知识点不是很多，重点就是讲如何运用Masonry来实现一些东西，但是不得不承认这篇文章很使用，我在平时开发的时候，很多细节的地方，我也没有注意到，然后看了一下他的四篇博客，记录一下：&quot; class=&quot;headerlink&quot; title=&quot;最近看到很多人都在转一篇博客，博客的链接为：[http://tutuge.me/2015/05/23/autolayout-example-with-masonry/], 其实文章的知识点不是很多，重点就是讲如何运用Masonry来实现一些东西，但是不得不承认这篇文章很使用，我在平时开发的时候，很多细节的地方，我也没有注意到，然后看了一下他的四篇博客，记录一下：&quot;&gt;&lt;/a&gt;最近看到很多人都在转一篇博客，博客的链接为：[&lt;a href=&quot;http://tutuge.me/2015/05/23/autolayout-example-with-masonry/]&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;http://tutuge.me/2015/05/23/autolayout-example-with-masonry/]&lt;/a&gt;, 其实文章的知识点不是很多，重点就是讲如何运用Masonry来实现一些东西，但是不得不承认这篇文章很使用，我在平时开发的时候，很多细节的地方，我也没有注意到，然后看了一下他的四篇博客，记录一下：&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;第一部分重点讲的是两个属性: &lt;code&gt;Content Compression Resistance&lt;/code&gt;、&lt;code&gt;Content Hugging&lt;/code&gt;,这里我觉得作者的解释还是形象的：&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="日志" scheme="http://www.ghcoder.com/categories/%E6%97%A5%E5%BF%97/"/>
    
    
      <category term="Object-C" scheme="http://www.ghcoder.com/tags/Object-C/"/>
    
  </entry>
  
  <entry>
    <title>学习Swift Tips</title>
    <link href="http://www.ghcoder.com/2017/09/01/20170901/"/>
    <id>http://www.ghcoder.com/2017/09/01/20170901/</id>
    <published>2017-09-01T06:11:12.000Z</published>
    <updated>2017-09-07T08:05:53.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="onvcate的《Swift开发者必备的Tips》之前刚出的时候，我就翻阅过，后来Swift的版本一直在改，我也就懒得去看了-现在Swift的ABI基本都稳定了，我在回顾复习一下这本书，记录一下要点："><a href="#onvcate的《Swift开发者必备的Tips》之前刚出的时候，我就翻阅过，后来Swift的版本一直在改，我也就懒得去看了-现在Swift的ABI基本都稳定了，我在回顾复习一下这本书，记录一下要点：" class="headerlink" title="onvcate的《Swift开发者必备的Tips》之前刚出的时候，我就翻阅过，后来Swift的版本一直在改，我也就懒得去看了,现在Swift的ABI基本都稳定了，我在回顾复习一下这本书，记录一下要点："></a>onvcate的《Swift开发者必备的Tips》之前刚出的时候，我就翻阅过，后来Swift的版本一直在改，我也就懒得去看了,现在Swift的ABI基本都稳定了，我在回顾复习一下这本书，记录一下要点：</h3><h4 id="协议中的read-only的属性值："><a href="#协议中的read-only的属性值：" class="headerlink" title="协议中的read-only的属性值："></a>协议中的read-only的属性值：</h4><ul><li>在protocol中给在方法前面添加<code>mutating</code>，可以修改<code>Struct</code>、<code>Enum</code>中的属性值, 在<code>Class</code>中本来就可以修改，所以可以直接忽视<code>mutating</code>。</li><li>首先我们来想一下，怎么在<code>protocol</code>中定义一个只读的属性值:</li></ul><a id="more"></a><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">protocol Vehicle &#123;</span><br><span class="line">    <span class="selector-tag">var</span> number: Int &#123; get &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct MyCar: Vehicle &#123;</span><br><span class="line">    <span class="selector-tag">var</span> number: Int</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">var</span> car = MyCar(number: <span class="number">3</span>)</span><br><span class="line">car.number</span><br><span class="line"></span><br><span class="line">car<span class="selector-class">.number</span> = <span class="number">10</span></span><br><span class="line"></span><br><span class="line">car.number</span><br></pre></td></tr></table></figure><ul><li>当我写完这段代码的时候，我发现，我定义的只读属性<code>number</code>,但是这里为什么？我还可以设置呢？我google了一下：[<a href="https://stackoverflow.com/questions/31358518/read-only-properties-of-protocols-in-swift]" target="_blank" rel="noopener">https://stackoverflow.com/questions/31358518/read-only-properties-of-protocols-in-swift]</a></li></ul><blockquote><p>There’s no way to specify in a protocol that you must have a read-only property. Your protocol asks for a car.number property, and allows but does not require a setter.</p></blockquote><ul><li>这里我的理解就是，当你实例化一个<code>car</code>的对象，并且调用car.xxx某个属性值的时候，你并没有限制他的xxx属性值是只读的。所以我们只需要修改car的那行代码：</li></ul><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">var </span><span class="string">car:</span> <span class="string">Vehicle </span>= <span class="string">MyCar(</span><span class="string">number:</span> 3)</span><br><span class="line"></span><br><span class="line"><span class="string">car.</span><span class="string">number</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">car.</span><span class="string">number </span>= <span class="string">10 </span>// <span class="string">error:</span>  <span class="string">'number'</span> <span class="string">is </span>a <span class="built_in">get-only</span> <span class="string">property</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">car.</span><span class="string">number</span></span><br></pre></td></tr></table></figure><hr><ul><li>那么我现在在协议中定义一个新的方法，这个方法做什么呢？就是修改协议里面的变量值，代码如下：</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Vehicle</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> number: <span class="type">Int</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">changeNumber</span><span class="params">()</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">MyCar</span>: <span class="title">Vehicle</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> number: <span class="type">Int</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">changeNumber</span><span class="params">()</span></span> &#123;</span><br><span class="line">        number = <span class="number">99</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> car: <span class="type">Vehicle</span> = <span class="type">MyCar</span>(number: <span class="number">12</span>)</span><br><span class="line"></span><br><span class="line">car.number</span><br><span class="line"></span><br><span class="line">car.changeNumber()</span><br><span class="line"></span><br><span class="line">car.number</span><br></pre></td></tr></table></figure><ul><li>惊奇的发现，居然可以修改这个只读的属性值了？？我又懵逼了。查看了官方的<code>Demo</code>[<a href="https://developer.apple.com/library/content/documentation/Swift/Conceptual/Swift_Programming_Language/Protocols.html]" target="_blank" rel="noopener">https://developer.apple.com/library/content/documentation/Swift/Conceptual/Swift_Programming_Language/Protocols.html]</a></li><li>这里的属性值我只是简单的定义了下，没有通过computed value来定义值，按照官方的demo，我们直接修改代码如下：</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Vehicle</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> number: <span class="type">Int</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">changeNumber</span><span class="params">()</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">MyCar</span>: <span class="title">Vehicle</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> customInt: <span class="type">Int</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> number: <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> customInt</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">changeNumber</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">//        number = 99</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> car: <span class="type">Vehicle</span> = <span class="type">MyCar</span>(customInt: <span class="number">12</span>)</span><br><span class="line"></span><br><span class="line">car.number</span><br><span class="line"></span><br><span class="line">car.changeNumber()</span><br><span class="line"></span><br><span class="line">car.number</span><br></pre></td></tr></table></figure><ul><li>这样一旦我调用ChangeNumber的方法的时候，你就会发现报错了。</li></ul><hr><ul><li>下面说了<code>for in</code>的使用，大家应该都知道，<code>for in</code>的循环，我们都可以使用在集合类型的上面，但是在swift中我其实是可以将<code>for in</code>用在我们自定义的类型上面。在Apple的官方文档上也给了一个说明：[<a href="https://developer.apple.com/documentation/swift/iteratorprotocol]" target="_blank" rel="noopener">https://developer.apple.com/documentation/swift/iteratorprotocol]</a></li><li>首先能使用<code>for in</code>来枚举的对象，必须遵循<code>Sequence</code>,看里面的源码会发现里面除了很多的方法就只剩两个属性值的设置：</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// A type that provides the sequence's iteration interface and</span></span><br><span class="line"> <span class="comment">/// encapsulates its iteration state.</span></span><br><span class="line"> <span class="keyword">associatedtype</span> <span class="type">Iterator</span> : <span class="type">IteratorProtocol</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">/// A type that represents a subsequence of some of the sequence's elements.</span></span><br><span class="line"> <span class="keyword">associatedtype</span> <span class="type">SubSequence</span></span><br><span class="line"></span><br><span class="line">     <span class="comment">/// Returns an iterator over the elements of this sequence.</span></span><br><span class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">makeIterator</span><span class="params">()</span></span> -&gt; <span class="type">Self</span>.<span class="type">Iterator</span></span><br></pre></td></tr></table></figure><ul><li>按照官方的意思，我们这里其他不需要去实现，这里就实现了一个<code>public func makeIterator() -&gt; Self.Iterator</code>这个方法，可以看出这个方法返回的是一个迭代器，而这个迭代器必须要实现<code>IteratorProtocol</code>的协议：</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">protocol</span> <span class="title">IteratorProtocol</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// The type of element traversed by the iterator.</span></span><br><span class="line">    <span class="keyword">associatedtype</span> <span class="type">Element</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Advances to the next element and returns it, or `nil` if no next element</span></span><br><span class="line">    <span class="comment">/// exists.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// Repeatedly calling this method returns, in order, all the elements of the</span></span><br><span class="line">    <span class="comment">/// underlying sequence. As soon as the sequence has run out of elements, all</span></span><br><span class="line">    <span class="comment">/// subsequent calls return `nil`.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// You must not call this method if any other copy of this iterator has been</span></span><br><span class="line">    <span class="comment">/// advanced with a call to its `next()` method.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// The following example shows how an iterator can be used explicitly to</span></span><br><span class="line">    <span class="comment">/// emulate a `for`-`in` loop. First, retrieve a sequence's iterator, and</span></span><br><span class="line">    <span class="comment">/// then call the iterator's `next()` method until it returns `nil`.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">///     let numbers = [2, 3, 5, 7]</span></span><br><span class="line">    <span class="comment">///     var numbersIterator = numbers.makeIterator()</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">///     while let num = numbersIterator.next() &#123;</span></span><br><span class="line">    <span class="comment">///         print(num)</span></span><br><span class="line">    <span class="comment">///     &#125;</span></span><br><span class="line">    <span class="comment">///     // Prints "2"</span></span><br><span class="line">    <span class="comment">///     // Prints "3"</span></span><br><span class="line">    <span class="comment">///     // Prints "5"</span></span><br><span class="line">    <span class="comment">///     // Prints "7"</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Returns: The next element in the underlying sequence, if a next element</span></span><br><span class="line">    <span class="comment">///   exists; otherwise, `nil`.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">next</span><span class="params">()</span></span> -&gt; <span class="type">Self</span>.<span class="type">Element</span>?</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>上面的注释也说明了一些，这里其实就是一个<code>迭代器模式</code>，不断的调用next()的方法，知道返回nil，官方的例子上面没有用到<code>Element</code>,就只是将返回的类型定义为<code>Int?</code>,只是用了<code>next</code>的方法：</li><li>并且之前我们也看到了<code>CountdownIterator</code>的实例化方法，将自己这个结构体传入了进去,所以这里就定义了一个内部变量<code>countdown</code>:</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Coundown</span>: <span class="title">Sequence</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> start: <span class="type">Int</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">makeIterator</span><span class="params">()</span></span> -&gt; <span class="type">CoundownIterator</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">CoundownIterator</span>(<span class="keyword">self</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">CoundownIterator</span>: <span class="title">IteratorProtocol</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> countdown: <span class="type">Coundown</span></span><br><span class="line">    <span class="keyword">var</span> times = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>(<span class="number">_</span> countdown: <span class="type">Coundown</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.countdown = countdown</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">next</span><span class="params">()</span></span> -&gt; <span class="type">Int</span>? &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> nextNumber = countdown.start - times</span><br><span class="line">        <span class="keyword">guard</span> nextNumber &gt; <span class="number">0</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</span><br><span class="line"></span><br><span class="line">        times += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> nextNumber</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> threeTwoOne = <span class="type">Coundown</span>(start: <span class="number">3</span>)</span><br><span class="line"><span class="keyword">for</span> <span class="built_in">count</span> <span class="keyword">in</span> threeTwoOne &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\(count)..."</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>上面的例子还是通俗易懂的，但是唯一的缺点就是有些属性没用，可能他觉得没必要吧，看一下onevcate的例子：</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ReverseSequence</span>&lt;<span class="title">T</span>&gt;: <span class="title">Sequence</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> array: [<span class="type">T</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>(array: [<span class="type">T</span>]) &#123;</span><br><span class="line">        <span class="keyword">self</span>.array = array</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">typealias</span> <span class="type">Iterator</span> = <span class="type">ReverseItrator</span>&lt;<span class="type">T</span>&gt;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">makeIterator</span><span class="params">()</span></span> -&gt; <span class="type">ReverseItrator</span>&lt;<span class="type">T</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">ReverseItrator</span>(array: <span class="keyword">self</span>.array)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ReverseItrator</span>&lt;<span class="title">T</span>&gt;: <span class="title">IteratorProtocol</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">typealias</span> <span class="type">Element</span> = <span class="type">T</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> array: [<span class="type">Element</span>]</span><br><span class="line">    <span class="keyword">var</span> currentIndex = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>(array: [<span class="type">T</span>]) &#123;</span><br><span class="line">        <span class="keyword">self</span>.array = array</span><br><span class="line">        currentIndex = array.<span class="built_in">count</span> - <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">next</span><span class="params">()</span></span> -&gt; <span class="type">T</span>? &#123;</span><br><span class="line">        <span class="keyword">if</span> currentIndex &lt; <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> element = <span class="keyword">self</span>.array[currentIndex]</span><br><span class="line">            currentIndex -= <span class="number">1</span></span><br><span class="line">            <span class="keyword">return</span> element</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> arr = [<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="type">ReverseSequence</span>(array: arr) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Index: \(i) is \(arr[i])"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>其实这里会发现<code>typealias Iterator = ReverseItrator&lt;T&gt;</code>, <code>typealias Element = T</code>写了这些之后，相应协议中的返回值就是自动生成，但是如果你想代码简洁，其实可以忽略这些属性值，直接设置也是可以的。</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;onvcate的《Swift开发者必备的Tips》之前刚出的时候，我就翻阅过，后来Swift的版本一直在改，我也就懒得去看了-现在Swift的ABI基本都稳定了，我在回顾复习一下这本书，记录一下要点：&quot;&gt;&lt;a href=&quot;#onvcate的《Swift开发者必备的Tips》之前刚出的时候，我就翻阅过，后来Swift的版本一直在改，我也就懒得去看了-现在Swift的ABI基本都稳定了，我在回顾复习一下这本书，记录一下要点：&quot; class=&quot;headerlink&quot; title=&quot;onvcate的《Swift开发者必备的Tips》之前刚出的时候，我就翻阅过，后来Swift的版本一直在改，我也就懒得去看了,现在Swift的ABI基本都稳定了，我在回顾复习一下这本书，记录一下要点：&quot;&gt;&lt;/a&gt;onvcate的《Swift开发者必备的Tips》之前刚出的时候，我就翻阅过，后来Swift的版本一直在改，我也就懒得去看了,现在Swift的ABI基本都稳定了，我在回顾复习一下这本书，记录一下要点：&lt;/h3&gt;&lt;h4 id=&quot;协议中的read-only的属性值：&quot;&gt;&lt;a href=&quot;#协议中的read-only的属性值：&quot; class=&quot;headerlink&quot; title=&quot;协议中的read-only的属性值：&quot;&gt;&lt;/a&gt;协议中的read-only的属性值：&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;在protocol中给在方法前面添加&lt;code&gt;mutating&lt;/code&gt;，可以修改&lt;code&gt;Struct&lt;/code&gt;、&lt;code&gt;Enum&lt;/code&gt;中的属性值, 在&lt;code&gt;Class&lt;/code&gt;中本来就可以修改，所以可以直接忽视&lt;code&gt;mutating&lt;/code&gt;。&lt;/li&gt;
&lt;li&gt;首先我们来想一下，怎么在&lt;code&gt;protocol&lt;/code&gt;中定义一个只读的属性值:&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="日志" scheme="http://www.ghcoder.com/categories/%E6%97%A5%E5%BF%97/"/>
    
    
      <category term="Swift" scheme="http://www.ghcoder.com/tags/Swift/"/>
    
  </entry>
  
  <entry>
    <title>学习YYText(一)</title>
    <link href="http://www.ghcoder.com/2017/08/30/20170830/"/>
    <id>http://www.ghcoder.com/2017/08/30/20170830/</id>
    <published>2017-08-30T08:11:12.000Z</published>
    <updated>2017-09-01T10:05:33.000Z</updated>
    
    <content type="html"><![CDATA[<h4 id="YY系列的很多代码都写的很棒，最近很多地方都用到富文本，所以决定用YYText-用之前看了一下里面的代码，觉得还是有很多地方要学习的。代码量非常大，所以可能要分几篇博客分别去写，简单的逻辑就不写了。"><a href="#YY系列的很多代码都写的很棒，最近很多地方都用到富文本，所以决定用YYText-用之前看了一下里面的代码，觉得还是有很多地方要学习的。代码量非常大，所以可能要分几篇博客分别去写，简单的逻辑就不写了。" class="headerlink" title="YY系列的很多代码都写的很棒，最近很多地方都用到富文本，所以决定用YYText,用之前看了一下里面的代码，觉得还是有很多地方要学习的。代码量非常大，所以可能要分几篇博客分别去写，简单的逻辑就不写了。"></a>YY系列的很多代码都写的很棒，最近很多地方都用到富文本，所以决定用<code>YYText</code>,用之前看了一下里面的代码，觉得还是有很多地方要学习的。代码量非常大，所以可能要分几篇博客分别去写，简单的逻辑就不写了。</h4><ul><li>看<code>demo</code>里面，第一行的代码，关于的测试部分就写的很简单，但是深究下去，还是有很多值得学习的地方的：</li></ul><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里的self只是一个传入的ViewController的实例</span></span><br><span class="line">[<span class="meta">YYTextExampleHelper addDebugOptionToViewController:self</span>];</span><br></pre></td></tr></table></figure><a id="more"></a><ul><li>这里传入的vc只是用来设置navigationItem的，这里是设置的一个UISwicher的UI控件，这里存在一个方法：</li></ul><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="name">switcher</span> addBlockForControlEvents:UIControlEventValueChanged block:^(<span class="name">UISwitch</span> *sender) &#123;</span><br><span class="line">      [<span class="name">self</span> setDebug:sender.isOn]<span class="comment">;</span></span><br><span class="line">  &#125;]<span class="comment">;</span></span><br></pre></td></tr></table></figure><ul><li>仔细一看就会发现问题，UISwich的实例变量可以直接调用<code>addBlockForControlEvents</code>的方法，传入了<code>Event</code>和<code>block</code>:</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">UIControl</span> (<span class="title">YYAdd</span>)</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)addBlockForControlEvents:(<span class="built_in">UIControlEvents</span>)controlEvents</span><br><span class="line">                           block:(<span class="keyword">void</span> (^)(<span class="keyword">id</span> sender))block &#123;</span><br><span class="line">    _YYUIControlBlockTarget *target = [[_YYUIControlBlockTarget alloc]</span><br><span class="line">                                       initWithBlock:block events:controlEvents];</span><br><span class="line">    [<span class="keyword">self</span> addTarget:target action:<span class="keyword">@selector</span>(invoke:) forControlEvents:controlEvents];</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *targets = [<span class="keyword">self</span> _yy_allUIControlBlockTargets];</span><br><span class="line">    [targets addObject:target];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSMutableArray</span> *)_yy_allUIControlBlockTargets &#123;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *targets = objc_getAssociatedObject(<span class="keyword">self</span>, &amp;block_key);</span><br><span class="line">    <span class="keyword">if</span> (!targets) &#123;</span><br><span class="line">        targets = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">        objc_setAssociatedObject(<span class="keyword">self</span>, &amp;block_key, targets, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> targets;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">_YYUIControlBlockTarget</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="keyword">void</span> (^block)(<span class="keyword">id</span> sender);</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">UIControlEvents</span> events;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)initWithBlock:(<span class="keyword">void</span> (^)(<span class="keyword">id</span> sender))block events:(<span class="built_in">UIControlEvents</span>)events;</span><br><span class="line">- (<span class="keyword">void</span>)invoke:(<span class="keyword">id</span>)sender;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">_YYUIControlBlockTarget</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)initWithBlock:(<span class="keyword">void</span> (^)(<span class="keyword">id</span> sender))block events:(<span class="built_in">UIControlEvents</span>)events &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        _block = [block <span class="keyword">copy</span>];</span><br><span class="line">        _events = events;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)invoke:(<span class="keyword">id</span>)sender &#123;</span><br><span class="line">    <span class="keyword">if</span> (_block) _block(sender);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><ul><li>这里点到源码里面可以看到，YY作者写了一个<code>UIControl</code>的category，来作了拓展，提供了<code>addBlockForControlEvents</code>这个方法，这也就解释了上面可以调用这个方法。</li><li>发现作者拿到<code>UIControlEvents</code>和<code>block</code>，直接生成了一个<code>_YYUIControlBlockTarget</code>实例。发现生成的这个实例，也做什么特别的事情，就是把block copy保存下来，events也保存下来。</li><li>然后它还是调用了系统的<code>addTarget:action:forControlEvents</code>，直接调用<code>invoke:</code>的方法，其实就是调用了我传入进来的<code>block</code>。</li><li>下面可以看到作者通过<code>runtime</code>给这个category生成了一个<code>NSMutableArry</code>的属性值，并且把我的target对象保存起来。</li><li>其实通过看源码就可以发现作者这么写这个category，就做了两件事情，第一可以用block, 第二可以方便直接remove掉相关对象上事件。</li></ul><hr><ul><li>在事件成功触发的时候，就会调用下面的方法：</li></ul><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">void</span>)<span class="string">setDebug:</span>(BOOL)debug &#123;</span><br><span class="line">    YYTextDebugOption *debugOptions = [YYTextDebugOption <span class="keyword">new</span>];</span><br><span class="line">    <span class="keyword">if</span> (debug) &#123;</span><br><span class="line">        debugOptions.baselineColor = [UIColor redColor];</span><br><span class="line">        debugOptions.CTFrameBorderColor = [UIColor redColor];</span><br><span class="line">        debugOptions.CTLineFillColor = [UIColor <span class="string">colorWithRed:</span><span class="number">0.000</span> <span class="string">green:</span><span class="number">0.463</span> <span class="string">blue:</span><span class="number">1.000</span> <span class="string">alpha:</span><span class="number">0.180</span>];</span><br><span class="line">        debugOptions.CGGlyphBorderColor = [UIColor <span class="string">colorWithRed:</span><span class="number">1.000</span> <span class="string">green:</span><span class="number">0.524</span> <span class="string">blue:</span><span class="number">0.000</span> <span class="string">alpha:</span><span class="number">0.200</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [debugOptions clear];</span><br><span class="line">    &#125;</span><br><span class="line">    [YYTextDebugOption <span class="string">setSharedDebugOption:</span>debugOptions];</span><br><span class="line">    DebugEnabled = debug;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="meta">@interface</span> <span class="string">YYTextDebugOption :</span> NSObject &lt;NSCopying&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> Set a debug option as shared debug option.</span></span><br><span class="line"><span class="comment"> This method must be called on main thread.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> <span class="doctag">@discussion</span> When call this method, the new option will set to all debug target</span></span><br><span class="line"><span class="comment"> which is added by `addDebugTarget:`.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> <span class="doctag">@param</span> option  A new debug option (nil is valid).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="keyword">void</span>)<span class="string">setSharedDebugOption:</span>(nullable YYTextDebugOption *)option;</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure><ul><li>在这个类方法中主要涉及到的一个对象为<code>YYTextDebugOption</code>,这个对象只是一个继承自NSObject的对象，这里没毛病。</li><li><p>生成实例对象之后，我们需要设置不同的值，然后还是通过自己的类方法，将上面的生成的这个对象通过参数出入进去。</p></li><li><p>在<code>YYTextDebugOption</code>里面：</p></li></ul><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">+ (void)setSharedDebugOption:(YYTextDebugOption *)option &#123;</span><br><span class="line">    NSAssert([NSThread isMainThread], @<span class="string">"This method must be called on the main thread"</span>)<span class="comment">;</span></span><br><span class="line">    _setSharedDebugOption(option)<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">static void _setSharedDebugOption(YYTextDebugOption *option) &#123;</span><br><span class="line">    _initSharedDebug()<span class="comment">;</span></span><br><span class="line">    pthread_mutex_lock(&amp;_sharedDebugLock)<span class="comment">;</span></span><br><span class="line">    _sharedDebugOption = option.copy<span class="comment">;</span></span><br><span class="line">    CFSetApplyFunction(_sharedDebugTargets, _sharedDebugSetFunction, NULL)<span class="comment">;</span></span><br><span class="line">    pthread_mutex_unlock(&amp;_sharedDebugLock)<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">static void _initSharedDebug() &#123;</span><br><span class="line">    static <span class="keyword">dispatch_once_t </span>onceToken<span class="comment">;</span></span><br><span class="line">    <span class="keyword">dispatch_once(&amp;onceToken, </span>^&#123;</span><br><span class="line">        pthread_mutex_init(&amp;_sharedDebugLock, NULL)<span class="comment">;</span></span><br><span class="line">        CFSetCallBacks callbacks = kCFTypeSetCallBacks<span class="comment">;</span></span><br><span class="line">        callbacks.retain = _sharedDebugSetRetain<span class="comment">;</span></span><br><span class="line">        callbacks.release = _sharedDebugSetRelease<span class="comment">;</span></span><br><span class="line">        _sharedDebugTargets = CFSetCreateMutable(CFAllocatorGetDefault(), <span class="number">0</span>, &amp;callbacks)<span class="comment">;</span></span><br><span class="line">    &#125;)<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>这里首页确保了设置的的时候，必须是要主线程去调用，其实这里这样写，和后面通过锁来存储对象效果是一致的。</li><li>这里发现作者都是些的c函数，这里我不太确定，为什么不用oc呢？</li><li>这里作者写了一个单例，并且初始化了<code>pthread_mutex_init(&amp;_sharedDebugLock, NULL);</code>锁的值</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//1：pthread_mutex_init(pthread_mutex_t * mutex,const pthread_mutexattr_t *attr);</span></span><br><span class="line">初始化锁变量mutex。attr为锁属性，<span class="literal">NULL</span>值为默认属性。</span><br><span class="line"><span class="comment">//2：pthread_mutex_lock(pthread_mutex_t *mutex);加锁</span></span><br><span class="line"><span class="comment">//3：pthread_mutex_tylock(pthread_mutex_t *mutex);加锁，但是与2不一样的是当锁已经在使用的时候，返回为EBUSY，而不是挂起等待。</span></span><br><span class="line"><span class="comment">//4：pthread_mutex_unlock(pthread_mutex_t *mutex);释放锁</span></span><br><span class="line"><span class="comment">//5：pthread_mutex_destroy(pthread_mutex_t *mutex);使用完后释放</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">__OSX_AVAILABLE_STARTING(__MAC_10_4, __IPHONE_2_0)</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_mutex_init</span><span class="params">(<span class="keyword">pthread_mutex_t</span> * __restrict,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">const</span> <span class="keyword">pthread_mutexattr_t</span> * _Nullable __restrict)</span></span>;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><ul><li>看代码可以发现，这里需要传入两个值，第一个值是用来表示这个锁的标记，同样第二只默认为Null</li></ul><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CFSetCallBacks callbacks = kCFTypeSetCallBacks<span class="comment">;</span></span><br><span class="line">   callbacks.retain = _sharedDebugSetRetain<span class="comment">;</span></span><br><span class="line">   callbacks.release = _sharedDebugSetRelease<span class="comment">;</span></span><br><span class="line">   _sharedDebugTargets = CFSetCreateMutable(CFAllocatorGetDefault(), <span class="number">0</span>, &amp;callbacks)<span class="comment">;</span></span><br></pre></td></tr></table></figure><ul><li>这里的几行代码，其实是通过c的方法是，来生成一个容器属性，类似<code>NSArray,NSDictionary,NSSet</code>,通过源码就可以发现其实就是一个结构体，结构体里面定义的属性值，就是我们需要定义这个容器变量的值，可以猜出来，<code>release</code>/<code>retain</code>是设置对象的内存管理的，<code>equal</code>/<code>hash</code>是对象存储的方式，当然啦，通过c生成的函数，我们可以转化为<code>Foundation</code>的属性值,可以通过类似这样的方式来生成<code>return (NSMutableSet *)CFBridgingRelease(CFSetCreateMutable(0, 0, &amp;callbacks));</code></li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="built_in">CFIndex</span>version;</span><br><span class="line">    <span class="built_in">CFSetRetainCallBack</span><span class="keyword">retain</span>;</span><br><span class="line">    <span class="built_in">CFSetReleaseCallBack</span>release;</span><br><span class="line">    <span class="built_in">CFSetCopyDescriptionCallBack</span>copyDescription;</span><br><span class="line">    <span class="built_in">CFSetEqualCallBack</span>equal;</span><br><span class="line">    <span class="built_in">CFSetHashCallBack</span>hash;</span><br><span class="line">&#125; <span class="built_in">CFSetCallBacks</span>;</span><br></pre></td></tr></table></figure><ul><li>通过代码可以看出来，其实作者就是想保证，始终只有一个<code>YYTextDebugOption *option</code>的存在。通过获取这个<code>option</code>的值，就知道你的设置了。</li></ul><hr><ul><li>关键设置<code>Text</code>的相关代码：</li></ul><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">NSMutableAttributedString *text = [NSMutableAttributedString new]<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">   &#123;</span><br><span class="line">       NSMutableAttributedString *one = [[NSMutableAttributedString alloc] initWithString:@<span class="string">"Shadow"</span>]<span class="comment">;</span></span><br><span class="line">       one.yy_font = [UIFont <span class="keyword">boldSystemFontOfSize:30];</span></span><br><span class="line"><span class="keyword"> </span>      one.yy_color = [UIColor whiteColor]<span class="comment">;</span></span><br><span class="line">       YYTextShadow *<span class="keyword">shadow </span>= [YYTextShadow new]<span class="comment">;</span></span><br><span class="line">       <span class="keyword">shadow.color </span>= [UIColor colorWithWhite:<span class="number">0</span>.<span class="number">000</span> alpha:<span class="number">0</span>.<span class="number">490</span>]<span class="comment">;</span></span><br><span class="line">       <span class="keyword">shadow.offset </span>= CGSizeMake(<span class="number">0</span>, <span class="number">1</span>)<span class="comment">;</span></span><br><span class="line">       <span class="keyword">shadow.radius </span>= <span class="number">5</span><span class="comment">;</span></span><br><span class="line">       one.yy_textShadow = <span class="keyword">shadow;</span></span><br><span class="line"><span class="keyword"> </span>      [text appendAttributedString:one]<span class="comment">;</span></span><br><span class="line">       [text appendAttributedString:[self padding]]<span class="comment">;</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><ul><li>这里设置<code>yy_font</code>、<code>yy_color</code>的时候，用法和我们之前设置label的属性设置一模一样，这里点进去可以发现，这里是因为作者写了一个<code>NSMutableAttributedString</code>的一个<code>category</code>，和之前的做法一样,在setter值的时候，作者覆写了setter的值方法，统一都调用了一个同一个的方法：</li></ul><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">- (<span class="keyword">void</span>)<span class="string">yy_setFont:</span>(UIFont *)font <span class="string">range:</span>(NSRange)range &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     In iOS7 and later, UIFont is toll-free bridged to CTFontRef,</span></span><br><span class="line"><span class="comment">     although Apple does not mention it in documentation.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     In iOS6, UIFont is a wrapper for CTFontRef, so CoreText can alse use UIfont,</span></span><br><span class="line"><span class="comment">     but UILabel/UITextView cannot use CTFontRef.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     We use UIFont for both CoreText and UIKit.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    [self <span class="string">yy_setAttribute:</span>NSFontAttributeName <span class="string">value:</span>font <span class="string">range:</span>range];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)<span class="string">yy_setColor:</span>(UIColor *)color <span class="string">range:</span>(NSRange)range &#123;</span><br><span class="line">    [self <span class="string">yy_setAttribute:</span>(id)kCTForegroundColorAttributeName <span class="string">value:</span>(id)color.CGColor <span class="string">range:</span>range];</span><br><span class="line">    [self <span class="string">yy_setAttribute:</span>NSForegroundColorAttributeName <span class="string">value:</span>color <span class="string">range:</span>range];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)<span class="string">yy_setAttribute:</span>(NSString *)name <span class="string">value:</span>(id)value <span class="string">range:</span>(NSRange)range &#123;</span><br><span class="line">    <span class="keyword">if</span> (!name || [NSNull <span class="string">isEqual:</span>name]) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (value &amp;&amp; ![NSNull <span class="string">isEqual:</span>value]) [self <span class="string">addAttribute:</span>name <span class="string">value:</span>value <span class="string">range:</span>range];</span><br><span class="line">    <span class="keyword">else</span> [self <span class="string">removeAttribute:</span>name <span class="string">range:</span>range];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure><ul><li>这里其实已经很明显了，所有的设置属性的时候，都是调用的这个方法，如果存在这个值，就设置上去，没有，就去除掉。</li><li>这里在设置颜色的时候，连着设置了两个属性，我查了一下，但是网上都没有说的很清楚，应该是<code>就是为了某些版本的兼容问题的吧，看一下matt大神的解释吧：</code> [<a href="https://github.com/TTTAttributedLabel/TTTAttributedLabel/pull/416]" target="_blank" rel="noopener">https://github.com/TTTAttributedLabel/TTTAttributedLabel/pull/416]</a></li></ul><blockquote><p>Unfortunately, this patch appears to actually degrade support for iOS 8, as NS text attributes do not seem to apply in Core Text rendering for whatever reason.</p></blockquote><blockquote><p>As inconvenient as they are, everything works in iOS 4 – 8 if kCT. Am I missing something? This feels like more of a “if it ain’t broke, don’t fix it” type of situation…</p></blockquote><ul><li>关键这里的shadow让人看的很懵逼，因为看代码就可以知道，作者这里自定义了一个继承了<code>NSObject</code>的<code>Shadow</code>对象<code>YYTextShadow *shadow = [YYTextShadow new];</code>,同样它和设置font，color一样，都是最终调用到了<code>- (void)yy_setAttribute:(NSString *)name value:(id)value range:(NSRange)range {}</code>,<strong>前面我好理解，他都是设置的系统的设置，所以你不管设置font，color其实最终都是走到系统的设置上去了，但是这里设置的对象，key都是自定义的，这里系统是怎么认识的呢？开始看到这里的时候，我就有点不是很理解了，但是当我看到下面的时候我就明白了。</strong></li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">YYLabel *<span class="keyword">label</span><span class="bash"> = [YYLabel new];</span></span><br><span class="line"><span class="bash"> label.attributedText = text;</span></span><br><span class="line"><span class="bash"> label.width = self.view.width;</span></span><br><span class="line"><span class="bash"> label.height = self.view.height - (kiOS7Later ? 64 : 44);</span></span><br><span class="line"><span class="bash"> label.top = (kiOS7Later ? 64 : 0);</span></span><br><span class="line"><span class="bash"> label.textAlignment = NSTextAlignmentCenter;</span></span><br><span class="line"><span class="bash"> label.textVerticalAlignment = YYTextVerticalAlignmentCenter;</span></span><br><span class="line"><span class="bash"> label.numberOfLines = 0;</span></span><br><span class="line"><span class="bash"> label.backgroundColor = [UIColor colorWithWhite:0.933 alpha:1.000];</span></span><br><span class="line"><span class="bash"> [self.view addSubview:label];</span></span><br></pre></td></tr></table></figure><ul><li>首先这里定义一个新的属性值，叫做<code>YYLabel</code>,点进去可以发现，这个<code>YYLabel</code>的对象继承的是<code>UIView</code>的,这里作者要做的应该就是写一个变化的<code>UILabel</code>:</li></ul><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> The YYLabel <span class="built_in">class</span> implements a <span class="built_in">read</span>-only <span class="built_in">text</span> view.</span><br><span class="line"></span><br><span class="line"> @discussion The API <span class="keyword">and</span> behavior <span class="keyword">is</span> similar <span class="keyword">to</span> UILabel, <span class="keyword">but</span> provides more features:</span><br><span class="line"></span><br><span class="line"> * It supports asynchronous layout <span class="keyword">and</span> rendering (<span class="keyword">to</span> avoid blocking UI thread).</span><br><span class="line"> * It extends <span class="keyword">the</span> CoreText attributes <span class="keyword">to</span> support more <span class="built_in">text</span> effects.</span><br><span class="line"> * It allows <span class="keyword">to</span> add UIImage, UIView <span class="keyword">and</span> CALayer <span class="keyword">as</span> <span class="built_in">text</span> attachments.</span><br><span class="line"> * It allows <span class="keyword">to</span> add 'highlight' link <span class="keyword">to</span> <span class="keyword">some</span> range <span class="keyword">of</span> <span class="built_in">text</span> <span class="keyword">to</span> allow user interact <span class="keyword">with</span>.</span><br><span class="line"> * It allows <span class="keyword">to</span> add container path <span class="keyword">and</span> exclusion paths <span class="keyword">to</span> control <span class="built_in">text</span> container's shape.</span><br><span class="line"> * It supports vertical form layout <span class="keyword">to</span> display CJK <span class="built_in">text</span>.</span><br><span class="line"></span><br><span class="line"> See NSAttributedString+YYText.h <span class="keyword">for</span> more convenience methods <span class="keyword">to</span> <span class="keyword">set</span> <span class="keyword">the</span> attributes.</span><br><span class="line"> See YYTextAttribute.h <span class="keyword">and</span> YYTextLayout.h <span class="keyword">for</span> more information.</span><br><span class="line"> */</span><br><span class="line">@interface YYLabel : UIView &lt;NSCoding&gt;</span><br></pre></td></tr></table></figure><ul><li>可以看到YYLabel除了UILabel提供的那些东西外，我们还提供很多牛逼的功能，这些动能的实现，我还没有看，先来看看之前我们设置的<code>NSMutableAttributedString</code>是如何生效的？</li><li>在第二行代码，我们直接将我们前面设置的text属性值进行设定<code>label.attributedText = text;</code>:</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setAttributedText:(<span class="built_in">NSAttributedString</span> *)attributedText &#123;</span><br><span class="line">    <span class="keyword">if</span> (attributedText.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        _innerText = attributedText.mutableCopy;</span><br><span class="line">        <span class="keyword">switch</span> (_lineBreakMode) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="built_in">NSLineBreakByWordWrapping</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="built_in">NSLineBreakByCharWrapping</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="built_in">NSLineBreakByClipping</span>: &#123;</span><br><span class="line">                _innerText.yy_lineBreakMode = _lineBreakMode;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="built_in">NSLineBreakByTruncatingHead</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="built_in">NSLineBreakByTruncatingTail</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="built_in">NSLineBreakByTruncatingMiddle</span>: &#123;</span><br><span class="line">                _innerText.yy_lineBreakMode = <span class="built_in">NSLineBreakByWordWrapping</span>;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>: <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        _innerText = [<span class="built_in">NSMutableAttributedString</span> new];</span><br><span class="line">    &#125;</span><br><span class="line">    [_textParser parseText:_innerText selectedRange:<span class="literal">NULL</span>];</span><br><span class="line">    <span class="keyword">if</span> (!_ignoreCommonProperties) &#123;</span><br><span class="line">        <span class="keyword">if</span> (_displaysAsynchronously &amp;&amp; _clearContentsBeforeAsynchronouslyDisplay) &#123;</span><br><span class="line">            [<span class="keyword">self</span> _clearContents];</span><br><span class="line">        &#125;</span><br><span class="line">        [<span class="keyword">self</span> _updateOuterTextProperties];</span><br><span class="line">        [<span class="keyword">self</span> _setLayoutNeedUpdate];</span><br><span class="line">        [<span class="keyword">self</span> _endTouch];</span><br><span class="line">        [<span class="keyword">self</span> invalidateIntrinsicContentSize];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>这里的代码应该就是解析我们之前设置的<code>NSAttributedString</code>属性。</li><li>按照代码，先判断_lineBreakMode，然后给<code>NSAttributedString</code>设置<code>yy_lineBreakMode</code>的值。</li><li><code>[_textParser parseText:_innerText selectedRange:NULL];</code>这个是一个代理方法，但是我现在我这里的<code>_textParser</code>是<code>nil</code>,那也就不会调用这个代理方法，从函数名字上可以知道，这里的函数主要做的上就是去解析某个<code>Text</code>。</li><li>调用<code>[self _updateOuterTextProperties];</code></li></ul><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">- (void)<span class="variable">_updateOuterTextProperties</span> &#123;</span><br><span class="line">    <span class="variable">_text</span> = [<span class="variable">_innerText</span> yy_plainTextForRange:NSMakeRange(<span class="number">0</span>, <span class="variable">_innerText</span>.length)];</span><br><span class="line">    <span class="variable">_font</span> = <span class="variable">_innerText</span>.yy_font;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">_font</span>) <span class="variable">_font</span> = [self <span class="variable">_defaultFont</span>];</span><br><span class="line">    <span class="variable">_textColor</span> = <span class="variable">_innerText</span>.yy_color;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">_textColor</span>) <span class="variable">_textColor</span> = [UIColor blackColor];</span><br><span class="line">    <span class="variable">_textAlignment</span> = <span class="variable">_innerText</span>.yy_alignment;</span><br><span class="line">    <span class="variable">_lineBreakMode</span> = <span class="variable">_innerText</span>.yy_lineBreakMode;</span><br><span class="line">    NSShadow *shadow = <span class="variable">_innerText</span>.yy_shadow;</span><br><span class="line">    <span class="variable">_shadowColor</span> = shadow.shadowColor;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !TARGET_INTERFACE_BUILDER</span></span><br><span class="line">    <span class="variable">_shadowOffset</span> = shadow.shadowOffset;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="variable">_shadowOffset</span> = CGPointMake(shadow.shadowOffset.width, shadow.shadowOffset.height);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="variable">_shadowBlurRadius</span> = shadow.shadowBlurRadius;</span><br><span class="line">    <span class="variable">_attributedText</span> = <span class="variable">_innerText</span>;</span><br><span class="line">    [self <span class="variable">_updateOuterLineBreakMode</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>从上面的代码的逻辑中我们可以看出，这个函数主要做的事情就是讲我们前面传入进来的<code>NSAttributedString</code>一个个取出来</li><li><code>- (NSString *)yy_plainTextForRange:(NSRange)range {}</code>这个函数的主要是从<code>NSAttributedString</code>中取出Text的值，复制给一个全局的text的值，看一下这里的实现：</li></ul><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">NSString</span> *)yy_plainTextForRange:(<span class="type">NSRange</span>)<span class="built_in">range</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">range</span>.location == <span class="type">NSNotFound</span> ||<span class="built_in">range</span>.length == <span class="type">NSNotFound</span>) <span class="keyword">return</span> <span class="keyword">nil</span>;</span><br><span class="line">    <span class="type">NSMutableString</span> *<span class="literal">result</span> = [<span class="type">NSMutableString</span> <span class="built_in">string</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">range</span>.length == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">result</span>;</span><br><span class="line">    <span class="type">NSString</span> *<span class="built_in">string</span> = self.<span class="built_in">string</span>;</span><br><span class="line">    [self enumerateAttribute:<span class="type">YYTextBackedStringAttributeName</span> inRange:<span class="built_in">range</span> options:kNilOptions usingBlock:^(id value, <span class="type">NSRange</span> <span class="built_in">range</span>, <span class="type">BOOL</span> *stop) &#123;</span><br><span class="line">        <span class="type">YYTextBackedString</span> *backed = value;</span><br><span class="line">        <span class="keyword">if</span> (backed &amp;&amp; backed.<span class="built_in">string</span>) &#123;</span><br><span class="line">            [<span class="literal">result</span> appendString:backed.<span class="built_in">string</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            [<span class="literal">result</span> appendString:[<span class="built_in">string</span> substringWithRange:<span class="built_in">range</span>]];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">result</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>这里他枚举了<code>NSAttributedString</code>的属性值，如果前面设置过<code>YYTextBackedStringAttributeName</code>,这里它会进行拼接，但是我们前面没有设置这个属性，所以，这个枚举出的<code>value = nil</code>。可以通过这里的枚举方法，我们就可以枚举出我们想要<code>attribute</code>值，并进行修改：</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSMutableAttributedString</span> *res = [<span class="keyword">self</span>.richTextEditor.attributedText mutableCopy];</span><br><span class="line"></span><br><span class="line">[res beginEditing];</span><br><span class="line">__block <span class="built_in">BOOL</span> found = <span class="literal">NO</span>;</span><br><span class="line">[res enumerateAttribute:<span class="built_in">NSFontAttributeName</span> inRange:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, res.length) options:<span class="number">0</span> usingBlock:^(<span class="keyword">id</span> value, <span class="built_in">NSRange</span> range, <span class="built_in">BOOL</span> *stop) &#123;</span><br><span class="line">    <span class="keyword">if</span> (value) &#123;</span><br><span class="line">        <span class="built_in">UIFont</span> *oldFont = (<span class="built_in">UIFont</span> *)value;</span><br><span class="line">        <span class="built_in">UIFont</span> *newFont = [oldFont fontWithSize:oldFont.pointSize * <span class="number">2</span>];</span><br><span class="line">        [res removeAttribute:<span class="built_in">NSFontAttributeName</span> range:range];</span><br><span class="line">        [res addAttribute:<span class="built_in">NSFontAttributeName</span> value:newFont range:range];</span><br><span class="line">        found = <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;];</span><br><span class="line"><span class="keyword">if</span> (!found) &#123;</span><br><span class="line">    <span class="comment">// No font was found - do something else?</span></span><br><span class="line">&#125;</span><br><span class="line">[res endEditing];</span><br><span class="line"><span class="keyword">self</span>.richTextEditor.attributedText = res;</span><br></pre></td></tr></table></figure><ul><li>下面就是简单的对全局的值进行赋值,看到这里，就可以稍微明白了之前的自定义设置Shadow的问题了：<code>NSShadow *shadow = _innerText.yy_shadow;</code>,然后将shadow的值进行赋值：</li></ul><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">   <span class="variable">_shadowColor</span> = shadow.shadowColor;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !TARGET_INTERFACE_BUILDER</span></span><br><span class="line">    <span class="variable">_shadowOffset</span> = shadow.shadowOffset;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="variable">_shadowOffset</span> = CGPointMake(shadow.shadowOffset.width, shadow.shadowOffset.height);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="variable">_shadowBlurRadius</span> = shadow.shadowBlurRadius;</span><br></pre></td></tr></table></figure><ul><li>最后又设置了一下<code>- (void)_updateOuterLineBreakMode {}</code>代码如下：</li></ul><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)_updateOuterLineBreakMode &#123;</span><br><span class="line">    <span class="keyword">if</span> (_innerContainer.truncationType) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (_innerContainer.truncationType) &#123;</span><br><span class="line">            <span class="keyword">case</span> YYTextTruncationTypeStart: &#123;</span><br><span class="line">                _lineBreakMode = <span class="built_in">NSLineBreakByTruncatingHead</span>;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> YYTextTruncationTypeEnd: &#123;</span><br><span class="line">                _lineBreakMode = <span class="built_in">NSLineBreakByTruncatingTail</span>;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> YYTextTruncationTypeMiddle: &#123;</span><br><span class="line">                _lineBreakMode = <span class="built_in">NSLineBreakByTruncatingMiddle</span>;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:<span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        _lineBreakMode = _innerText.yy_lineBreakMode;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>这里又设计到了一下新的对象<code>YYTextContainer *_innerContainer;</code>,这里我目前没用到这个值，所以暂且先忽略它。</li><li>下面调用了新的方法<code>- (void)_setLayoutNeedUpdate {}</code>,这个方法设置了一个属性值，然后调用<code>- (void)_clearInnerLayout {}</code>由于这里我们没有设置值，所以直接return掉了，最后调用了一下<code>[self.layer setNeedsDisplay];</code></li><li>在最后的最后调用了<code>[self invalidateIntrinsicContentSize];</code>,这个函数的调用我之前也没有用过，但是看解释应该可以猜出一部分：</li></ul><blockquote><p>call this when something changes that affects the intrinsicContentSize.  Otherwise UIKit won’t notice that it changed.<br>我的猜测是当父视图的发生变化的时候，我们需要调用这个方法来通知子视图也发生了变化。</p></blockquote><h4 id="到目前为止外面只了解完了最最基础的那个函数调用，设置shadow，textcolor，font，足以看出这个yyText的强大了。"><a href="#到目前为止外面只了解完了最最基础的那个函数调用，设置shadow，textcolor，font，足以看出这个yyText的强大了。" class="headerlink" title="到目前为止外面只了解完了最最基础的那个函数调用，设置shadow，textcolor，font，足以看出这个yyText的强大了。"></a>到目前为止外面只了解完了最最基础的那个函数调用，设置shadow，textcolor，font，足以看出这个yyText的强大了。</h4><hr><ul><li>网上找了些资料，大部分都没有说清楚，能说清楚下面两篇文章：可以看看 : [<a href="http://www.jianshu.com/p/f0c33d6c39bb" target="_blank" rel="noopener">http://www.jianshu.com/p/f0c33d6c39bb</a>, <a href="http://blog.csdn.net/wypblog/article/details/7264315]" target="_blank" rel="noopener">http://blog.csdn.net/wypblog/article/details/7264315]</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h4 id=&quot;YY系列的很多代码都写的很棒，最近很多地方都用到富文本，所以决定用YYText-用之前看了一下里面的代码，觉得还是有很多地方要学习的。代码量非常大，所以可能要分几篇博客分别去写，简单的逻辑就不写了。&quot;&gt;&lt;a href=&quot;#YY系列的很多代码都写的很棒，最近很多地方都用到富文本，所以决定用YYText-用之前看了一下里面的代码，觉得还是有很多地方要学习的。代码量非常大，所以可能要分几篇博客分别去写，简单的逻辑就不写了。&quot; class=&quot;headerlink&quot; title=&quot;YY系列的很多代码都写的很棒，最近很多地方都用到富文本，所以决定用YYText,用之前看了一下里面的代码，觉得还是有很多地方要学习的。代码量非常大，所以可能要分几篇博客分别去写，简单的逻辑就不写了。&quot;&gt;&lt;/a&gt;YY系列的很多代码都写的很棒，最近很多地方都用到富文本，所以决定用&lt;code&gt;YYText&lt;/code&gt;,用之前看了一下里面的代码，觉得还是有很多地方要学习的。代码量非常大，所以可能要分几篇博客分别去写，简单的逻辑就不写了。&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;看&lt;code&gt;demo&lt;/code&gt;里面，第一行的代码，关于的测试部分就写的很简单，但是深究下去，还是有很多值得学习的地方的：&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight cs&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// 这里的self只是一个传入的ViewController的实例&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[&lt;span class=&quot;meta&quot;&gt;YYTextExampleHelper addDebugOptionToViewController:self&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="日志" scheme="http://www.ghcoder.com/categories/%E6%97%A5%E5%BF%97/"/>
    
    
      <category term="Swift" scheme="http://www.ghcoder.com/tags/Swift/"/>
    
  </entry>
  
  <entry>
    <title>Core Data的迁移和合并(五)</title>
    <link href="http://www.ghcoder.com/2017/08/22/20170822/"/>
    <id>http://www.ghcoder.com/2017/08/22/20170822/</id>
    <published>2017-08-22T02:11:12.000Z</published>
    <updated>2017-09-01T03:06:15.000Z</updated>
    
    <content type="html"><![CDATA[<h4 id="记得在两年前我去面试的时候，面试官关于Core-data的问题，他们大都只会问你一个问题，基本上你只要能够答出来，就说明还是使用过Core-Data，这个问题就是：“如何迁移Core-Data的数据库”？因为谁都无法预料业务的发展，以及数据库的修改，所以这个问题也是必然会发生的。这里重点列举几个Core-Data数据库迁移的问题："><a href="#记得在两年前我去面试的时候，面试官关于Core-data的问题，他们大都只会问你一个问题，基本上你只要能够答出来，就说明还是使用过Core-Data，这个问题就是：“如何迁移Core-Data的数据库”？因为谁都无法预料业务的发展，以及数据库的修改，所以这个问题也是必然会发生的。这里重点列举几个Core-Data数据库迁移的问题：" class="headerlink" title="记得在两年前我去面试的时候，面试官关于Core data的问题，他们大都只会问你一个问题，基本上你只要能够答出来，就说明还是使用过Core Data，这个问题就是：“如何迁移Core Data的数据库”？因为谁都无法预料业务的发展，以及数据库的修改，所以这个问题也是必然会发生的。这里重点列举几个Core Data数据库迁移的问题："></a>记得在两年前我去面试的时候，面试官关于Core data的问题，他们大都只会问你一个问题，基本上你只要能够答出来，就说明还是使用过Core Data，这个问题就是：“如何迁移Core Data的数据库”？因为谁都无法预料业务的发展，以及数据库的修改，所以这个问题也是必然会发生的。这里重点列举几个Core Data数据库迁移的问题：</h4><ul><li><strong>首先要说一下，如果你的App，只是缓存一些离线数据的话，就没必要考虑什么数据库迁移了，因为你只需要在新版本中，删除之前的core data数据，新建一个就可以了</strong></li></ul><a id="more"></a><hr><ul><li>只是在原有的Entity中添加几个字段,步骤如下：</li></ul><ol><li>点击<code>Editor-&gt;Add Model Version</code>.</li><li>命名新版本的文字就啥：<code>xxx v2</code>.</li><li>如果你有多个Core Data的项目，需要勾选你想要修改的Core Data项目的名字.</li><li>点击创建完成.</li><li>点击<code>File Inspector</code>,在Model Version中勾选你刚才创建的新的Model.</li><li>此时我们就可以勾选进我们新建的Core Data Entity的字段创建表中去，创建你想要修改的字段.</li><li>此时你就可以去想要的xxx.swift的Model Template 的文件中去添加字段了，例如：<code>@NSManaged var image: UIImage?</code></li><li>此时你就可以像使用其他字段一样使用你新建的字段了，例如上面的image<code>xxx.image = xxx</code></li></ol><hr><ul><li>在原有的Entity中删除字段，并且创建新的RelationShip关联到新的Entity对象：</li></ul><ol><li>前面的1-5的操作都是一样的.</li><li>点击Core Data来创建新建的一个Entity,并且设置相应的字段(这里设置Module 为项目的名字).</li><li>然后从我们新建的Entity中建立新的联系去关联到我们之前的Entity(通过设置destination来设置关联).</li><li>并且回到之前的Entity中，删除或者修改我们想要的修改的字段.</li><li>并且在之前的Entity中，建立联系，关联到之前新建的Entity(这里需要设置destination为新建的Entity，并且设置inverse).</li><li>此时已经可以开始准备合并了，在此之前，需要做些修改：</li><li>创建一个新的类，类名和我们新建的Entity的名字一样，并且在里面创建我们新建的字段.</li><li>修改之前Entity对应的Swift类中，增删修改字段.</li><li>下面是最最重要的一步：建立model 映射：</li><li>在<code>New/File</code>中选择<code>Mapping Model</code>,选择你修改的基准的Entity为Source, 选择最新的Entity为Targer Model，名字类似为：<code>UnCloudNotesMappingModel_v2_to_v3</code></li><li>在这个新建的映射的文件中可以看出来，如果是之前就存在Entity的话，那么的它的值<code>Value Expression</code>= <code>$source.xxx</code>，可以看出来这样的数据是没有发生改变的.(<strong>这里的source就是我们开始创建这个文件的时候选择的source是同一个文件，我们可以理解为：v3里面xx字段的值，直接就是取自v2字段的同样的值</strong>).</li><li>刚下已经说了需要新建的一个Entity建立关联，那么必然在这个RelationShip中我们可以看到我们才新建好的Relationship的字段，但是在<code>Value Expression</code>中发现xcode并没有给我们填入什么值，这也是很好理解的，<strong>为这个值，关联的是我们新建Entity值，当然之前的Source不知道啦！！所以你现在要做的就是删除这段关联，因为既然是关联，我可以从a对象关联b对象，那我同样可以从b对象关联到a对象</strong></li><li>勾选新建的Entity对象，发现此时的xode没有给我们勾选Source，这里的理解为：<strong>默认这个新建的Entity的值，所有的值，都是我们自己新建，不需要从之前的Entity中获取值,但是我们这里一旦勾选了source，为某个对象的话，xocde会自动去更加字符创去匹配，获取相应的值，选择了source之后，对应的名字也从xxx改为yyyToxxx</strong>.</li><li>通过之前的理解我们其实可以理解为，每一个note都会关联attachment,但是这里我也可以做一下过滤，如果<code>attachment里的image != nil</code>,才将数据进行关联.</li><li><code>之前xcode为我们创建的Relationship，由于里面的value expression是我们新建的Entity,所以我们将之前的RelationShip删除掉，然后为新建的Entity新建一个relationship关联到之前的旧Entity,并且设置Mapping Name,这里系统就会自动将value expression值填上runtime的函数</code></li><li>最后设置两个属性：</li></ol><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">description</span>.shouldMigrateStoreAutomatically = <span class="keyword">true</span></span><br><span class="line"><span class="keyword">description</span>.shouldInferMappingModelAutomatically = <span class="keyword">false</span></span><br></pre></td></tr></table></figure><hr><ul><li>删除对象的字段，并且建立一个新的Entity,里面包含了其他新建的字段,是并且这个Entity是之前某个Entity的子类.</li></ul><ol><li>前面的1-5的操作都是一样的.</li><li>点击Core Data来创建新建的一个Entity,并且设置相应的字段(这里设置Module 为项目的名字).</li><li>设置新建Entity的Parent Entity,并且也可以设置相应的自定义字段.</li><li>之后新建我们新建(EntityName).swift，根据新建的字段类型，定义字段，此时可以同样表明继承关系<code>class ImageAttachment:Attachment {}</code></li><li>虽然这里创建了我们想要的Entity以及字段，但是之前的旧model如何作转化呢？这里就同样需要映射，因此这里创建了一个新的Mapping Model:<code>UnCloudNotesMappingModel_v3_to_v4</code>.</li><li>这里我们可以更加需要，如果新建的Entity的字段直接来自于之前的某个Model的话，我就可以将这个Model设置为Source，但是如果有些字段没有，或者不是直接可以获取到的话，或者需要从不同的字段中进行一定的逻辑才能够赋值的话，那么这里就需要自定义<code>NSEntityMigrationPolicy</code>,这里我们新建的子类对象，并且将Model的<code>Custom Policy</code>设置为我们新建的子类的话，系统在载入的时候，会进行比较，假如你现在的Core Data的版本确实需要更新的话，就会执行这个类.</li></ol><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AttachmentToImageAttachmentMigrationPolicyV3toV4</span>: <span class="title">NSEntityMigrationPolicy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">createDestinationInstances</span><span class="params">(forSource sInstance: NSManagedObject, <span class="keyword">in</span> mapping: NSEntityMapping, manager: NSMigrationManager)</span></span> <span class="keyword">throws</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.这里会存在两个context，一个读入的source context，一个写入destinationContext.这里当然需要读入的最终的这个context</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> description = <span class="type">NSEntityDescription</span>.entity(forEntityName: <span class="string">"ImageAttachment"</span>,</span><br><span class="line">                                                 <span class="keyword">in</span>: manager.destinationContext)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> newAttachment = <span class="type">ImageAttachment</span>(entity: description!,</span><br><span class="line">                                        insertInto: manager.destinationContext)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. 将属性进行迭代</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">traversePropertyMappings</span><span class="params">(block: <span class="params">(NSPropertyMapping, String)</span></span></span> -&gt; ()) <span class="keyword">throws</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">let</span> attributeMappings = mapping.attributeMappings &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> propertyMapping <span class="keyword">in</span> attributeMappings &#123;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> <span class="keyword">let</span> destinationName = propertyMapping.name &#123;</span><br><span class="line">            block(propertyMapping, destinationName)</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//3.如果这个对象，连相应的属性值都不能反悔的话，那就代表肯定有问题的，需要抛出问题.</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">let</span> message = <span class="string">"Attribute destination not configured properly"</span></span><br><span class="line">            <span class="keyword">let</span> userInfo = [<span class="type">NSLocalizedFailureReasonErrorKey</span>: message]</span><br><span class="line">            <span class="keyword">throw</span> <span class="type">NSError</span>(domain: errorDomain,</span><br><span class="line">                          code: <span class="number">0</span>,</span><br><span class="line">                          userInfo: userInfo)</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> message = <span class="string">"No Attribute Mappings found"</span></span><br><span class="line">        <span class="keyword">let</span> userInfo = [<span class="type">NSLocalizedFailureReasonErrorKey</span>: message]</span><br><span class="line">        <span class="keyword">throw</span> <span class="type">NSError</span>(domain: errorDomain,</span><br><span class="line">                      code: <span class="number">0</span>,</span><br><span class="line">                      userInfo: userInfo)</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 这一步按照映射关系，应该是一一对象进行赋值的</span></span><br><span class="line">    <span class="keyword">try</span>  traversePropertyMappings &#123;</span><br><span class="line">      propertyMapping, destinationName <span class="keyword">in</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">guard</span> <span class="keyword">let</span> valueExpression = propertyMapping.valueExpression <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> context: <span class="type">NSMutableDictionary</span> = [<span class="string">"source"</span>: sInstance]</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> desinationValue = valueExpression.expressionValue(with: sInstance, context: context) <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">        newAttachment.setValue(desinationValue, forKey: destinationName)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. 接下来的数据，你可以进行计算，或者从其他Entity中获取值</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> image = sInstance.value(forKey: <span class="string">"image"</span>) <span class="keyword">as</span>? <span class="type">UIImage</span> &#123;</span><br><span class="line">      newAttachment.setValue(image.size.width, forKey: <span class="string">"width"</span>)</span><br><span class="line">      newAttachment.setValue(image.size.height, forKey: <span class="string">"height"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6.</span></span><br><span class="line">    <span class="keyword">let</span> body = sInstance.value(forKeyPath: <span class="string">"note.body"</span>) <span class="keyword">as</span>? <span class="type">NSString</span> ?? <span class="string">""</span></span><br><span class="line">    newAttachment.setValue(body.substring(to: <span class="number">80</span>), forKey: <span class="string">"caption"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 7. 下面需要将新建的Entity与source object、mapping 之间建立联系，如果在迁移数据接受的时候，此函数调用失败的话，数据会丢失.</span></span><br><span class="line">    manager.associate(sourceInstance: sInstance, withDestinationInstance: newAttachment, <span class="keyword">for</span>: mapping)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><ul><li><p>之前所讲的都是从v1-&gt;v2,从v2-&gt;v3,从v3-&gt;v4，但是这其实是最最简单的情况，但事实情况会比较复杂，因为你永远不知道用户此时是什么版本号？他们可以从v1-&gt;v4,也可以从v2-&gt;v4，那么这样一来就会比较复杂了.此时我们这里就需要进行自定义数据合并了.</p></li><li><p>我们要做的事情，是进行比较，要先从bundle中读取文件名，然后我们从文件名中进行判断，这个bundle是数据v2、v3还是v1.</p></li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">extension NSManagedObjectModel &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">modelURLs</span></span>(</span><br><span class="line">    <span class="keyword">in</span> modelFolder: String) -&gt; [URL] &#123;</span><br><span class="line">    <span class="keyword">return</span> Bundle.main</span><br><span class="line">      .urls(forResourcesWithExtension: <span class="string">"mom"</span>,</span><br><span class="line">      subdirectory: <span class="string">"\(modelFolder).momd"</span>) ?? []</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">modelVersionsFor</span></span>(</span><br><span class="line">    modelNamed modelName: String) -&gt; [NSManagedObjectModel] &#123;</span><br><span class="line">    <span class="keyword">return</span> modelURLs(<span class="keyword">in</span>: modelName)</span><br><span class="line">      .flatMap(NSManagedObjectModel.<span class="keyword">init</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">uncloudNotesModel</span></span>(</span><br><span class="line">    named modelName: String) -&gt; NSManagedObjectModel &#123;</span><br><span class="line">    let model = modelURLs(<span class="keyword">in</span>: <span class="string">"UnCloudNotesDataModel"</span>)</span><br><span class="line">      .filter &#123; $<span class="number">0</span>.lastPathComponent == <span class="string">"\(modelName).mom"</span> &#125;</span><br><span class="line">      .first</span><br><span class="line">      .flatMap(NSManagedObjectModel.<span class="keyword">init</span>)</span><br><span class="line">    <span class="keyword">return</span> model ?? NSManagedObjectModel()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>版本号之前的判断：</li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">var</span> <span class="title">version1</span>: <span class="type">NSManagedObjectModel &#123;</span></span></span><br><span class="line">   <span class="keyword">return</span> uncloudNotesModel(named: <span class="string">"UnCloudNotesDataModel"</span>)</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">var</span> isVersion1: Bool &#123;</span><br><span class="line">   <span class="keyword">return</span> self == type(of: self).version1</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">var</span> <span class="title">version2</span>: <span class="type">NSManagedObjectModel &#123;</span></span></span><br><span class="line">   <span class="keyword">return</span> uncloudNotesModel(named: <span class="string">"UnCloudNotesDataModel v2"</span>)</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">var</span> isVersion2: Bool &#123;</span><br><span class="line">   <span class="keyword">return</span> self == type(of: self).version2</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">var</span> <span class="title">version3</span>: <span class="type">NSManagedObjectModel &#123;</span></span></span><br><span class="line">   <span class="keyword">return</span> uncloudNotesModel(named: <span class="string">"UnCloudNotesDataModel v3"</span>)</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">var</span> isVersion3: Bool &#123;</span><br><span class="line">   <span class="keyword">return</span> self == type(of: self).version3</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">var</span> <span class="title">version4</span>: <span class="type">NSManagedObjectModel &#123;</span></span></span><br><span class="line">   <span class="keyword">return</span> uncloudNotesModel(named: <span class="string">"UnCloudNotesDataModel v4"</span>)</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">var</span> isVersion4: Bool &#123;</span><br><span class="line">   <span class="keyword">return</span> self == type(of: self).version4</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><ul><li>啥时候进行数据迁移呢？</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> stack: <span class="type">CoreDataStack</span> &#123;</span><br><span class="line">  <span class="keyword">guard</span> enableMigrations,</span><br><span class="line">       !store(at: storeURL,</span><br><span class="line">         isCompatibleWithModel: currentModel)</span><br><span class="line">  <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="type">CoreDataStack</span>(modelName: modelName) &#125;</span><br><span class="line">  performMigration()</span><br><span class="line">  <span class="keyword">return</span> <span class="type">CoreDataStack</span>(modelName: modelName)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过获取元数据，并且进行比较，如果需要更新的话，就会将数据返回</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">store</span><span class="params">(at storeURL: URL,</span></span></span><br><span class="line"><span class="function"><span class="params">                     isCompatibleWithModel model: NSManagedObjectModel)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> storeMetadata = metadataForStoreAtURL(storeURL: storeURL)</span><br><span class="line">    <span class="keyword">return</span> model.isConfiguration(withName: <span class="literal">nil</span>, compatibleWithStoreMetadata:storeMetadata)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">metadataForStoreAtURL</span><span class="params">(storeURL: URL)</span></span></span><br><span class="line">    -&gt; [<span class="type">String</span>: <span class="type">Any</span>] &#123;</span><br><span class="line">      <span class="keyword">let</span> metadata: [<span class="type">String</span>: <span class="type">Any</span>]</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">        metadata = <span class="keyword">try</span> <span class="type">NSPersistentStoreCoordinator</span></span><br><span class="line">          .metadataForPersistentStore(ofType: <span class="type">NSSQLiteStoreType</span>,</span><br><span class="line">                                      at: storeURL, options: <span class="literal">nil</span>)</span><br><span class="line">      &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">        metadata = [:]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Error retrieving metadata for store at URL:\(storeURL): \(error)"</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> metadata</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><ul><li>数据如何进行合并呢？</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">migrateStoreAt</span><span class="params">(URL storeURL: URL,</span></span></span><br><span class="line"><span class="function"><span class="params">                             fromModel from:NSManagedObjectModel,</span></span></span><br><span class="line"><span class="function"><span class="params">                             toModel to:NSManagedObjectModel,</span></span></span><br><span class="line"><span class="function"><span class="params">                             mappingModel:NSMappingModel? = <span class="literal">nil</span>)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 1.创建migration manager的实例对象</span></span><br><span class="line">   <span class="keyword">let</span> migrationManager =</span><br><span class="line">     <span class="type">NSMigrationManager</span>(sourceModel: from, destinationModel: to)</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 2.如果在方法中传递mapping model的对象的话，我们可以使用它，否则我们就创建它.</span></span><br><span class="line">   <span class="keyword">var</span> migrationMappingModel: <span class="type">NSMappingModel</span></span><br><span class="line">   <span class="keyword">if</span> <span class="keyword">let</span> mappingModel = mappingModel &#123;</span><br><span class="line">     migrationMappingModel = mappingModel</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     migrationMappingModel = <span class="keyword">try</span>! <span class="type">NSMappingModel</span></span><br><span class="line">       .inferredMappingModel(</span><br><span class="line">         forSourceModel: from, destinationModel: to)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 3</span></span><br><span class="line">   <span class="keyword">let</span> targetURL = storeURL.deletingLastPathComponent()</span><br><span class="line">   <span class="keyword">let</span> destinationName = storeURL.lastPathComponent + <span class="string">"~1"</span></span><br><span class="line">   <span class="keyword">let</span> destinationURL = targetURL</span><br><span class="line">     .appendingPathComponent(destinationName)</span><br><span class="line"></span><br><span class="line">   <span class="built_in">print</span>(<span class="string">"From Model: \(from.entityVersionHashesByName)"</span>)</span><br><span class="line">   <span class="built_in">print</span>(<span class="string">"To Model: \(to.entityVersionHashesByName)"</span>)</span><br><span class="line">   <span class="built_in">print</span>(<span class="string">"Migrating store \(storeURL) to \(destinationURL)"</span>)</span><br><span class="line">   <span class="built_in">print</span>(<span class="string">"Mapping model: \(String(describing: mappingModel))"</span>)</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 4</span></span><br><span class="line">   <span class="keyword">let</span> success: <span class="type">Bool</span></span><br><span class="line">   <span class="keyword">do</span> &#123;</span><br><span class="line">     <span class="keyword">try</span> migrationManager.migrateStore(from: storeURL,</span><br><span class="line">                                       sourceType:<span class="type">NSSQLiteStoreType</span>,</span><br><span class="line">                                       options:<span class="literal">nil</span>,</span><br><span class="line">                                       with:migrationMappingModel,</span><br><span class="line">                                       toDestinationURL:destinationURL,</span><br><span class="line">                                       destinationType:<span class="type">NSSQLiteStoreType</span>,</span><br><span class="line">                                       destinationOptions:<span class="literal">nil</span>)</span><br><span class="line">     success = <span class="literal">true</span></span><br><span class="line">   &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">     success = <span class="literal">false</span></span><br><span class="line">     <span class="built_in">print</span>(<span class="string">"Migration failed: \(error)"</span>)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 5</span></span><br><span class="line">   <span class="keyword">if</span> success &#123;</span><br><span class="line">     <span class="built_in">print</span>(<span class="string">"Migration Completed Successfully"</span>)</span><br><span class="line"></span><br><span class="line">     <span class="keyword">let</span> fileManager = <span class="type">FileManager</span>.<span class="keyword">default</span></span><br><span class="line">     <span class="keyword">do</span> &#123;</span><br><span class="line">       <span class="keyword">try</span> fileManager.removeItem(at: storeURL)</span><br><span class="line">       <span class="keyword">try</span> fileManager.moveItem(at: destinationURL,</span><br><span class="line">                                to: storeURL)</span><br><span class="line">     &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">       <span class="built_in">print</span>(<span class="string">"Error migrating \(error)"</span>)</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><ul><li>如何一步步的合并数据，这里调用了一个递归函数，从而时间一步步的合并数据：</li></ul><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">func performMigration() &#123;</span><br><span class="line">    <span class="keyword">if</span> !currentModel.isVersion4 &#123;</span><br><span class="line">      fatalError(<span class="string">"Can only handle migrations to version 4!"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> storeModel = self.storeModel &#123;</span><br><span class="line">      <span class="keyword">if</span> storeModel.isVersion1 &#123;</span><br><span class="line">        <span class="keyword">let</span> destinationModel = NSManagedObjectModel.version2</span><br><span class="line"></span><br><span class="line">        migrateStoreAt(URL: storeURL,</span><br><span class="line">                       fromMode<span class="variable">l:</span> storeModel,</span><br><span class="line">                       toMode<span class="variable">l:</span> destinationModel)</span><br><span class="line"></span><br><span class="line">        performMigration()</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> storeModel.isVersion2 &#123;</span><br><span class="line">        <span class="keyword">let</span> destinationModel = NSManagedObjectModel.version3</span><br><span class="line">        <span class="keyword">let</span> mappingModel = NSMappingModel(from: nil,</span><br><span class="line">                                          forSourceMode<span class="variable">l:</span> storeModel,</span><br><span class="line">                                          destinationMode<span class="variable">l:</span> destinationModel)</span><br><span class="line"></span><br><span class="line">        migrateStoreAt(URL: storeURL,</span><br><span class="line">                       fromMode<span class="variable">l:</span> storeModel,</span><br><span class="line">                       toMode<span class="variable">l:</span> destinationModel,</span><br><span class="line">                       mappingMode<span class="variable">l:</span> mappingModel)</span><br><span class="line"></span><br><span class="line">        performMigration()</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> storeModel.isVersion3 &#123;</span><br><span class="line">        <span class="keyword">let</span> destinationModel = NSManagedObjectModel.version4</span><br><span class="line">        <span class="keyword">let</span> mappingModel = NSMappingModel(from: nil,</span><br><span class="line">                                          forSourceMode<span class="variable">l:</span> storeModel,</span><br><span class="line">                                          destinationMode<span class="variable">l:</span> destinationModel)</span><br><span class="line"></span><br><span class="line">        migrateStoreAt(URL: storeURL,</span><br><span class="line">                       fromMode<span class="variable">l:</span> storeModel,</span><br><span class="line">                       toMode<span class="variable">l:</span> destinationModel,</span><br><span class="line">                       mappingMode<span class="variable">l:</span> mappingModel)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h4 id=&quot;记得在两年前我去面试的时候，面试官关于Core-data的问题，他们大都只会问你一个问题，基本上你只要能够答出来，就说明还是使用过Core-Data，这个问题就是：“如何迁移Core-Data的数据库”？因为谁都无法预料业务的发展，以及数据库的修改，所以这个问题也是必然会发生的。这里重点列举几个Core-Data数据库迁移的问题：&quot;&gt;&lt;a href=&quot;#记得在两年前我去面试的时候，面试官关于Core-data的问题，他们大都只会问你一个问题，基本上你只要能够答出来，就说明还是使用过Core-Data，这个问题就是：“如何迁移Core-Data的数据库”？因为谁都无法预料业务的发展，以及数据库的修改，所以这个问题也是必然会发生的。这里重点列举几个Core-Data数据库迁移的问题：&quot; class=&quot;headerlink&quot; title=&quot;记得在两年前我去面试的时候，面试官关于Core data的问题，他们大都只会问你一个问题，基本上你只要能够答出来，就说明还是使用过Core Data，这个问题就是：“如何迁移Core Data的数据库”？因为谁都无法预料业务的发展，以及数据库的修改，所以这个问题也是必然会发生的。这里重点列举几个Core Data数据库迁移的问题：&quot;&gt;&lt;/a&gt;记得在两年前我去面试的时候，面试官关于Core data的问题，他们大都只会问你一个问题，基本上你只要能够答出来，就说明还是使用过Core Data，这个问题就是：“如何迁移Core Data的数据库”？因为谁都无法预料业务的发展，以及数据库的修改，所以这个问题也是必然会发生的。这里重点列举几个Core Data数据库迁移的问题：&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;首先要说一下，如果你的App，只是缓存一些离线数据的话，就没必要考虑什么数据库迁移了，因为你只需要在新版本中，删除之前的core data数据，新建一个就可以了&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="日志" scheme="http://www.ghcoder.com/categories/%E6%97%A5%E5%BF%97/"/>
    
    
      <category term="Core Data, Swift" scheme="http://www.ghcoder.com/tags/Core-Data-Swift/"/>
    
  </entry>
  
  <entry>
    <title>学习NSFetchedResultsController, 获取数据部分(五)</title>
    <link href="http://www.ghcoder.com/2017/08/21/20170821/"/>
    <id>http://www.ghcoder.com/2017/08/21/20170821/</id>
    <published>2017-08-21T03:39:12.000Z</published>
    <updated>2017-08-21T11:08:26.000Z</updated>
    
    <content type="html"><![CDATA[<h4 id="上一周一直在忙着写项目，书虽然看完了，但是还是想写写笔记，加深一下记忆，在第四章的时候，其实通过NSFetchReques一些值的修改，其实我们已经可以开始正常的使用core-data-并且可以按照我们的意愿来过滤数据，并且进行排序。这一章重点讲的是NSFetchedResultsController。"><a href="#上一周一直在忙着写项目，书虽然看完了，但是还是想写写笔记，加深一下记忆，在第四章的时候，其实通过NSFetchReques一些值的修改，其实我们已经可以开始正常的使用core-data-并且可以按照我们的意愿来过滤数据，并且进行排序。这一章重点讲的是NSFetchedResultsController。" class="headerlink" title="上一周一直在忙着写项目，书虽然看完了，但是还是想写写笔记，加深一下记忆，在第四章的时候，其实通过NSFetchReques一些值的修改，其实我们已经可以开始正常的使用core data, 并且可以按照我们的意愿来过滤数据，并且进行排序。这一章重点讲的是NSFetchedResultsController。"></a>上一周一直在忙着写项目，书虽然看完了，但是还是想写写笔记，加深一下记忆，在第四章的时候，其实通过NSFetchReques一些值的修改，其实我们已经可以开始正常的使用core data, 并且可以按照我们的意愿来过滤数据，并且进行排序。这一章重点讲的是<strong>NSFetchedResultsController</strong>。</h4><a id="more"></a><ul><li>什么是NSFetchedResultsController? 干什么用的？</li><li>其实操作Core Data,我们做的最多的操作其实就是，从Core Data中获取数据，然后放入到Array中，然后设置DataSource，然后刷新TableView, Apple就是为了解决这种麻烦，所以才产生了<code>NSFetchedResultsController</code>，但是<code>NSFetchedResultsController</code>不同于其他的<code>ViewController</code>,因为它是没有界面的，他主要的目的是为了异步获取的数据用的。说白了，<code>NSFetchedResultsController</code>其实就是<code>NSFetchRequest Result</code>数据的封装。从继承关系上也可以看出来：</li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">NSFetchedResultsController</span>&lt;<span class="type">ResultType</span>&gt; : <span class="type">NSObject where ResultType : NSFetchRequestResult &#123;&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ViewController</span>: <span class="type">UIViewController &#123;&#125;</span></span></span><br></pre></td></tr></table></figure><ul><li>和<code>NSFetchRequest</code>很用法很类似的：</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="keyword">let</span> fetchRequest: <span class="type">NSFetchRequest</span>&lt;<span class="type">Team</span>&gt; = <span class="type">Team</span>.fetchRequest()</span><br><span class="line"><span class="keyword">let</span> <span class="built_in">sort</span> = <span class="type">NSSortDescriptor</span>(key: #keyPath(<span class="type">Team</span>.teamName),</span><br><span class="line">  ascending: <span class="literal">true</span>)</span><br><span class="line">fetchRequest.sortDescriptors = [<span class="built_in">sort</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line">fetchedResultsController = <span class="type">NSFetchedResultsController</span>(</span><br><span class="line">  fetchRequest: fetchRequest,</span><br><span class="line">  managedObjectContext: coreDataStack.managedContext,</span><br><span class="line">  sectionNameKeyPath: <span class="literal">nil</span>,</span><br><span class="line">  cacheName: <span class="literal">nil</span>)</span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> fetchedResultsController.performFetch()</span><br><span class="line">&#125; <span class="keyword">catch</span> <span class="keyword">let</span> error <span class="keyword">as</span> <span class="type">NSError</span> &#123;</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">"Fetching error: \(error), \(error.userInfo)"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>NSFetchedResultsController主要是为了协调Core Data和TableView,但是仍然需要传递NSFetchRequest, 记住NSFetchRequest是可以高度自定义的，可以传递<code>descriptiors</code>/ <code>predicate</code></li><li><p>实例化NSFetchedResultsController需要四个参数，第二个参数就是<code>NSManagedObjectContext</code>，需要这个<code>managedContext</code>来进行搜索 ,剩下的<code>sectionNameKeyPath</code>,<code>cacheName</code></p></li><li><p><strong>NSFetchedResultsController里面必须至少要有一个sort descriptor</strong>否则会直接crash</p></li></ul><h4 id="如何获取数据"><a href="#如何获取数据" class="headerlink" title="如何获取数据"></a>如何获取数据</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">numberOfSections</span><span class="params">(<span class="keyword">in</span> tableView: UITableView)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">  <span class="keyword">guard</span> <span class="keyword">let</span> sections = fetchedResultsController.sections <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span> &#125;</span><br><span class="line">  <span class="keyword">return</span> sections.<span class="built_in">count</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(<span class="number">_</span> tableView: UITableView,</span></span></span><br><span class="line"><span class="function"><span class="params">               numberOfRowsInSection section: Int)</span></span></span><br><span class="line">-&gt; <span class="type">Int</span> &#123;</span><br><span class="line">  <span class="keyword">guard</span> <span class="keyword">let</span> sectionInfo =</span><br><span class="line">    fetchedResultsController.sections?[section] <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span> &#125;</span><br><span class="line">  <span class="keyword">return</span> sectionInfo.numberOfObjects</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>通过调用<code>sections</code>的属性，返回的数组中，包含的Object中，都遵循了<code>NSFetchedResultsSectionInfo</code>的协议，这个轻量级的协议，能够调用<code>title</code>/<code>number</code></li><li>如果获取相应的对象呢？</li></ul><figure class="highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> team = fetchedResultsController.<span class="keyword">object</span>(at: indexPath)</span><br></pre></td></tr></table></figure><h4 id="如何更改数据"><a href="#如何更改数据" class="headerlink" title="如何更改数据"></a>如何更改数据</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">let team = fetchedResultsController.object(at: indexPath)</span><br><span class="line">  team<span class="selector-class">.wins</span> = team<span class="selector-class">.wins</span> + <span class="number">1</span></span><br><span class="line">  coreDataStack.saveContext()</span><br></pre></td></tr></table></figure><h4 id="如何将数据分组"><a href="#如何将数据分组" class="headerlink" title="如何将数据分组"></a>如何将数据分组</h4><ul><li>可以根据我们之前创建的Entity对象中的字段，任意进行分组，例如我们的Entity中存在一个名为<code>qualifyingZone</code>的String的字段,来进行分组，只需要如下的修改：</li></ul><figure class="highlight leaf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fetchedResultsController = NSFetchedResultsController(</span><br><span class="line">  fetchRequest: fetchRequest,</span><br><span class="line">  managedObjectContext: coreDataStack.managedContext,</span><br><span class="line">  sectionNameKeyPath: <span class="function"><span class="keyword">#</span><span class="title">keyPath</span><span class="params">(<span class="variable">Team</span>.<span class="variable">qualifyingZone</span>)</span></span>,</span><br><span class="line">  cacheName: nil)</span><br></pre></td></tr></table></figure><ul><li>这里我们只是传入了一个#keyPath(),根据之前的知识，这个字段的意思会在编译的时候，去寻找Team下面的qualifyingZone。</li><li>这个字段又是如何分组的呢？首先它是先讲这些最为Key的字段放在一个Section中（数组中），然后在回更加每个不同的字段去生成不同的数据。</li><li><strong>通过#keyPath,可以深入到Core Data中的relationship来查询属性值</strong></li><li>虽然当时<code>sectionNameKeyPath</code>但是发现，数据的排序还是更加首字母的？这是因为我没有设置<code>NSSortDescriptor</code>，修改代码如下：</li></ul><figure class="highlight leaf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">let zoneSort = NSSortDescriptor(</span><br><span class="line">  key: <span class="function"><span class="keyword">#</span><span class="title">keyPath</span><span class="params">(<span class="variable">Team</span>.<span class="variable">qualifyingZone</span>)</span></span>, ascending: true)</span><br><span class="line">let scoreSort = NSSortDescriptor(</span><br><span class="line">  key: <span class="function"><span class="keyword">#</span><span class="title">keyPath</span><span class="params">(<span class="variable">Team</span>.<span class="variable">wins</span>)</span></span>, ascending: false)</span><br><span class="line">let nameSort = NSSortDescriptor(</span><br><span class="line">  key: <span class="function"><span class="keyword">#</span><span class="title">keyPath</span><span class="params">(<span class="variable">Team</span>.<span class="variable">teamName</span>)</span></span>, ascending: true)</span><br><span class="line">fetchRequest.sortDescriptors = [zoneSort, scoreSort, nameSort]</span><br></pre></td></tr></table></figure><ul><li>根据数组的排序，先根据<code>Team.qualifyingZone</code>排序，然后根据<code>Team.wins</code>排序，最后根据<code>Team.teamName</code>来排序。</li></ul><h4 id="缓存数据"><a href="#缓存数据" class="headerlink" title="缓存数据"></a>缓存数据</h4><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fetchedResultsController = NSFetchedResultsController(</span><br><span class="line"><span class="symbol">  fetchRequest:</span> fetchRequest,</span><br><span class="line"><span class="symbol">  managedObjectContext:</span> coreDataStack.managedContext,</span><br><span class="line"><span class="symbol">  sectionNameKeyPath:</span> <span class="meta">#keyPath(Team.qualifyingZone),</span></span><br><span class="line"><span class="symbol">  cacheName:</span> <span class="string">"worldCup"</span>)</span><br></pre></td></tr></table></figure><ul><li>数据分类是很耗性能，避免每次都去分类数据，可以通过缓存，如何通过缓存呢？</li><li>直接添加一个字符串的key，这样就可以将数据缓存到磁盘中去了。</li></ul><h4 id="监听数据变化"><a href="#监听数据变化" class="headerlink" title="监听数据变化"></a>监听数据变化</h4><ul><li>NSFetchedResultsController可以监听数据集的变化，并且通知他的代理，通过实现代理方法，可以做响应的操作。</li><li><strong>这里代理的触发还是需要通过设置NSManagedObjectContext,如果在项目中存在多个Managed Object Context的话，那么代理的方法是不会触发的，除非我们保存数据，并且合并context</strong></li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MARK: - NSFetchedResultsControllerDelegate</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">ViewController</span>: <span class="title">NSFetchedResultsControllerDelegate</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">func</span> <span class="title">controllerWillChangeContent</span><span class="params">(<span class="number">_</span> controller: NSFetchedResultsController&lt;NSFetchRequestResult&gt;)</span></span> &#123;</span><br><span class="line">    tableView.beginUpdates()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">func</span> <span class="title">controller</span><span class="params">(<span class="number">_</span> controller: NSFetchedResultsController&lt;NSFetchRequestResult&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">                  didChange anObject: <span class="keyword">Any</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                  at indexPath: IndexPath?,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">for</span> type: NSFetchedResultsChangeType,</span></span></span><br><span class="line"><span class="function"><span class="params">                  newIndexPath: IndexPath?)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> type &#123;</span><br><span class="line">    <span class="keyword">case</span> .insert:</span><br><span class="line">      tableView.insertRows(at: [newIndexPath!], with: .automatic)</span><br><span class="line">    <span class="keyword">case</span> .delete:</span><br><span class="line">      tableView.deleteRows(at: [indexPath!], with: .automatic)</span><br><span class="line">    <span class="keyword">case</span> .update:</span><br><span class="line">      <span class="keyword">let</span> cell = tableView.cellForRow(at: indexPath!) <span class="keyword">as</span>! <span class="type">TeamCell</span></span><br><span class="line">      configure(cell: cell, <span class="keyword">for</span>: indexPath!)</span><br><span class="line">    <span class="keyword">case</span> .move:</span><br><span class="line">      tableView.deleteRows(at: [indexPath!], with: .automatic)</span><br><span class="line">      tableView.insertRows(at: [newIndexPath!], with: .automatic)</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">func</span> <span class="title">controller</span><span class="params">(<span class="number">_</span> controller: NSFetchedResultsController&lt;NSFetchRequestResult&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">                  didChange sectionInfo: NSFetchedResultsSectionInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">                  atSectionIndex sectionIndex: Int,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">for</span> type: NSFetchedResultsChangeType)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> indexSet = <span class="type">IndexSet</span>(integer: sectionIndex)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> type &#123;</span><br><span class="line">    <span class="keyword">case</span> .insert:</span><br><span class="line">      tableView.insertSections(indexSet, with: .automatic)</span><br><span class="line">    <span class="keyword">case</span> .delete:</span><br><span class="line">      tableView.deleteSections(indexSet, with: .automatic)</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">func</span> <span class="title">controllerDidChangeContent</span><span class="params">(<span class="number">_</span> controller: NSFetchedResultsController&lt;NSFetchRequestResult&gt;)</span></span> &#123;</span><br><span class="line">    tableView.endUpdates()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="添加Entity"><a href="#添加Entity" class="headerlink" title="添加Entity"></a>添加Entity</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">let team = Team(</span><br><span class="line">    context: self<span class="selector-class">.coreDataStack</span><span class="selector-class">.managedContext</span>)</span><br><span class="line">  team<span class="selector-class">.teamName</span> = nameTextField.text</span><br><span class="line">  team<span class="selector-class">.qualifyingZone</span> = zoneTextField.text</span><br><span class="line">  team<span class="selector-class">.imageName</span> = <span class="string">"wenderland-flag"</span></span><br><span class="line">  self<span class="selector-class">.coreDataStack</span><span class="selector-class">.saveContext</span>()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h4 id=&quot;上一周一直在忙着写项目，书虽然看完了，但是还是想写写笔记，加深一下记忆，在第四章的时候，其实通过NSFetchReques一些值的修改，其实我们已经可以开始正常的使用core-data-并且可以按照我们的意愿来过滤数据，并且进行排序。这一章重点讲的是NSFetchedResultsController。&quot;&gt;&lt;a href=&quot;#上一周一直在忙着写项目，书虽然看完了，但是还是想写写笔记，加深一下记忆，在第四章的时候，其实通过NSFetchReques一些值的修改，其实我们已经可以开始正常的使用core-data-并且可以按照我们的意愿来过滤数据，并且进行排序。这一章重点讲的是NSFetchedResultsController。&quot; class=&quot;headerlink&quot; title=&quot;上一周一直在忙着写项目，书虽然看完了，但是还是想写写笔记，加深一下记忆，在第四章的时候，其实通过NSFetchReques一些值的修改，其实我们已经可以开始正常的使用core data, 并且可以按照我们的意愿来过滤数据，并且进行排序。这一章重点讲的是NSFetchedResultsController。&quot;&gt;&lt;/a&gt;上一周一直在忙着写项目，书虽然看完了，但是还是想写写笔记，加深一下记忆，在第四章的时候，其实通过NSFetchReques一些值的修改，其实我们已经可以开始正常的使用core data, 并且可以按照我们的意愿来过滤数据，并且进行排序。这一章重点讲的是&lt;strong&gt;NSFetchedResultsController&lt;/strong&gt;。&lt;/h4&gt;
    
    </summary>
    
      <category term="日志" scheme="http://www.ghcoder.com/categories/%E6%97%A5%E5%BF%97/"/>
    
    
      <category term="Core Data, Swift" scheme="http://www.ghcoder.com/tags/Core-Data-Swift/"/>
    
  </entry>
  
  <entry>
    <title>学习CoreData, 获取数据部分(四)</title>
    <link href="http://www.ghcoder.com/2017/08/10/20170810/"/>
    <id>http://www.ghcoder.com/2017/08/10/20170810/</id>
    <published>2017-08-10T01:29:12.000Z</published>
    <updated>2017-08-21T11:08:55.000Z</updated>
    
    <content type="html"><![CDATA[<h4 id="前面三章都是一些很基础的操作以及概念，之前我们取数据，用的最多的也就是使用NSFetchRequest中的NSPredicate-我们通过修改相应的NSPredicate值来获取到我们想要的数据。所有这一章主要讲解的是获取数据的相关操作以及技巧。"><a href="#前面三章都是一些很基础的操作以及概念，之前我们取数据，用的最多的也就是使用NSFetchRequest中的NSPredicate-我们通过修改相应的NSPredicate值来获取到我们想要的数据。所有这一章主要讲解的是获取数据的相关操作以及技巧。" class="headerlink" title="前面三章都是一些很基础的操作以及概念，之前我们取数据，用的最多的也就是使用NSFetchRequest中的NSPredicate,我们通过修改相应的NSPredicate值来获取到我们想要的数据。所有这一章主要讲解的是获取数据的相关操作以及技巧。"></a>前面三章都是一些很基础的操作以及概念，之前我们取数据，用的最多的也就是使用NSFetchRequest中的NSPredicate,我们通过修改相应的NSPredicate值来获取到我们想要的数据。所有这一章主要讲解的是获取数据的相关操作以及技巧。</h4><ul><li>之前用到的操作是：创建一个<code>NSFetchRequest</code>的实例，然后通过<code>NSManagedObjectContext</code>这个对象来直接修改<code>NSFetchRequest</code>就可以实现了。</li><li>仅仅获取<code>NSFetchRequest</code>的方法就有5种:</li></ul><a id="more"></a><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">// <span class="number">1</span>:通过最普通的NSFetchRequest&lt;Venue&gt;()的方法来实例化NSFetchRequest的对象，紧接着必须使用NSEntityDescription来获取相应的Entity对象，然后直接通过set entity的值。</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="attr">fetchRequest1</span> = NSFetchRequest&lt;Venue&gt;()</span><br><span class="line"><span class="keyword">let</span> <span class="attr">entity</span> =</span><br><span class="line">  NSEntityDescription.entity(forEntityName: <span class="string">"Venue"</span>,</span><br><span class="line">                             <span class="keyword">in</span>: managedContext)!</span><br><span class="line">fetchRequest1.<span class="attr">entity</span> = entity</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// <span class="number">2</span>:这里直接通过NSFetchRequest的实例化方法传入entityName值，直接将上面的步骤省略了，避免使用NSEntityDescription的对象。</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="attr">fetchRequest2</span> = NSFetchRequest&lt;Venue&gt;(entityName: <span class="string">"Venue"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// <span class="number">3</span>: 这个又在第二部的上面做出了相应的省略，当你生成NSManagedObject subclass 的对象，同时你这个对象也会生成一个类方法，直接返回NSFetchRequest，通过这样能够直接与相应的Entity产生联系。</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> fetchRequest3: NSFetchRequest&lt;Venue&gt; = Venue.fetchRequest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// <span class="number">4</span>: 在三章里分析managedObjectModel就说过，这里可以直接通过managedObjectModel来获取NSFetchRequest。这里在xCode回有个可视化的操作，就是可以添加Request的操作。</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="attr">fetchRequest4</span> =</span><br><span class="line">  managedObjectModel.fetchRequestTemplate(forName: <span class="string">"venueFR"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// <span class="number">5</span>: 这里第五个方法其实与第四个很相近的，都是通过managedObjectModel来获取NSFetchRequest，不同的是这里多穿了一个substitutionVariables，这个值是用在predicate中的，从而进一步来获取你想要的值。</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="attr">fetchRequest5</span> =</span><br><span class="line">  managedObjectModel.fetchRequestFromTemplate(</span><br><span class="line">    withName: <span class="string">"venueFR"</span>,</span><br><span class="line">    substitutionVariables: [<span class="string">"NAME"</span> : <span class="string">"Vivi Bubble Tea"</span>])</span><br></pre></td></tr></table></figure><ul><li>其实<code>NSFetchRequest</code>是一个很普通的类，但是如果你仔细研究一下<code>NSFetchRequest</code>的实例化，你就会发现<code>&lt;ResultType : NSFetchRequestResult&gt;</code>这个参数，这个参数的作用就是准备具体说明了你想要获取数据的格式:例如之前你获取的是<code>[Venue]</code>而不是<code>[AnyObject]</code>。</li><li>点击<code>xxx.xcdatamodeld</code>,并且长按<code>Add Entity</code>,选择<code>Add Fetch Request</code>，这样就创建了一个<code>NSFetchRequest</code>的对象。但是通过这样创建的<code>NSFetchRequest</code>的<strong>对象是无法修改的。这里需要注意一下</strong>，并且通过修改这里<code>Fetch all</code>选择相应的model，当然这里也可以通过添加另外的<code>predicate</code>的值，来对我们需要的数据进行操作。</li><li>那么如何来获取我们之前在模板中创建的<code>NSFetchRequest</code>对象呢？这里我们用到是通过<code>managedObjectModel</code>来获取相应的<code>Request</code>:</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">guard</span> <span class="keyword">let</span> model =</span><br><span class="line">  coreDataStack.managedContext</span><br><span class="line">    .persistentStoreCoordinator?.managedObjectModel,</span><br><span class="line">  <span class="keyword">let</span> fetchRequest = model</span><br><span class="line">    .fetchRequestTemplate(forName: <span class="string">"FetchRequest"</span>)</span><br><span class="line">    <span class="keyword">as</span>? <span class="type">NSFetchRequest</span>&lt;<span class="type">Venue</span>&gt; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>NSFetchRequest</code>有一个<code>resultType</code>的属性值，之前我们使用的都是它的默认值<code>NSManagedObjectResultType</code>,其实它是一个枚举值，一共可以获取四中不同的类型：</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.managedObjectResultType</span>: 返回的响应的数据(默认的值)</span><br><span class="line"><span class="selector-class">.countResultType</span>: 返回的匹配数据的个数</span><br><span class="line"><span class="selector-class">.dictionaryResultType</span>: 以字典的形式来返回相应的数据，包括count，匹配的数据。</span><br><span class="line"><span class="selector-class">.managedObjectIDResultType</span>: 返回匹配数据的唯一标示符</span><br></pre></td></tr></table></figure><ul><li>这里创建<code>Predicate</code>的方式之前我们也已经看到了,这里的#keyPath, 这个在编译的时候，编译器就会一级级的找相应的属性值，是否存在写错的情况：</li></ul><figure class="highlight leaf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lazy var cheapVenuePredicate: NSPredicate = &#123;</span><br><span class="line">  return NSPredicate(format: "%K == %@",</span><br><span class="line">    <span class="function"><span class="keyword">#</span><span class="title">keyPath</span><span class="params">(<span class="variable">Venue</span>.<span class="variable">priceInfo</span>.<span class="variable">priceCategory</span>)</span></span>, "$")</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure><ul><li>获取count：</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">func</span> <span class="title">populateCheapVenueCountLabel</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> fetchRequest =</span><br><span class="line">      <span class="type">NSFetchRequest</span>&lt;<span class="type">NSNumber</span>&gt;(entityName: <span class="string">"Venue"</span>)</span><br><span class="line">    fetchRequest.resultType = .countResultType</span><br><span class="line">    fetchRequest.predicate = cheapVenuePredicate</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> countResult =</span><br><span class="line">        <span class="keyword">try</span> coreDataStack.managedContext.fetch(fetchRequest)</span><br><span class="line">      <span class="keyword">let</span> <span class="built_in">count</span> = countResult.first!.intValue</span><br><span class="line">      firstPriceCategoryLabel.text =</span><br><span class="line">        <span class="string">"\(count) bubble tea places"</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> <span class="keyword">let</span> error <span class="keyword">as</span> <span class="type">NSError</span> &#123;</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">"Count not fetch \(error), \(error.userInfo)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    -----------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     <span class="keyword">let</span> fetchRequest: <span class="type">NSFetchRequest</span>&lt;<span class="type">Venue</span>&gt; = <span class="type">Venue</span>.fetchRequest()</span><br><span class="line">  fetchRequest.predicate = expensiveVenuePredicate</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="built_in">count</span> =</span><br><span class="line">      <span class="keyword">try</span> coreDataStack.managedContext.<span class="built_in">count</span>(<span class="keyword">for</span>: fetchRequest)</span><br><span class="line">    thirdPriceCategoryLabel.text = <span class="string">"\(count) bubble tea places"</span></span><br><span class="line">  &#125; <span class="keyword">catch</span> <span class="keyword">let</span> error <span class="keyword">as</span> <span class="type">NSError</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Count not fetch \(error), \(error.userInfo)"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>上面所有的操作都是需要把所有的相关数据载入到内存中去，然后再去计算个数，core data 能够快速找到数据的“总和、平均值、最大、最小”：</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">func populateDealsCountLabel() &#123;</span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line">  let fetchRequest =</span><br><span class="line">    NSFetchRequest&lt;NSDictionary&gt;(entityName: <span class="string">"Venue"</span>)</span><br><span class="line">  fetchRequest<span class="selector-class">.resultType</span> = .dictionaryResultType</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2: 这边你为了获取总和生成了一个NSExpressionDescription的对象，并且set了一个name的值，便于自己能够从字典中找到自己想要的那个值：</span></span><br><span class="line">  let sumExpressionDesc = NSExpressionDescription()</span><br><span class="line">  sumExpressionDesc<span class="selector-class">.name</span> = <span class="string">"sumDeals"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3: 首先你生成了一个NSExpression的变量来确定你需要哪个字段来计算总和，其次生成了一个NSExpression来变量来确定你要运行的函数，最后定义了返回数据的类型是int32位：</span></span><br><span class="line">  let specialCountExp =</span><br><span class="line">    NSExpression(forKeyPath: #keyPath(Venue.specialCount))</span><br><span class="line">  sumExpressionDesc<span class="selector-class">.expression</span> =</span><br><span class="line">    NSExpression(forFunction: <span class="string">"sum:"</span>,</span><br><span class="line">                 arguments: [specialCountExp])</span><br><span class="line">  sumExpressionDesc<span class="selector-class">.expressionResultType</span> =</span><br><span class="line">    .integer32AttributeType</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 4：将自己设置的东西都告诉给FetchRequest</span></span><br><span class="line">  fetchRequest<span class="selector-class">.propertiesToFetch</span> = [sumExpressionDesc]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 5:根据上面的定义，我们需要调用的是sum函数，将我们Venue.specialCount所有的字段都加起来，丢在一个字典中，字典的key为sumDeals:</span></span><br><span class="line"></span><br><span class="line">  do &#123;</span><br><span class="line">    let results =</span><br><span class="line">      try coreDataStack<span class="selector-class">.managedContext</span><span class="selector-class">.fetch</span>(fetchRequest)</span><br><span class="line">    let resultDict = results.first!</span><br><span class="line">    let numDeals = resultDict[<span class="string">"sumDeals"</span>]!</span><br><span class="line">    numDealsLabel<span class="selector-class">.text</span> = <span class="string">"\(numDeals) total deals"</span></span><br><span class="line">  &#125; catch let error as NSError &#123;</span><br><span class="line">    print(<span class="string">"Count not fetch \(error), \(error.userInfo)"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>这里除了支持sum，还有其他函数支持吗？<strong>count,min,max,median,mode,absolute</strong></p></li><li><p>这里我们运用的都是些一个单独的NSPredicate，来进行过滤数据，但是我们其实还可以运用多个Predicate来实现类似<code>AND</code>,<code>OR</code>,<code>NOT</code>，可以通过<strong>NSCompoundPredicate</strong>将两个单独<code>NSPredicate</code>组合成一个。</p></li></ul><h4 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h4><ul><li>另一个很牛逼的地方，就是可以对获取的数据进行排序，这里运用的函数是<code>NSSortDescriptor</code>,其实这个函数在我们版本号比较的时候就可以运用，但是Core Data中的排序，它是发生在SQLite层面的，而不是内存层面的。</li></ul><figure class="highlight leaf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">lazy var nameSortDescriptor: NSSortDescriptor = &#123;</span><br><span class="line">  let compareSelector =</span><br><span class="line">    <span class="function"><span class="keyword">#</span><span class="title">selector</span><span class="params">(<span class="variable">NSString</span>.<span class="variable">localizedStandardCompare</span>(<span class="variable">_</span>:)</span></span>)</span><br><span class="line">  return NSSortDescriptor(key: <span class="function"><span class="keyword">#</span><span class="title">keyPath</span><span class="params">(<span class="variable">Venue</span>.<span class="variable">name</span>)</span></span>,</span><br><span class="line">&#125;()</span><br><span class="line">ascending: true,</span><br><span class="line">selector: compareSelector)</span><br><span class="line">lazy var distanceSortDescriptor: NSSortDescriptor = &#123;</span><br><span class="line">  return NSSortDescriptor(</span><br><span class="line">    key: <span class="function"><span class="keyword">#</span><span class="title">keyPath</span><span class="params">(<span class="variable">Venue</span>.<span class="variable">location</span>.<span class="variable">distance</span>)</span></span>,</span><br><span class="line">    ascending: true)</span><br><span class="line">&#125;()</span><br><span class="line">lazy var priceSortDescriptor: NSSortDescriptor = &#123;</span><br><span class="line">  return NSSortDescriptor(</span><br><span class="line">    key: <span class="function"><span class="keyword">#</span><span class="title">keyPath</span><span class="params">(<span class="variable">Venue</span>.<span class="variable">priceInfo</span>.<span class="variable">priceCategory</span>)</span></span>,</span><br><span class="line">    ascending: true)</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure><ul><li>上面需要解释一下的是Venue.name 的排序，需要三个字段：1:属性的字段名。2：升序还是降序，3: 执行比较的函数。<strong>这里需要重点说一下，我之前比较的都是用的compare的函数，但是apple这里建议使用的是NSString.localizedStandardCompare</strong>，因为这个函数对一些特殊的字符也做了相应的操作。</li></ul><h4 id="异步操作："><a href="#异步操作：" class="headerlink" title="异步操作："></a>异步操作：</h4><ul><li>现在我们所有获取数据的操作其实都是在主线程操作的，所以在我们操作大量数据的时候，就会生卡顿，在iOS8的时候，CoreData可以在后台长期高效的运行。</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">var</span> asyncFetchRequest: NSAsynchronousFetchRequest&lt;Venue&gt;!</span><br></pre></td></tr></table></figure><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line">  fetchRequest = <span class="type">Venue</span>.fetchRequest()</span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line">  asyncFetchRequest =</span><br><span class="line">    <span class="type">NSAsynchronousFetchRequest</span>&lt;<span class="type">Venue</span>&gt;(</span><br><span class="line">      fetchRequest: fetchRequest) &#123;</span><br><span class="line">        [<span class="keyword">unowned</span> <span class="keyword">self</span>] (result: <span class="type">NSAsynchronousFetchResult</span>) <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> venues = result.finalResult <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">      <span class="keyword">self</span>.venues = venues</span><br><span class="line">      <span class="keyword">self</span>.tableView.reloadData()</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> coreDataStack.managedContext.execute(asyncFetchRequest)</span><br><span class="line">    <span class="comment">// Returns immediately, cancel here if you want</span></span><br><span class="line">  &#125; <span class="keyword">catch</span> <span class="keyword">let</span> error <span class="keyword">as</span> <span class="type">NSError</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Could not fetch \(error), \(error.userInfo)"</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>这里可以看到<code>NSAsyncchronousFetchRequest</code>并没有取代<code>NSFetchRequest</code>,这里可以把<code>异步操作</code>是<code>普通操作的一个封装</code>。</li><li>并且这里<code>NSManagedObjectContext</code>执行的是<code>execute(_:)</code>而不是<code>fetch(_:)</code></li><li>当然这里你可以可以通过调用<code>cancel()</code>来取消查询。</li></ul><h4 id="批量操作，无需获取数据。"><a href="#批量操作，无需获取数据。" class="headerlink" title="批量操作，无需获取数据。"></a>批量操作，无需获取数据。</h4><ul><li>在iOS8的时候，提供了一个新的接口可以批量操作，并且也不需要将数据载入到内存中去<code>NSBatchUpdateRequest</code>，</li></ul><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 通过传入EntityName 实例化了一个NSBatchUpdateRequest对象</span></span><br><span class="line"><span class="keyword">let</span> batchUpdate = <span class="type">NSBatchUpdateRequest</span>(entityName: <span class="string">"Venue"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 设置了需要修改的字段，以及值</span></span><br><span class="line">batchUpdate.propertiesToUpdate =</span><br><span class="line">  [#keyPath(<span class="type">Venue</span>.favorite) : <span class="literal">true</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 这个批量操作需要影响哪些数据</span></span><br><span class="line">batchUpdate.affectedStores =</span><br><span class="line">  coreDataStack.managedContext</span><br><span class="line">    .persistentStoreCoordinator?.persistentStores</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 设置了返回结果的类型，我们这里定义为返回批量更新的count值</span></span><br><span class="line">batchUpdate.resultType = .updatedObjectsCountResultType</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> batchResult =</span><br><span class="line">    <span class="keyword">try</span> coreDataStack.managedContext.execute(batchUpdate)</span><br><span class="line">      <span class="keyword">as</span>! <span class="type">NSBatchUpdateResult</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">"Records updated \(batchResult.result!)"</span>)</span><br><span class="line">&#125; <span class="keyword">catch</span> <span class="keyword">let</span> error <span class="keyword">as</span> <span class="type">NSError</span> &#123;</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">"Could not update \(error), \(error.userInfo)"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h4 id=&quot;前面三章都是一些很基础的操作以及概念，之前我们取数据，用的最多的也就是使用NSFetchRequest中的NSPredicate-我们通过修改相应的NSPredicate值来获取到我们想要的数据。所有这一章主要讲解的是获取数据的相关操作以及技巧。&quot;&gt;&lt;a href=&quot;#前面三章都是一些很基础的操作以及概念，之前我们取数据，用的最多的也就是使用NSFetchRequest中的NSPredicate-我们通过修改相应的NSPredicate值来获取到我们想要的数据。所有这一章主要讲解的是获取数据的相关操作以及技巧。&quot; class=&quot;headerlink&quot; title=&quot;前面三章都是一些很基础的操作以及概念，之前我们取数据，用的最多的也就是使用NSFetchRequest中的NSPredicate,我们通过修改相应的NSPredicate值来获取到我们想要的数据。所有这一章主要讲解的是获取数据的相关操作以及技巧。&quot;&gt;&lt;/a&gt;前面三章都是一些很基础的操作以及概念，之前我们取数据，用的最多的也就是使用NSFetchRequest中的NSPredicate,我们通过修改相应的NSPredicate值来获取到我们想要的数据。所有这一章主要讲解的是获取数据的相关操作以及技巧。&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;之前用到的操作是：创建一个&lt;code&gt;NSFetchRequest&lt;/code&gt;的实例，然后通过&lt;code&gt;NSManagedObjectContext&lt;/code&gt;这个对象来直接修改&lt;code&gt;NSFetchRequest&lt;/code&gt;就可以实现了。&lt;/li&gt;
&lt;li&gt;仅仅获取&lt;code&gt;NSFetchRequest&lt;/code&gt;的方法就有5种:&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="日志" scheme="http://www.ghcoder.com/categories/%E6%97%A5%E5%BF%97/"/>
    
    
      <category term="Core Data, Swift" scheme="http://www.ghcoder.com/tags/Core-Data-Swift/"/>
    
  </entry>
  
</feed>
